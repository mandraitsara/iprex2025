<?php/**------------------------------------------------------------------------PAGE - ADMIN - Tableau de bordCopyright (C) 2018 Intersedhttp://www.intersed.fr/------------------------------------------------------------------------@author    Cédric Bouillon@copyright Copyright (c) 2019 Intersed@version   1.0@since     2018------------------------------------------------------------------------ */require_once 'scripts/php/config.php';require_once 'scripts/php/check_admin.php';$h1     = 'Tableau de bord de surveillance';$h1fa   = 'fa-fw fa-tachometer-alt';$js[] = 'vendor/chartjs/Chart.bundle.min.js';include('includes/header.php');$lotsManager        = new LotManager($cnx);$alertesManager     = new AlerteManager($cnx);// Nb de lots terminés$nbLotsTermines         = $lotsManager->getNbLotsTermines();$plurielLotsTermines    = (int)$nbLotsTermines > 1 ? 's' : '';// Top 5 des produits DESC sur les lots terminés$top5pdts = $lotsManager->getTopProduitsLots(5);// Total alertes déclachées par type$alertes = $alertesManager->getTotalAlertesByType();// Proportion abattoirs$graphs_abattoirs = $lotsManager->getProportionAbattoirsLots();?><div class="container-fluid">    <div class="row">        <div class="col-12" id="tableauDeBord">            <div class="row">                <div class="col-4"> <!-- Stats -->                    <p class="badge badge-secondary text-16 mt-3 form-control"><i class="fa fa-flag-checkered mr-1"></i> Statistiques des lots terminés</p>                    <div class="alert alert-secondary t2b-stats">                        <table class="w-100">                            <tr>                                <th class="pb-3">Temps moyen par lot :<span>En heures:minutes, sur <?php echo $nbLotsTermines . ' lot'.$plurielLotsTermines . ' terminé'.$plurielLotsTermines; ?></span></th>                                <td class="pb-3 text-right">                                    <?php                                    $tempsMoyenParLot = $lotsManager->getTempsMoyenParLot();                                    if ($nbLotsTermines < 1 || $tempsMoyenParLot == '0:00') { ?>                                        <span class="badge badge-dark text-18 text-center">Information non disponible</span>                                    <?php } else { ?>                                        <span class="badge badge-info text-28 text-center"><?php echo $tempsMoyenParLot; ?></span>                                    <?php } ?>                                </td>                            </tr>                            <tr>                                <th class="pb-3">Nombre de produits moyen par lot :<span>Sur <?php echo $nbLotsTermines . ' lot'.$plurielLotsTermines . ' terminé'.$plurielLotsTermines; ?></span></th>                                <td class="pb-3 text-right">									<?php									$nbProduitsMoyenParLot = $lotsManager->getNbProduitsMoyenParLot();									if ($nbLotsTermines < 1 || $nbProduitsMoyenParLot == 0) { ?>                                        <span class="badge badge-dark text-18 text-center">Information non disponible</span>									<?php } else { ?>                                        <span class="badge badge-info text-28 text-center"><?php echo $nbProduitsMoyenParLot;?></span>									<?php } ?>                                </td>                            </tr>                            <tr>                                <th>Perte moyenne par lot :<span>Sur <?php echo $nbLotsTermines . ' lot'.$plurielLotsTermines . ' terminé'.$plurielLotsTermines; ?></span></th>                                <td class="text-right">									<?php									$perteMoyenneParLot = $lotsManager->getPerteMoyeneParLot();									if ($nbLotsTermines < 1 || $perteMoyenneParLot == '0.000') { ?>                                        <span class="badge badge-dark text-18 text-center">Information non disponible</span>									<?php } else { ?>                                        <span class="badge badge-warning text-28 text-center"><?php echo $perteMoyenneParLot;?> kg</span>									<?php } ?>                                </td>                            </tr>                        </table>                    </div>                </div> <!-- FIN stats -->				<?php				/*************************				 * Abattoirs				 ************************ */				$labels = '';				$datas = '';				foreach ($graphs_abattoirs as $nomAbattoir => $total) {					$datas.= (int)$total.',';					$labels.= '[';					foreach (explode(' ', $nomAbattoir) as $mot) {						$labels.='"'.$mot.'",';					}					$labels = substr($labels,0,-1);					$labels.= '],';				}				$datas = substr($datas,0,-1);				$labels = substr($labels,0,-1);				?>                <div class="col-4"> <!-- Graph abattoirs -->                    <p class="badge badge-secondary text-16 mt-3 form-control"><i class="fa fa-skull-crossbones mr-1"></i>Répartition des abattoirs</p>                    <canvas id="graphAbattoirs" width="400" height="200" class="graph-t2b"></canvas>                    <script type="text/javascript">                        var ctx = document.getElementById("graphAbattoirs").getContext('2d');                        var graphAbattoirs = new Chart(ctx, {                            type: 'doughnut',                            data: {                                labels: [<?php echo $labels; ?>],                                datasets: [{                                    data: [<?php echo $datas; ?>],                                    backgroundColor: [                                        'rgba(75, 192, 75, 0.2)',                                        'rgba(153, 102, 255, 0.2)',                                        'rgba(255, 159, 64, 0.2)',                                        'rgba(54, 162, 235, 0.2)',                                        'rgba(255, 99, 132, 0.2)'                                    ],                                    borderColor: [                                        'rgba(75, 192, 75, 1)',                                        'rgba(153, 102, 255, 1)',                                        'rgba(255, 159, 64, 1)',                                        'rgba(54, 162, 235, 1)',                                        'rgba(255, 99, 132, 1)'                                    ],                                    borderWidth: 1                                }]                            },                            options: {                                legend: {                                    position: 'left'                                },                                title: {                                    display: false                                }                            }                        });                    </script>                </div> <!-- FIN graph abattoirs -->            </div>                <div class="row justify-content-md-center mt-3"> <!-- SEPARATEUR ROW -->					<?php					/**************************					 * Top traitements					 ************************ */					$traitements = $lotsManager->getVolumetrieFroids();					$labels = '';					$datas = '';					$maxData = 0;					foreach ($traitements as $nom_traitement => $total) {						if ($total > $maxData) { $maxData = $total; }						$datas.= (int)$total.',';						$labels.= '[';						foreach (explode(' ', $nom_traitement) as $mot) {							$labels.='"'.$mot.'",';						}						$labels = substr($labels,0,-1);						$labels.= '],';					}					$datas = substr($datas,0,-1);					$labels = substr($labels,0,-1);					if ($maxData < 10) { $stepSize = 1; }					else if ($maxData < 100) { $stepSize = 10; }					else if ($maxData < 1000) { $stepSize = 100; }					else if ($maxData < 10000) { $stepSize = 1000; }					else  { $stepSize = 5000; }					?>                    <div class="col-4"> <!-- Graph volume traitements -->                        <p class="badge badge-secondary text-16 mt-3 form-control"><i class="fa fa-dolly mr-1"></i> Volumétrie des traitements réalisés</p>                        <canvas id="graphVolTraitements" width="400" height="200" class="graph-t2b"></canvas>                        <script type="text/javascript">                            var ctx = document.getElementById("graphVolTraitements").getContext('2d');                            var graphVolTraitements = new Chart(ctx, {                                type: 'bar',                                data: {                                    labels: [<?php echo $labels; ?>],                                    datasets: [{                                        data: [<?php echo $datas; ?>],                                        backgroundColor: [                                            'rgba(75, 192, 75, 0.2)',                                            'rgba(54, 162, 235, 0.2)',                                            'rgba(153, 102, 255, 0.2)'                                        ],                                        borderColor: [                                            'rgba(75, 192, 75, 1)',                                            'rgba(54, 162, 235, 1)',                                            'rgba(153, 102, 255, 1)'                                        ],                                        borderWidth: 1                                    }]                                },                                options: {                                    legend: {                                        display: false                                    },                                    title: {                                        display: false                                    },                                    scales: {                                        yAxes: [{                                            ticks: {                                                beginAtZero:true,                                                stepSize:<?php echo $stepSize; ?>                                            }                                        }],                                        xAxes: [{                                            ticks: {                                                fontSize: 11                                            }                                        }]                                    }                                }                            });                        </script>                    </div> <!-- FIN graph top 5 produit -->                <?php				/**************************				 * Top 5				 ************************ */                    $labels = '';                    $datas = '';                    $maxData = 0;                    foreach ($top5pdts as $nom_pdt => $total) {                        if ($total > $maxData) { $maxData = $total; }						$datas.= (int)$total.',';						$labels.= '[';						foreach (explode(' ', $nom_pdt) as $mot) {							$labels.='"'.$mot.'",';                        }						$labels = substr($labels,0,-1);						$labels.= '],';                    }					$datas = substr($datas,0,-1);					$labels = substr($labels,0,-1);    				if ($maxData < 10) { $stepSize = 1; }    				else if ($maxData < 100) { $stepSize = 10; }    				else if ($maxData < 1000) { $stepSize = 100; }    				else if ($maxData < 10000) { $stepSize = 1000; }    				else  { $stepSize = 5000; }                    ?>                <div class="col-4"> <!-- Graph top 5 produits -->                    <p class="badge badge-secondary text-16 mt-3 form-control"><i class="fa fa-dolly mr-1"></i> Top 5 des produits en traitement</p>                    <canvas id="graphTop10Pdts" width="400" height="200" class="graph-t2b"></canvas>                    <script type="text/javascript">                        var ctx = document.getElementById("graphTop10Pdts").getContext('2d');                        var graphTop10Pdts = new Chart(ctx, {                            type: 'bar',                            data: {                                labels: [<?php echo $labels; ?>],                                datasets: [{                                    data: [<?php echo $datas; ?>],                                    backgroundColor: [                                        'rgba(75, 192, 75, 0.2)',                                        'rgba(54, 162, 235, 0.2)',                                        'rgba(153, 102, 255, 0.2)',                                        'rgba(255, 159, 64, 0.2)',                                        'rgba(255, 99, 132, 0.2)'                                    ],                                    borderColor: [                                        'rgba(75, 192, 75, 1)',                                        'rgba(54, 162, 235, 1)',                                        'rgba(153, 102, 255, 1)',                                        'rgba(255, 159, 64, 1)',                                        'rgba(255,99,132,1)'                                    ],                                    borderWidth: 1                                }]                            },                            options: {                                legend: {                                    display: false                                },                                title: {                                    display: false                                },                                scales: {                                    yAxes: [{                                        ticks: {                                            beginAtZero:true,                                            stepSize:<?php echo $stepSize; ?>                                        }                                    }],                                    xAxes: [{                                        ticks: {                                            fontSize: 11                                        }                                    }]                                }                            }                        });                    </script>                </div> <!-- FIN graph top 5 produit -->                <?php				/**************************				 * alertes				 ************************ */                    $labels = '';                    $datas = '';				    $maxData = 0;                    foreach ($alertes as $nomAlerte => $total) {						if ($total > $maxData) { $maxData = $total; }                        $datas.= (int)$total.',';                        $labels.= '[';                        foreach (explode(' ', $nomAlerte) as $mot) {                            $labels.='"'.$mot.'",';                        }                        $labels = substr($labels,0,-1);                        $labels.= '],';                    }                    $datas = substr($datas,0,-1);                    $labels = substr($labels,0,-1);				if ($maxData < 10) { $stepSize = 1; }				else if ($maxData < 100) { $stepSize = 10; }				else if ($maxData < 1000) { $stepSize = 100; }				else if ($maxData < 10000) { $stepSize = 1000; }				else  { $stepSize = 5000; }                    ?>                <div class="col-4"> <!-- Graph alertes -->                    <p class="badge badge-secondary text-16 mt-3 form-control"><i class="fa fa-bullhorn mr-1"></i> Volumétrie des alertes déclenchées</p>                    <canvas id="graphAlertes" width="400" height="200" class="graph-t2b"></canvas>                    <script type="text/javascript">                        var ctx = document.getElementById("graphAlertes").getContext('2d');                        var graphAlertes = new Chart(ctx, {                            type: 'bar',                            data: {                                labels: [<?php echo $labels; ?>],                                datasets: [{                                    data: [<?php echo $datas; ?>],                                    backgroundColor: [                                        'rgba(153, 102, 255, 0.2)',                                        'rgba(255, 159, 64, 0.2)',                                        'rgba(255, 99, 132, 0.2)'                                    ],                                    borderColor: [                                        'rgba(153, 102, 255, 1)',                                        'rgba(255, 159, 64, 1)',                                        'rgba(255,99,132,1)'                                    ],                                    borderWidth: 1                                }]                            },                            options: {                                legend: {                                    display: false                                },                                title: {                                    display: false                                },                                scales: {                                    yAxes: [{                                        ticks: {                                            beginAtZero:true,                                            stepSize:<?php echo $stepSize; ?>                                        }                                    }],                                    xAxes: [{                                        ticks: {                                            fontSize: 11                                        }                                    }]                                }                            }                        });                    </script>                </div>            </div> <!-- FIN Graph Alertes -->        </div>    </div></div><?phpinclude('includes/footer.php');