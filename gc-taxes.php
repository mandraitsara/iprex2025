<?php/**------------------------------------------------------------------------PAGE - ADMIN - TaxesCopyright (C) 2020 Intersedhttp://www.intersed.fr/------------------------------------------------------------------------@author    Cédric Bouillon@copyright Copyright (c) 2020 Intersed@version   1.0@since     2018------------------------------------------------------------------------ */require_once 'scripts/php/config.php';// Vérifie une authentification par login/mdp adminrequire_once 'scripts/php/check_admin.php';// On restreint la page aux Administrateursif (!$utilisateur->isAdmin()) {  header('Location: index.php'); }$h1     = "Gestion des taux de TVA";$h1fa   = 'fa-fw fa-university';include('includes/header.php');$taxesManager = new TaxesManager($cnx);$logManager   = new LogManager($cnx);$name_new  = isset($_REQUEST['nom_new'])    ? trim($_REQUEST['nom_new'])             : false;$taux_new  = isset($_REQUEST['taux_new'])   ? floatval($_REQUEST['taux_new'])        : 0;$edit_id   = isset($_REQUEST['e'])          ? intval(base64_decode($_REQUEST['e']))  : 0;$id_upd    = isset($_REQUEST['id_edit'])    ? intval($_REQUEST['id_edit'])           : 0;$id_kill   = isset($_REQUEST['kp'])         ? intval(base64_decode($_REQUEST['kp'])) : 0;// SI on a posté le formulaire : création d'une nouvelle taxeif ($name_new && $name_new != '') {	$actif = isset($_REQUEST['actif']) ? 1 : 0;	$taxe = new Taxe([]);	$taxe->setNom($name_new);	$taxe->setTaux($taux_new);	$taxe->setSupprime(0);	$taxe->setActivation($actif);	$id_new = $taxesManager->saveTaxe($taxe);	if(intval($id_new) > 0) {	    $log = new Log([]);	    $log->setLog_type('info');	    $log->setLog_texte("Création d'une nouvelle taxe ID #".(int)$id_new);	    $logManager->saveLog($log);    }} // FIN test formulaire envoyé// SI on modifieif ($id_upd > 0) {	$taxe = $taxesManager->getTaxe($id_upd);    if ($taxe instanceof Taxe) {		$nom = isset($_REQUEST['nom']) ? trim($_REQUEST['nom']) : '';		$taux  = isset($_REQUEST['taux'])   ? floatval($_REQUEST['taux'])   : 0;		if ($nom == '' || $taux == 0) {			$taxe->setSupprime(1);			if ($taxesManager->saveTaxe($taxe)) {				$log = new Log([]);				$log->setLog_type('warning');				$log->setLog_texte("Suppression d'une taxe  ID #".(int)$id_upd ." (nom mis à vide ou taux à zéro en upd)");				$logManager->saveLog($log);            }		} else {			$taxe->setNom($nom);			$taxe->setTaux($taux);			if ($taxesManager->saveTaxe($taxe)) {				$log = new Log([]);				$log->setLog_type('info');				$log->setLog_texte("Modification de la taxe ID #".(int)$id_upd);				$logManager->saveLog($log);            }		} // FIN test nom / taux    } // FIN test instanciation} // FIN test upd// SI on supprimeif ($id_kill && (int)$id_kill > 0) {	$taxe2kill = $taxesManager->getTaxe($id_kill);	if ($taxe2kill instanceof Taxe) {		$taxe2kill->setSupprime(1);		$taxe2kill->setActivation(0);		if ($taxesManager->saveTaxe($taxe2kill)) {			$log = new Log([]);			$log->setLog_type('warning');			$log->setLog_texte("Suppression (flag) de la taxe ID #".(int)$id_kill);			$logManager->saveLog($log);        }	} // FIN test document instancié} // FIN test suppresion d'un doc demandé$liste = $taxesManager->getListeTaxes();?><div class="container-fluid">    <div class="col-12">        <?php if (empty($liste)) { ?>            <div class="alert alert-danger"><i class="fa fa-exclamation-triangle fa-lg mr-1"></i>Aucune taxe renseignée !</div>        <?php } else { ?>        <table class="admin w-100">            <thead>                <tr>                    <th class="w-mini-admin-cell <?php echo $utilisateur->isDev() ? '' : 'd-none'; ?>">ID</th>                    <th>Libellé</th>                    <th>Taux</th>                    <th class="w-court-admin-cell text-center t-actions">Activation</th>                    <th class="w-court-admin-cell text-center t-actions">Supprimer</th>                </tr>            </thead>            <tbody>                <?php                foreach ($liste as $taxe) { ?>                    <tr>                        <td class="<?php echo $utilisateur->isDev() ? '' : 'd-none'; ?>"><code><?php echo $taxe->getId(); ?></code></td>                        <td>                            <?php                            if ($edit_id == $taxe->getId()) { ?>                                <form action="<?php echo basename($_SERVER['PHP_SELF']); ?>" method="post" class="row">                                    <input type="hidden" name="id_edit" value="<?php echo $taxe->getId(); ?>"/>                                    <div class="col">                                    <input type="text" placeholder="Nouveau libellé" value="<?php echo $taxe->getNom(); ?>" class="form-control w-100" name="nom"/>                                    </div>                            <?php } else { ?> <?php echo $taxe->getNom(); ?>                                <a href="<?php echo basename($_SERVER['PHP_SELF']).'?e='.base64_encode($taxe->getId());?>" class="btn btn-sm gris-9 mr-1"><i class="fa fa-fw fa-edit"></i></a>                            <?php }                            ?>                        </td>                        <td>                            <?php                            if ($edit_id == $taxe->getId()) { ?>                                <div class="col-2">                                    <input type="text" placeholder="00" value="<?php echo $taxe->getTaux(); ?>" class="form-control w-100" name="taux"/> %                                </div>                                <div class="col-1">                                    <button type="submit" class="btn btn-success"><i class="fa fa-save"></i></button>                                </div>                            <?php } else { ?> <?php echo $taxe->getTaux(); ?> %                            <?php }                            ?>                        </td>                        <td class="text-center t-actions">                            <input type="checkbox" class="togglemaster changeActivation" data-toggle="toggle" data-on="Oui" data-off="Non"                                   data-onstyle="success" data-offstyle="danger" data-type-id="<?php echo $taxe->getId(); ?>" <?php                                    echo $taxe->getActivation() == 1 ? 'checked' : ''; ?>/>                        </td>                        <td class="text-center t-actions">                            <a href="<?php echo basename($_SERVER['PHP_SELF']);?>?kp=<?php echo base64_encode($taxe->getId())?>" class="btn btn-sm btn-danger mr-1 btnSupprimer"><i class="fa fa-fw fa-lg fa-trash"></i></a>                        </td>                    </tr>                <?php                } // FIN boucle                ?>            </tbody>        </table>        <?php } // FIN test        ?>        <form action="<?php echo $_SERVER['PHP_SELF']; ?>" method="post" class="alert alert-secondary mt-4 col-12">            <div class="row">                <div class="col-12 gris-7 padding-left-20 mb-1">                    <i class="fa fa-plus-square mr-1 gris-7"></i>Ajouter un taux de TVA&hellip;                </div>            </div>            <div class="row">                <div class="form-group col-3 mb-0">                    <div class="input-group">                        <div class="input-group-prepend">                            <span class="input-group-text"><i class="fa fa-tag"></i></span>                        </div>                        <input type="text" placeholder="Libellé" class="form-control" name="nom_new" value="">                    </div>                </div>                <div class="form-group col-2 mb-0">                    <div class="input-group">                        <div class="input-group-prepend">                            <span class="input-group-text">Taux</span>                        </div>                        <input type="text" placeholder="00" class="form-control" name="taux_new" value="">                        <div class="input-group-append">                            <span class="input-group-text">%</span>                        </div>                    </div>                </div>                 <div class="form-group col-2 mb-0">                    <div class="input-group">                        <input type="checkbox" class="togglemaster" data-toggle="toggle" data-on="Activé" data-off="Désactivé" data-onstyle="success" data-offstyle="danger" name="actif" checked="checked" />                    </div>                </div>                <div class="form-group col mb-0 text-right">                    <button type="submit" class="btn btn-info"><i class="fa fa-check mr-1"></i>Ajouter</button>                </div>            </div>        </form>    </div></div><?phpinclude('includes/footer.php');