<?php/**------------------------------------------------------------------------PAGE - ADMIN - Points de contrôlesCopyright (C) 2020 Intersedhttp://www.intersed.fr/------------------------------------------------------------------------@author    Cédric Bouillon@copyright Copyright (c) 2020 Intersed@version   1.0@since     2018------------------------------------------------------------------------ */require_once 'scripts/php/config.php';// Vérifie une authentification par login/mdp adminrequire_once 'scripts/php/check_admin.php';// On restreint la page aux Administrateursif (!$utilisateur->isAdmin()) {  header('Location: index.php'); }$h1     = "Gestion des points de contrôle";$h1fa   = 'fa-fw fa-clipboard-check';include('includes/header.php');$pointsControlesManager = new PointsControleManager($cnx);$name_new       = isset($_REQUEST['nom_new'])   ? trim($_REQUEST['nom_new'])                : false;$edit_id        = isset($_REQUEST['e'])         ? intval(base64_decode($_REQUEST['e']))     : 0;$id_upd         = isset($_REQUEST['id_edit'])   ? intval($_REQUEST['id_edit'])              : 0;$id_kill        = isset($_REQUEST['kp'])        ? intval(base64_decode($_REQUEST['kp']))    : 0;$filtre_doc     = isset($_REQUEST['doc'])       ? intval($_REQUEST['doc'])                  : 0;$logManager     = new LogManager($cnx);// SI on a posté le formulaire : création d'un nouveauif ($name_new && $name_new != '') {	$actif          = isset($_REQUEST['actif'])         ? 1 : 0;	$id_parent      = isset($_REQUEST['id_parent'])     ? intval($_REQUEST['id_parent']) : 0;	$next_position  = $pointsControlesManager->getNextPosition($id_parent);	$point = new PointControle([]);	$point->setSupprime(0);	$point->setActivation($actif);	$point->setId_parent($id_parent);	$point->setNom($name_new);	$point->setDoc($doc);	$point->setPosition($next_position);	$id_new = $pointsControlesManager->savePointControle($point);	if(intval($id_new) > 0) {	    $log = new Log([]);	    $log->setLog_type('info');	    $log->setLog_texte("Création d'un nouveau point de contrôle pour pVisuAvant : ID #".(int)$id_new);	    $logManager->saveLog($log);    }} // FIN test formulaire envoyé// SI on modifieif ($id_upd > 0) {    $point = $pointsControlesManager->getPointControle($id_upd);    if ($point instanceof PointControle) {		$nom = isset($_REQUEST['nom']) ? trim($_REQUEST['nom']) : '';		$id_parent  = isset($_REQUEST['id_parent'])   ? intval($_REQUEST['id_parent'])   : 0;		if ($nom == '') {			$point->setSupprime(1);			if ($pointsControlesManager->savePointControle($point)) {				$log = new Log([]);				$log->setLog_type('warning');				$log->setLog_texte("Suppression du point de contrôle pVisuAvant ID #".(int)$id_upd ." (nom mis à vide en upd)");				$logManager->saveLog($log);            }		} else {			$point->setNom($nom);			$point->setId_parent($id_parent);			if ($pointsControlesManager->savePointControle($point)) {				$log = new Log([]);				$log->setLog_type('info');				$log->setLog_texte("Modification du point de contrôle pVisuAvant ID #".(int)$id_upd);				$logManager->saveLog($log);            }		} // FIN test nom    } // FIN test instanciation} // FIN test upd// SI on supprimeif ($id_kill && (int)$id_kill > 0) {	$point2kill = $pointsControlesManager->getPointControle($id_kill);	if ($point2kill instanceof PointControle) {		$point2kill->setSupprime(1);		$point2kill->setActivation(0);		if ($pointsControlesManager->savePointControle($point2kill)) {			$log = new Log([]);			$log->setLog_type('warning');			$log->setLog_texte("Suppression du point de contrôle pVisuAvant ID #".(int)$id_kill);			$logManager->saveLog($log);        }	} // FIN test document instancié} // FIN test suppresion d'un doc demandé$points = $pointsControlesManager->getListePointsControles(true, $filtre_doc);?><div class="container-fluid">    <form class="row d-none d-xl-flex" id="filtres">        <div class="col">            <div class="row">                <div class="col-12 col-lg-3">                    <div class="input-group mb-3">                        <div class="input-group-prepend">                            <span class="input-group-text">Document</span>                        </div>                        <select class="selectpicker form-control show-tick" name="filtre_type" title="Document">                            <option value="0" <?php echo $filtre_doc == 0 ? 'selected' : ''; ?>>Contrôle avant production</option>                            <option value="1" <?php echo $filtre_doc == 1 ? 'selected' : ''; ?>>Contrôle pendant la production</option>                            <option value="2" <?php echo $filtre_doc == 2 ? 'selected' : ''; ?>>Contrôle en fin de production</option>                        </select>                    </div>                </div>            </div>        </div>    </form>    <div class="col-12">    <?php if (empty($points)) { ?>        <div class="alert alert-danger"><i class="fa fa-exclamation-triangle fa-lg mr-1"></i>Aucun point de contrôle disponible !</div>    <?php } else { ?>    <table class="admin w-100">        <thead>            <tr>                <th class="w-mini-admin-cell <?php echo $utilisateur->isDev() ? '' : 'd-none'; ?>">ID</th>                <th>Libellé</th>                <th class="w-court-admin-cell text-center t-actions">Activation</th>                <th class="w-court-admin-cell text-center t-actions">Position</th>                <th class="w-court-admin-cell text-center t-actions">Supprimer</th>            </tr>        </thead>        <tbody>            <?php            foreach ($points as $point) { ?>                <tr>                    <td class="<?php echo $utilisateur->isDev() ? '' : 'd-none'; ?>"><code><?php echo $point->getId(); ?></code></td>                    <td class="<?php echo $point->getId_parent() == 0 ? 'text-20' : 'text-14';?>">                        <?php                        if ($edit_id == $point->getId()) { ?>                            <form action="<?php echo basename($_SERVER['PHP_SELF']); ?>" method="post" class="row">                                <input type="hidden" name="id_edit" value="<?php echo $point->getId(); ?>"/>                                <input type="hidden" name="doc" value="<?php echo $filtre_doc; ?>"/>                                <div class="col">                                <input type="text" placeholder="Nouveau libellé" value="<?php echo $point->getNom(); ?>" class="form-control w-100" name="nom"/>                                </div>                                <div class="col-3 <?php echo $filtre_doc > 0 ? 'd-none' : '';?>">                                    <select name="id_parent" class="selectpicker form-control">                                        <option value="0">En-tête</option>										<?php										$parents = $pointsControlesManager->getPointsParents();										if (!empty($parents)) { ?>                                            <option data-divider="true"></option>											<?php											foreach ($parents as $parent) { ?>                                                <option value="<?php echo $parent->getId();?>" <?php                                                echo $parent->getId() == $point->getId_parent() ? 'selected' : '';                                                ?>><?php echo $parent->getNom(); ?></option>											<?php }										} // FIN test parents										?>                                    </select>                                </div>                                <div class="col-1">                                <button type="submit" class="btn btn-success"><i class="fa fa-save"></i></button>                                </div>                            </form>						<?php } else { ?> <i class="fa fa-level-up-alt fa-rotate-90 gris-9 mr-2 ml-2 <?php echo $point->getId_parent() == 0 ? 'd-none' : ''; ?>"></i> <?php echo $point->getNom(); ?>                            <a href="<?php echo basename($_SERVER['PHP_SELF']).'?doc='.$filtre_doc.'&e='.base64_encode($point->getId());?>" class="btn btn-sm gris-9 mr-1"><i class="fa fa-fw fa-edit"></i></a>						<?php }                        ?>                    </td>                    <td class="text-center t-actions">                        <input type="checkbox" class="togglemaster changeActivation" data-toggle="toggle" data-on="Oui" data-off="Non"                               data-onstyle="success" data-offstyle="danger" data-type-id="<?php echo $point->getId(); ?>" <?php                                echo $point->getActivation() == 1 ? 'checked' : ''; ?>/>                    </td>                    <td class="text-center t-actions">                       <i class="fa fa-angle-up fa-fw pointeur position-up mr-2"></i>                       <i class="fa fa-angle-down fa-fw pointeur position-down"></i>                    </td>                    <td class="text-center t-actions">                        <a href="<?php echo basename($_SERVER['PHP_SELF']);?>?doc=<?php echo $filtre_doc;?>&kp=<?php echo base64_encode($point->getId())?>" class="btn btn-sm btn-danger mr-1 btnSupprimer"><i class="fa fa-fw fa-lg fa-trash"></i></a>                    </td>                </tr>            <?php            } // FIN boucle            ?>        </tbody>    </table>    <?php } // FIN test    ?>        <form action="<?php echo $_SERVER['PHP_SELF']; ?>" method="post" class="alert alert-secondary mt-4 col-12">            <div class="row">                <div class="col-12 gris-7 padding-left-20 mb-1">                    <i class="fa fa-plus-square mr-1 gris-7"></i>Ajouter un point de contrôle&hellip;                </div>            </div>            <div class="row">                <div class="form-group col-4 mb-0">                    <div class="input-group">                        <div class="input-group-prepend">                            <span class="input-group-text"><i class="fa fa-tag"></i></span>                        </div>                        <input type="text" placeholder="Libellé" class="form-control" name="nom_new" value="">                    </div>                </div>                <div class="form-group col-2 mb-0">                    <div class="input-group">                        <div class="input-group-prepend">                            <span class="input-group-text"><i class="fa fa-sitemap"></i></span>                        </div>                        <select name="id_parent" class="selectpicker form-control">                            <option value="0" selected>En-tête</option>                            <?php                            $parents = $pointsControlesManager->getPointsParents();                            if (!empty($parents)) { ?>                                <option data-divider="true"></option>                            <?php                                foreach ($parents as $parent) { ?>                                    <option value="<?php echo $parent->getId();?>"><?php echo $parent->getNom(); ?></option>                                <?php }                            } // FIN test parents                            ?>                        </select>                    </div>                </div>                <div class="form-group col-2 mb-0">                    <div class="input-group">                        <div class="input-group-prepend">                            <span class="input-group-text"><i class="fa fa-file"></i></span>                        </div>                        <select name="doc" class="selectpicker form-control">                            <option value="0" selected>Avant la production</option>                            <option value="1">Pendant la production</option>                            <option value="2">Fin de production</option>                        </select>                    </div>                </div>                 <div class="form-group col-2 mb-0">                    <div class="input-group">                        <input type="checkbox" class="togglemaster" data-toggle="toggle" data-on="Activé" data-off="Désactivé" data-onstyle="success" data-offstyle="danger" name="actif" checked="checked" />                    </div>                </div>                <div class="form-group col mb-0 text-right">                    <button type="submit" class="btn btn-info"><i class="fa fa-check mr-1"></i>Ajouter</button>                </div>            </div>        </form>    </div></div><?phpinclude('includes/footer.php');