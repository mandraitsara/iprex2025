<?php/**------------------------------------------------------------------------PAGE - DEV - Logs SqlCopyright (C) 2022 Koesiohttp://www.koesio.com/------------------------------------------------------------------------@author    Cédric Bouillon@copyright Copyright (c) 2022 Koesio@version   1.0@since     2022------------------------------------------------------------------------ */require_once 'scripts/php/config.php';// Vérifie une authentification par login/mdp adminrequire_once 'scripts/php/check_admin.php';// On restreint la page aux Administrateurs Devéloppeursif (!$utilisateur->isDev()) {  header('Location: index.php'); }$h1     = 'Journal des logs SQL';$h1fa   = 'fa-fw fa-database';include('includes/header.php');// Récup des logs$userManager = new UserManager($cnx);?><div class="container-fluid">    <div class="row">        <div class="col">            <form action="<?php echo $_SERVER['PHP_SELF']; ?>" method="post" id="filtres">                <div class="row">                    <div class="col-2">                        <div class="input-group mb-3">                            <div class="input-group-prepend">                                <span class="input-group-text text-14">Mois</span>                            </div>                            <select class="form-control selectpicker" name="mois" title="-">								<?php								for ($i = 1; $i <= 12; $i++) { ?>                                    <option value="<?php echo $i < 9 ? '0'.$i : $i;  ?>" <?php									echo $i == intval(date('m')) ? 'selected' : '';									?>><?php echo ucfirst(Outils::getMoisIntListe()[$i]); ?></option>								<?php }								?>                            </select>                        </div>                    </div>                    <div class="col-2">                        <div class="input-group mb-3">                            <div class="input-group-prepend">                                <span class="input-group-text text-14">Année</span>                            </div>                            <select class="form-control selectpicker" name="annee" title="-">								<?php								$a = intval(date('Y'));								for ($i = $a; $i > $a-3; $i--) { ?>                                    <option value="<?php echo $i; ?>" <?php									echo $i == intval(date('Y')) ? 'selected' : '';									?>><?php echo $i; ?></option>								<?php }								?>                            </select>                        </div>                    </div>                    <div class="col-2">                        <button class="btn btn-secondary btnSearch"><i class="fa fa-search mr-1"></i> Afficher</button>                    </div>                </div>            </form>        </div>    </div>    <div class="row">        <div class="col">            <table class="table admin table-blfact">                <thead>                <tr>                    <th class="w-200px" >Date</th>                    <th class="w-200px">Fichier / Consulter</th>                    <th>Chemin</th>                    <th class="text-right w-150px">Taille</th>                    <th class="text-center w-100px">Télécharger</th>                </tr>                </thead>                <tbody>				<?php				$annee = isset($_REQUEST['annee']) ? $_REQUEST['annee'] : date('Y');				$mois  = isset($_REQUEST['mois'])  ? $_REQUEST['mois']  : date('m');				$cheminLogs = __CBO_ROOT_PATH__.'/logsql/'.$annee.'_'.$mois.'/';				$a = [];				explorer($cheminLogs);				krsort($a);				foreach($a as $f) {					echo '<tr><td class="vmiddle texte-fin text-13">'.$f['mtime'].'</td><td class="vmiddle"><i class="mr-1 fa fa-file-medical-alt text-primary"></i><span class="detailLogSql pointeur" data-path="'.$f['chemin'].'">'.$f['fichier'].'</span></td><td class="vmiddle texte-fin text-13">'.$f['chemin'].'</td><td class="vmiddle text-right texte-fin text-13">'.Outils::getNiceFileSize($f['size']).'</td><td class="text-center"><a href="'.$f['lien'].'" class="btn btn-primary btn-sm" download><i class="fa fa-download"></i></a></td></tr>';				}				?>                </tbody>            </table>			<?php			function explorer($chemin){				global $a;				$fichier = str_replace([substr($chemin, 0, strrpos( $chemin, '/')), '/'], '', $chemin);				$lstat    = lstat($chemin);				$mtime    = date('d/m/Y H:i:s', $lstat['mtime']);				// Affichage des infos sur le fichier $chemin				if ($fichier != '') {					$lien = str_replace(__CBO_ROOT_PATH__, __CBO_ROOT_URL__, $chemin);					$tmp = [];					$tmp['mtime']   = $mtime;					$tmp['chemin']  = $chemin;					$tmp['fichier'] = $fichier;					$tmp['size']    = $lstat['size'];					$tmp['lien']    = $lien;					$a[$fichier]    =  $tmp;				}				// Si $chemin est un dossier => on appelle la fonction explorer() pour chaque élément (fichier ou dossier) du dossier$chemin				if( is_dir($chemin) ){					$me = opendir($chemin);					while( $child = readdir($me) ){						if( $child != '.' && $child != '..' ){							explorer( $chemin.DIRECTORY_SEPARATOR.$child );						}					}				}			}        ?>    </div></div><?phpinclude('includes/modales/modal_info.php');include('includes/footer.php');