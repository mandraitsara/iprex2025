<?php/**------------------------------------------------------------------------PAGE - ContactCopyright (C) 2019 Intersedhttp://www.intersed.fr/------------------------------------------------------------------------@author    Cédric Bouillon@copyright Copyright (c) 2019 Intersed@version   1.0@since     2019------------------------------------------------------------------------ */require_once 'scripts/php/config.php';require_once 'scripts/php/check_admin.php';$h1     = 'Assistance technique';$h1fa   = 'fa-fw fa-comments';$css[]  = 'css/rougetemp.css';include('includes/header.php');$sujets = [        1 => "Une demande lié à l'utilisation de l'application",        2 => "Une demande de nouvelle(s) fonctionalité(s)",        3 => "Un problème technique sur l'application",        7 => "Un problème avec iPrex Photo App",        4 => "Un problème technique avec le matériel",        5 => "Un problème lié au réseau ou aux performances",        6 => "Autre demande d'information"    ];$destinataires_sujet = [        0 => "support-info-lyon.aura@koesio.com",        1 => "support-info-lyon.aura@koesio.com",        2 => "support-info-lyon.aura@koesio.com",        3 => "support-info-lyon.aura@koesio.com",        4 => "support-info-lyon.aura@koesio.com",        5 => "support-info-lyon.aura@koesio.com",        6 => "support-info-lyon.aura@koesio.com",        7 => "support-info-lyon.aura@koesio.com"];// Si soumission du formulaireif (isset($_REQUEST['message'])) {    $sujet_id   = isset($_REQUEST['sujet']) ? intval($_REQUEST['sujet']) : 0;    $message    = nl2br(strip_tags($_REQUEST['message']));    // On formate le sujet (sans le 1er mot)	$sujet_brut = array_key_exists($sujet_id, $sujets)        ? $sujets[$sujet_id]        : $sujet = $sujets[count($sujets)];	$sujet = ucfirst(substr(strstr($sujet_brut," "), 1));	// On récupère le mail de l'expéditeur en session et son nom    $nom  = $utilisateur->getNomComplet();    $from = $utilisateur->getEmail() != '' && Outils::verifMail($utilisateur->getEmail()) ? $utilisateur->getEmail() : $conf_email;	$destinataires = [];	if ($modeMaintenance) {		$destinataires[] = isset($conf_email) ? $conf_email : 'pole-web@intersed.fr';	} else {		$destinataires[] = $destinataires_sujet[$sujet_id];    }	$entete = "Message envoyé via l'intranet PROFIL EXPORT";	$message_format = Outils::formatContenuMail($message, $entete, false);	$message_format.= '<p><em>'.$nom.'</em></p>';	$resultat = Outils::envoiMail($destinataires, $from, utf8_decode($sujet), utf8_decode($message_format));	// Log	$logManager = new LogManager($cnx);	$log = new Log([]);	$log->setLog_user_id($utilisateur->getId());	if ($resultat) {		$log->setLog_type('info');		$log->setLog_texte("Envoi d'un e-mail à Intersed via le formulaire d'assistance technique");		// On enregistre le mail en BDD...        $logMail = new LogMail([]);		$logMail->setExpediteur($from);		$logMail->setDestinataires(implode(';', $destinataires));		$logMail->setSujet($sujet);		$logMail->setMessage($message);		$logMail->setType(1);		$logMail->setDate_envoi(date('Y-m-d H:i:s'));		$logMailManager = new LogMailManager($cnx);		if (!$logMailManager->saveLogMail($logMail)) {			$logErr = new Log([]);			$logErr->setLog_user_id($utilisateur->getId());			$logErr->setLog_type('danger');			$logErr->setLog_texte("ERREUR lors de l'enregistrement en BDD du log de Mail");        }	} else {		$log->setLog_type('danger');		$log->setLog_texte("ECHEC d'envoi d'un e-mail à Intersed via le formulaire d'assistance technique");	} // FIN test mise à jour réussie	$logManager->saveLog($log);	if (isset($logErr)) {		$logManager->saveLog($logErr);    }} // FIN test formulaire envoyé?><div class="container-fluid">	<?php if (isset($resultat)) { ?>        <div class="alert alert-<?php echo $resultat ? 'success' : 'danger'; ?> alert-dismissible fade show" role="alert">            <i class="fa fa-<?php echo $resultat ? 'check' : 'frown'; ?> fa-2x vmiddle float-left mr-4"></i>            <h4><?php echo $resultat ? "Votre message a bien été envoyé à nos équipes." : "Une erreur est survenue durant l'envoi de votre message&hellip;"; ?></h4>            <button type="button" class="close" data-dismiss="alert" aria-label="Close">                <span aria-hidden="true">&times;</span>            </button>        </div>	<?php } ?>    <div class="row justify-content-md-center padding-top-25">        <div class="col-12 col-lg-9 col-xl-8" id="contact">            <div class="row">                <div class="col-12 col-lg-5">                    <a href="https://www.intersed.fr" target="_blank"><img src="<?php echo __CBO_IMG_URL__; ?>koesio.png" style="max-width: 150px;"/></a>                    <div class="row">                        <div class="col-12">                            <a href="tel:0472522221" class="btn btn-lg btn-dark text-28 form-control text-left"><i class="fa fa-fw fa-phone fa-flip-horizontal mr-4"></i>04 72 52 22 21</a>                        </div>                    </div>                    <div class="row mt-2">                        <div class="col-12">                            <a href="mailto:support-info-lyon.aura@koesio.com" class="btn btn-lg btn-dark text-28 form-control text-left"><i class="fa fa-fw fa-keyboard mr-4 vmiddle"></i>support-info-lyon.aura@koesio.com</a>                        </div>                    </div>                </div>                <form class="col-12 col-lg-7" id="contactForm" action="<?php echo $_SERVER['PHP_SELF']; ?>" method="post">                    <div class="alert alert-secondary">                    <div class="input-group mb-3">                        <div class="input-group-prepend">                            <span class="input-group-text"><i class="fa fa-question-circle"></i></span>                        </div>                        <select class="selectpicker form-control" title="Votre demande concerne..." name="sujet">                            <?php foreach ($sujets as $v => $txt) { ?>                                <option value="<?php echo $v; ?>"><?php echo $txt; ?></option>                            <?php } // FIN boucle sur les sujets ?>                        </select>                    </div>                    <div class="input-group mb-3">                        <textarea class="form-control" style="height: 300px;resize: none;" placeholder="Encrivez votre demande ici..." name="message"></textarea>                    </div>                    <div class="text-right">                        <button type="submit" class="btn btn-dark"><i class="fa fa-paper-plane mr-2 fa-envoi"></i> Envoyer</button>                    </div>                    </div>                </form>            </div>        </div>    </div></div><?phpinclude('includes/footer.php');