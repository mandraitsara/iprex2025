<?php/**------------------------------------------------------------------------PAGE - ADMIN - AlertesCopyright (C) 2018 Intersedhttp://www.intersed.fr/------------------------------------------------------------------------@author    Cédric Bouillon@copyright Copyright (c) 2018 Intersed@version   1.0@since     2018------------------------------------------------------------------------ */require_once 'scripts/php/config.php';require_once 'scripts/php/check_admin.php';$h1     = 'Gestion des alertes';$h1fa   = 'fa-fw fa-bullhorn';$alerteManager = new AlerteManager($cnx);// On récupère la config pour l'activation des alertes$alerte1_actif = $configManager->getConfig('alerte1_actif');$alerte2_actif = $configManager->getConfig('alerte2_actif');$alerte3_actif = $configManager->getConfig('alerte3_actif');$alerte4_actif = $configManager->getConfig('alerte4_actif');// Création de la config pour l'alerte 1 si inexistanteif (!$alerte1_actif instanceof Config) {	$alerte1_actif = new Config([]);	$alerte1_actif->setClef('alerte1_actif');	$alerte1_actif->setDescription("Activation de l'alerte de réception d'un lot non conforme.");	$alerte1_actif->setValeur(0);	$alerte1_actif->setDate_maj(date('Y-m-d H:i:s'));	$configManager->saveConfig($alerte1_actif);} // FIN création alerte 1// Création de la config pour l'alerte 2 si inexistanteif (!$alerte2_actif instanceof Config) {	$alerte2_actif = new Config([]);	$alerte2_actif->setClef('alerte2_actif');	$alerte2_actif->setDescription("Activation de l'alerte de saisie d'une température non conforme.");	$alerte2_actif->setValeur(0);	$alerte2_actif->setDate_maj(date('Y-m-d H:i:s'));	$configManager->saveConfig($alerte2_actif);} // FIN création alerte 2// Création de la config pour l'alerte 3 si inexistanteif (!$alerte3_actif instanceof Config) {	$alerte3_actif = new Config([]);	$alerte3_actif->setClef('alerte3_actif');	$alerte3_actif->setDescription("AActivation de l'alerte du nombre d'heures maximum dépassé en surgélation automatique.");	$alerte3_actif->setValeur(0);	$alerte3_actif->setDate_maj(date('Y-m-d H:i:s'));	$configManager->saveConfig($alerte3_actif);} // FIN création alerte 3// Création de la config pour l'alerte 3 si inexistanteif (!$alerte4_actif instanceof Config) {	$alerte4_actif = new Config([]);	$alerte4_actif->setClef('alerte4_actif');	$alerte4_actif->setDescription("Activation de l'alerte du contrôle Loma.");	$alerte4_actif->setValeur(0);	$alerte4_actif->setDate_maj(date('Y-m-d H:i:s'));	$configManager->saveConfig($alerte4_actif);} // FIN création alerte 3// HEADERinclude('includes/header.php');$nbAlertes1 = $alerteManager->getNbAlertesByType(1);$nbAlertes2 = $alerteManager->getNbAlertesByType(2);$nbAlertes3 = $alerteManager->getNbAlertesByType(3);$nbAlertes4 = $alerteManager->getNbAlertesByType(4);// Filtres / pagination$filtre_type    = isset($_REQUEST['filtre_type'])   ? intval($_REQUEST['filtre_type'])  : 0;$filtre_debut   = isset($_REQUEST['filtre_debut'])  ? Outils::dateFrToSql(trim($_REQUEST['filtre_debut']))  : '';$filtre_fin     = isset($_REQUEST['filtre_fin'])    ? Outils::dateFrToSql(trim($_REQUEST['filtre_fin']))    : '';$page  = isset($_REQUEST['page']) ? intval($_REQUEST['page']) : 1;$nbResultPpage = 20;$pagination = new Pagination($page);$pagination->setNb_results_page($nbResultPpage);$pagination->setNb_avant(2);$pagination->setNb_apres(2);$params = [    'nb_result' => $nbResultPpage,    'start'     => ($page-1) * $nbResultPpage];if ($filtre_type    >  0)   { $params['type']   = $filtre_type;  }if ($filtre_debut  != '')   { $params['debut']  = $filtre_debut; }if ($filtre_fin    != '')   { $params['fin']    = $filtre_fin;   }$filtresPagination = '';$filtres = $filtre_type > 0 ? '?filtre_type='.$filtre_type : '';$filtres.= isset($_REQUEST['filtre_debut'])		? ($filtres != '' ? '&' : '?').'filtre_debut=' .$_REQUEST['filtre_debut'] : '';$filtres.= isset($_REQUEST['filtre_fin'])		? ($filtres != '' ? '&' : '?').'filtre_fin=' .$_REQUEST['filtre_fin']     : '';$pagination->setUrl($filtresPagination);$listeAlertes = $alerteManager->getListe($params);$pagination->setNb_results(!empty($listeAlertes) ? $alerteManager->getNb_results() : 0);?><div class="container-fluid page-alertes">    <div class="row">        <div class="col-12 col-lg-4"> <!-- Bloc gauche -->            <!-- Début bloc alerte -->            <div class="alert alert-secondary">                <h4 class="pb-1">                    <span class="fa-stack fa-sm gris-7">                      <i class="fas fa-play fa-rotate-270 fa-stack-2x text-36"></i>                      <i class="fas fa-truck fa-flip-horizontal fa-stack-1x fa-inverse text-14" style="margin-left: -1px;"></i>                    </span>                    Réception non conforme                    <button type="button"  class="compteur-alertes btn btn-lg btn-danger active float-right c-default"><?php echo $nbAlertes1; ?></button>                    <p class="gris-5 text-14 mb-0 pl-1">Réception d'un lot non conforme.</p>                </h4>                <form class="row">                    <div class="col">                        <input type="checkbox" class="togglemaster activation-alerte" data-toggle="toggle" name="activation"							<?php echo (int)$alerte1_actif->getValeur() == 1 ? 'checked' : ''; ?>                               data-on="Alerte activée"                               data-off="Alerte désactivée"                               data-onstyle="success"                               data-offstyle="danger"                               data-typealerte="1"                        />                    </div>                </form>            </div> <!-- Fin bloc alerte -->            <!-- Début bloc alerte -->            <div class="alert alert-secondary">                <h4 class="pb-1">                    <span class="fa-stack fa-sm gris-7">                      <i class="fas fa-play fa-rotate-270 fa-stack-2x text-36"></i>                      <i class="fas fa-thermometer-half fa-stack-1x fa-inverse text-20" style="margin-top: -2px;margin-left: 1px;"></i>                    </span>                    Température non conforme                    <button type="button"  class="compteur-alertes btn btn-lg btn-danger active float-right c-default"><?php echo $nbAlertes2; ?></button>                    <p class="gris-5 text-14 mb-0 pl-1">Saisie d'une température non conforme.</p>                </h4>                <form class="row">                    <div class="col">                        <input type="checkbox" class="togglemaster activation-alerte" data-toggle="toggle" name="activation"							<?php echo (int)$alerte2_actif->getValeur() == 1 ? 'checked' : ''; ?>                               data-on="Alerte activée"                               data-off="Alerte désactivée"                               data-onstyle="success"                               data-offstyle="danger"                               data-typealerte="2"                        />                    </div>                </form>            </div> <!-- Fin bloc alerte -->            <!-- Début bloc alerte -->            <div class="alert alert-secondary">                <h4 class="pb-1">                    <span class="fa-stack fa-sm gris-7">                      <i class="fas fa-play fa-rotate-270 fa-stack-2x text-36"></i>                      <i class="fas fa-stopwatch fa-stack-1x fa-inverse text-18" style="margin-top: -1px;"></i>                    </span>                    Temps de surgélation                    <button type="button"  class="compteur-alertes btn btn-lg btn-danger active float-right c-default"><?php echo $nbAlertes3; ?></button>                    <p class="gris-5 text-14 mb-0 pl-1">Dépassement du nombre d'heures maximum en surgélation automatique.</p>                </h4>                <form class="row">                    <div class="col">                        <input type="checkbox" class="togglemaster activation-alerte" data-toggle="toggle" name="activation"							<?php echo (int)$alerte3_actif->getValeur() == 1 ? 'checked' : ''; ?>                               data-on="Alerte activée"                               data-off="Alerte désactivée"                               data-onstyle="success"                               data-offstyle="danger"                               data-typealerte="3"                        />                    </div>                </form>            </div> <!-- Fin bloc alerte -->            <!-- Début bloc alerte -->            <div class="alert alert-secondary">                <h4 class="pb-1">                    <span class="fa-stack fa-sm gris-7">                      <i class="fas fa-play fa-rotate-270 fa-stack-2x text-36"></i>                      <i class="fas fa-magnet fa-rotate-90 fa-stack-1x fa-inverse text-16" style="margin-top: 1px;"></i>                    </span>                    Contrôle Loma                    <button type="button"  class="compteur-alertes btn btn-lg btn-danger active float-right c-default"><?php echo $nbAlertes4; ?></button>                    <p class="gris-5 text-14 mb-0 pl-1">Test de détéction de corps étrangé non détecté.</p>                </h4>                <form class="row">                    <div class="col">                        <input type="checkbox" class="togglemaster activation-alerte" data-toggle="toggle" name="activation"							<?php echo (int)$alerte4_actif->getValeur() == 1 ? 'checked' : ''; ?>                               data-on="Alerte activée"                               data-off="Alerte désactivée"                               data-onstyle="success"                               data-offstyle="danger"                               data-typealerte="4"                        />                    </div>                </form>            </div> <!-- Fin bloc alerte -->        </div> <!-- FIN bloc gauche -->        <!-- Historique des alertes -->        <div class="col-12 col-lg-8">            <form class="row d-none d-xl-flex" id="filtres" action="<?php echo $_SERVER['PHP_SELF'];?>" method="post">                <div class="col">                    <div class="row">                        <div class="col-12 col-lg-3">                            <div class="input-group mb-3">                                <div class="input-group-prepend">                                    <span class="input-group-text"><i class="fa fa-exclamation-triangle gris-9"></i></span>                                </div>                                <select class="selectpicker form-control show-tick" name="filtre_type" title="Type d'alerte">                                    <option value="0" <?php echo $filtre_type == 0 ? 'selected' : ''; ?>>Toutes les alertes</option>                                    <option data-divider="true"></option>                                    <option value="1" <?php echo $filtre_type == 1 ? 'selected' : ''; ?>>Réception non conforme</option>                                    <option value="2" <?php echo $filtre_type == 2 ? 'selected' : ''; ?>>Température non conforme</option>                                    <option value="3" <?php echo $filtre_type == 3 ? 'selected' : ''; ?>>Temps de surgélation</option>                                    <option value="4" <?php echo $filtre_type == 4 ? 'selected' : ''; ?>>Contrôle Loma</option>                                </select>                            </div>                        </div>                        <div class="col-12 col-lg-3">                            <div class="input-group mb-3">                                <div class="input-group-prepend">                                    <span class="input-group-text gris-9" >Du&hellip;</span>                                </div>                                <input type="text" class=" datepicker form-control" placeholder="Date début" name="filtre_debut" value="<?php echo $filtre_debut != '' ? Outils::dateSqlToFr($filtre_debut) : ''; ?>">                                <div class="input-group-append">                                    <span class="input-group-text"><i class="fas fa-calendar-alt gris-9"></i></span>                                </div>                            </div>                        </div>                        <div class="col-12 col-lg-3">                            <div class="input-group mb-3">                                <div class="input-group-prepend">                                    <span class="input-group-text gris-9" >&hellip;au</span>                                </div>                                <input type="text" class=" datepicker form-control" placeholder="Date fin" name="filtre_fin" value="<?php echo $filtre_fin != '' ? Outils::dateSqlToFr($filtre_fin) : ''; ?>">                                <div class="input-group-append">                                    <span class="input-group-text"><i class="fas fa-calendar-alt gris-9"></i></span>                                </div>                            </div>                        </div>                        <div class="col-12 col-lg-3 text-right">                                <button type="submit" class="btn btn-info mr-2"><i class="fa fa-search mr-1 fa-fw"></i> Rechercher&hellip;</button>                                <a href="<?php echo $_SERVER['PHP_SELF'];?>" class="btn btn-secondary"><i class="fa fa-backspace mr-1 fa-fw"></i> Voir tout</a>                        </div>                    </div>                </div>            </form>            <div id="historiqueAlertes">                <?php                // Aucune alerte                if (empty($listeAlertes)) { ?>                    <div class="alert alert-warning text-center gris-7 padding-50">                        <i class="far fa-times-circle fa-3x"></i>                        <p class="text-30">Aucune alerte trouvée&hellip;</p>                    </div>                <?php                // Liste des alertes                } else { ?>                <table class="admin w-100" data-type="<?php echo $type; ?>" data-page="<?php echo $page; ?>">                    <thead>                        <tr>                            <?php                                // On affiche l'ID que si on est développeur                                if ($utilisateur->isDev()) { ?><th class="w-court-admin-cell">ID</th>                            <?php } ?>                            <th>Type</th>                            <th>Lot N°</th>                            <th>Traitement</th>                            <th>Valeur</th>                            <th>Date</th>                            <th>Opérateur</th>                        </tr>                    </thead>                    <tbody>					<?php foreach ($listeAlertes as $alerte) { ?>                        <tr>                            <?php						    // On affiche l'ID que si on est développeur						    if ($utilisateur->isDev()) { ?>                            <td class="w-court-admin-cell"><span                                        class="badge badge-pill badge-warning"><?php echo $alerte->getId(); ?></span>                            </td>						    <?php } // FIN test dev ?>                            <td>                                <?php echo $alerteManager->getTypesAlertes()[$alerte->getType()];?>                            </td>                            <td>                                <?php echo $alerte->getNumlot();?>                            </td>                            <td>								<?php if ($alerte->getId_froid() > 0 && $alerte->getId_froid_type() > 0) {								        $froidManager   = new FroidManager($cnx);								        $codeFroid      = $froidManager->getFroidCodeById($alerte->getId_froid_type());								        if ((string)$codeFroid != '') {								            echo strtoupper($codeFroid) . sprintf("%04d", $alerte->getId_froid());                                        } else  { echo '&mdash;'; }								    } else { echo '&mdash;'; }?>                            </td>                            <td class="bg-danger text-light">                                <?php echo $alerte->getValeur_verbose(); ?>                            </td>                            <td>                                <?php                                echo ucfirst(Outils::getDate_verbose($alerte->getDate()));                                ?>                            </td>                            <td>                                <?php echo $alerte->getNom_user(); ?>                            </td>                        </tr>                    <?php					} // FIN boucle sur les alertes?>                    </tbody>                </table>                <?php					if (isset($pagination)) {						// Pagination bas de page, verbose...						$pagination->setVerbose_pagination(1);						$pagination->setVerbose_position('right');						$pagination->setNature_resultats('log');						echo $pagination->getPaginationHtml();					}                }  // FIN test alertes trouvées ?>            </div>        </div>    </div></div><?phpinclude('includes/footer.php');