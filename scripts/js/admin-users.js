/** ------------------------------------------------------------------------ JS - Utilisateurs Copyright (C) 2018 Intersed http://www.intersed.fr/ ------------------------------------------------------------------------ @author    Cédric Bouillon @copyright Copyright (c) 2018 Intersed @version   1.0 @since     2018 ------------------------------------------------------------------------ */$(document).ready(function() {    // Affiche la liste des utilisateurs (aJax)    chargeListeUser();    // Export PDF    $('.btnExportPdf').click(function() {        var objetDomBtnExport = $(this);        objetDomBtnExport.find('i').removeClass('fa-file-pdf').addClass('fa-spin fa-spinner');        objetDomBtnExport.attr('disabled', 'disabled');        $.fn.ajax({            'script_execute': 'fct_user.php',            'arguments': 'mode=exportPdf',            'callBack' : function (url_fichier) {                objetDomBtnExport.find('i').removeClass('fa-spin fa-spinner').addClass('fa-file-pdf');                objetDomBtnExport.prop('disabled', false);                $('#lienPdf').attr('href', url_fichier);                $('#lienPdf')[0].click();            } // FIN callBack        }); // FIN ajax    }); // FIN bouton PDF    // Chargement du contenu de la modale Utilisateur à son ouverture    $('#modalUser').on('show.bs.modal', function (e) {        // On récupère l'ID de l'utilisateur.        var user_id = e.relatedTarget.attributes['data-user-id'] === undefined ? 0 : parseInt(e.relatedTarget.attributes['data-user-id'].value);        // On récupère le contenu de la modale        $.fn.ajax({            'script_execute': 'fct_user.php',            'arguments': 'mode=modalUser&id=' + user_id,            'callBack': function (retour) {                // On intègre les différents contenus                var retours = retour.toString().split('^');                var titre = retours[0];                var body = retours[1];                var footer = retours[2];                $('#modalUserTitre').html(titre);                $('#modalUserBody').html(body);                $('#modalUserFooter').html(footer);                // Initialisation des outils JS                $('.selectpicker').selectpicker('render');                $('.togglemaster').bootstrapToggle();                $('[data-toggle="tooltip"]').tooltip();                // Appel au listener de la modale                userModalListener();            } // FIN Callback        }); // FIN aJax    }); // Fin chargement du contenu de la modale    // Recherche    $('.btnRecherche').click(function() {        $.fn.ajax({            'script_execute': 'fct_user.php',            'form_id': 'filtres',            'return_id': 'listeUser',            'callBack': function (retour) {                //listeProduitsListener();            } // FIN Callback        }); // FIN ajax    }); // FIN bouton recherche    $('form#filtres input[type=text]').keyup(function (e) {        var code = (e.keyCode ? e.keyCode : e.which);        if (code === 13) {            e.preventDefault();            $('.btnRecherche').trigger('click');            return false;        }    });    $('form#filtres').submit(function() {        return false;    });    // Nettoyage du contenu de la modale Détails à sa fermeture    $('#modalUser').on('hidden.bs.modal', function (e) {        $('#modalUserTitre').html('<i class="fa fa-spin fa-spinner fa-2x"></i>');        $('#modalUserBody').html('<i class="fa fa-spin fa-spinner fa-2x"></i>');        $('#modalUserFooter').html('<i class="fa fa-spin fa-spinner fa-2x"></i>');    }); // FIN fermeture modale Détails}); // FIN ready/** ****************************************** * Listener de la modale utilisateur ****************************************** */function userModalListener() {    // --------------------------------    // Afficher / masquer le code    // --------------------------------    $('.btnShowHodeCode').click(function() {        // On récupère l'objet DOM        var objInput = $(this).parents('.input-group').find('input');        // Masque le code        if (objInput.attr('type') === 'text') {            objInput.attr('type', 'password');            $(this).find('i.fa').removeClass('fa-eye-slash');            $(this).find('i.fa').addClass('fa-eye');        // Affiche le code        } else {            objInput.attr('type', 'text');            $(this).find('i.fa').removeClass('fa-eye');            $(this).find('i.fa').addClass('fa-eye-slash');        } // FIN test affiche/masque    }); // FIN bouton afficher/masquer le code    // --------------------------------    // Génère un code disponible    // --------------------------------    $('.btnGenereCodeDispo').click(function() {        // On récupère l'objet DOM        var objInput = $('input[name=code]');        // On rend le code visible si il est masqué        if (objInput.attr('type') === 'password') {            objInput.attr('type', 'text');            $('.btnShowHodeCode').find('i.fa').removeClass('fa-eye');            $('.btnShowHodeCode').find('i.fa').addClass('fa-eye-slash');        } // FIN code visible        // On récupère un code valide (aJax)        $.fn.ajax({            'script_execute': 'fct_user.php',            'arguments': 'mode=genereCode',            'callBack': function (retour) {                objInput.val(retour);            } // FIN callback        }); // FIN ajax    }); // FIN bouton générer un code    // -----------------------------------    // Si on change le profil,    // on adapte l'activation de l'e-mail    // -----------------------------------    $('#user_select_profil').on('changed.bs.select', function () {        // Si on est sur un profil nécessitant un email        if (parseInt($('option:selected', this).data('needmail')) === 1) {            // On rend le champ e-mail editable et on affiche le bloc d'info sur le mail            $('#input_user_email').prop('disabled', false);            $('#input_user_email').parents('.input-group.disabled').removeClass('disabled');            $('.infoMailAdmin').removeClass('d-none');        // Sinon, on est sur un profil sans mail obligatoire        } else {            // On rend le champ mail non-éditable            $('#input_user_email').prop('disabled', true);            // Si le conteneur était éditable, on lui rajoute la calsse disabled aussi (Bootstrap)            if (!$('#input_user_email').parents('.input-group').hasClass('disabled')) {                $('#input_user_email').parents('.input-group').addClass('disabled');                // On masque le bloc d'info sur le mail s'il était affiché                if (!$('.infoMailAdmin').hasClass('d-none')) {                   $('.infoMailAdmin').addClass('d-none');                } // FIN test bloc d'info mail affiché            } // FIN test conteneur disabled       } // FIN test profil requiert un mail ou non    }); // FIN change profil (select)    // --------------------------------    // Bouton Enregistrer    // --------------------------------    $('.btnSaveUser').off("click.btnSaveUser").on("click.btnSaveUser", function(e) {        e.preventDefault();        // Si le bloc d'alerte de mail déjà existant affiché, on le masque (réinitialisation)        if (!$('.doublonMail').hasClass('d-none')) {            $('.doublonMail').addClass('d-none')        } // FIN test bloc alerte mail affiché        // Initialisation des variables        var erreurs             = false;        var champsObligaroires  = ['prenom', 'nom', 'email', 'code'];        var regexMail           = new RegExp('^[a-z0-9._-]+@[a-z0-9._-]{2,}\\.[a-z]{2,4}$');        var regexCode           = new RegExp('^[0-9]{4}$');        // On boucle sur tous les champs obligatoires        $.each( champsObligaroires, function( key, value ) {            // Champ email            if (value === 'email') {                // On vérifie si le profil est admin, si oui et que l'email est vide ou invalide, on erreur                if (parseInt($('option:selected', $('#user_select_profil')).data('needmail')) === 1) {                    // On récupère le mail saisi                    var email = $('#input_user_'+value).val()+'';                    // Si le mail est incorrect                    if (!regexMail.test(email)) {                        // On affiche l'invalidité sur le champ e-mail (Bootstrap) pendant 3 secondes                        $('#input_user_'+value).addClass('is-invalid');                        setTimeout(function(){                            $('#input_user_'+value).removeClass('is-invalid');                        }, 3000);                        // On déclare l'erreur                        erreurs = true;                    } // FIN test mail erreur                } // FIN test mail requis            // Autres champs que e-mail            } else {                // Si le champ est vide, ou que le code est n'est pas valide (regex)                if ($('#input_user_'+value).val().length < 1 || ( value === 'code' && !regexCode.test($('#input_user_'+value).val()) )) {                    // On affiche l'invalidité sur le champ correspondant (Bootstrap) pendant 3 secondes                    $('#input_user_'+value).addClass('is-invalid');                    setTimeout(function(){                        $('#input_user_'+value).removeClass('is-invalid');                    }, 3000);                    // On déclare l'erreur                    erreurs = true;                } // FIN test validité du champ            } // FIN test champ autre que mail est vide        }); // FIN boucle sur les champs à vérifier        // Si pas d'erreur jusque là on continue...        if (erreurs === false) {            // On vérifie que le mail n'est pas déjà attribué à quelqu'un si on est en création d'un admin            if (parseInt($('input[name=user_id]').val()) === 0 && parseInt($('option:selected', $('#user_select_profil')).data('needmail')) === 1) {                // On récupère le mail renseigné                var email = $('#input_user_email').val()+'';                // Vérification qu'il est disponible (aJax)                $.fn.ajax({                    'script_execute': 'fct_user.php',                    'arguments': 'mode=checkMailExiste&email='+email,                    'callBack': function (retour) {                        // Si le mail est déjà attribué                        if (parseInt(retour) === 1) {                            // On affiche le message de doublon                            if ($('.doublonMail').hasClass('d-none')) {                                $('.doublonMail').removeClass('d-none')                            }                        // Sinon, on peux valider l'enregistrement                        } else {                            goAddUpd();                        } // FIN test retour aJax de mail déjà attribué                    } // FIN callback                }); // FIN aJax            // Sinon, pas besoin de vérifie si le mail est déjà attribué, on valide l'enregistrement            } else {                goAddUpd();            } // FIN test dernière vérif sur le mail        } // FIN test pas d'erreur        return false;    }); // FIN bouton Enregistrer    // --------------------------------    // Bouton Supprimer    // --------------------------------    $('.btnSupprimeUser').off("click.btnSupprimeUser").on("click.btnSupprimeUser", function(e) {        e.preventDefault();        // Si on ne trouve pas l'ID de l'utilisateur, on ne va pas plus loin...        if ( $('#formUserAddUpd').find('input[name=user_id]') === undefined) { return false; }        // On initialise, formate et contrôle l'ID de l'utilisateur        var id_user = parseInt($('#formUserAddUpd').find('input[name=user_id]').val());        if (id_user === 0) { return false; }        // Message de confirmation        var texte = "ATTENTION !\r\nVous allez supprimer un utilisateur de l'intranet.\r\nContinuer ?";        if (!confirm(texte)) { return false; }        // Confirmation OK, on supprime l'utilisateur (aJax)        $.fn.ajax({            'script_execute': 'fct_user.php',            'arguments': 'mode=supprUser&id_user='+id_user,            'callBack': function () {                // On recharge la liste à jour des utilisateur et on ferme la modale.                chargeListeUser();                $('#modalUser').modal('hide');            } // FIN callback        }); // FIN ajax        return false;    }); // FIN bouton supprime} // FIN listener/** ****************************************** * Affiche la liste des users ****************************************** */function chargeListeUser() {    $.fn.ajax({        'script_execute': 'fct_user.php',        'arguments': 'mode=showListeUsers',        'return_id': 'listeUser'    }); // FIN ajax    return true;} // FIN fonction/** ****************************************** * Valide l'enregistrement ****************************************** */function goAddUpd () {    $.fn.ajax({        'script_execute': 'fct_user.php',        'form_id': 'formUserAddUpd',        'callBack': function () {            // on recharge la liste à jour et on ferme la modale            chargeListeUser();            $('#modalUser').modal('hide');        } // FIN callback    }); // FIN ajax    return false;} // FIN fonction