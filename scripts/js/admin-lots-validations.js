/** ------------------------------------------------------------------------ JS - Validations Copyright (C) 2018 Intersed http://www.intersed.fr/ ------------------------------------------------------------------------ @author    Cédric Bouillon @copyright Copyright (c) 2018 Intersed @version   1.0 @since     2018 ------------------------------------------------------------------------ */$('document').ready(function() {    chargeListeValidations();    // Rafraichissement de la liste toutes les minutes    setInterval(function() {        chargeListeValidations();        updateBadgeCompteurH1();    }, 60 * 1000);    // --------------------------------    // Bouton Tout Valider    // --------------------------------    $('.btnToutValider').off("click.btntoutvalider").on("click.btntoutvalider", function(e) {        e.preventDefault();        var nbAvalider = $('.btnValider').length;        if (nbAvalider === 0) { return false; }        // Confirmation si au moins 2 lots        if (nbAvalider > 1) {            if (!confirm("ATTENTION !\r\nVous allez valider ces " + nbAvalider + " lots.\r\nContinuer ?")) { return false; }        }        // ON met le spinner        var objetDom = $(this).find('i.fa');        objetDom.removeClass('fa-check-double').addClass('fa-spin fa-spinner');        $.fn.ajax({            'script_execute': 'fct_validations.php',            'arguments': 'mode=validationLotsTous',            'callBack': function (retour) {                objetDom.removeClass('fa-spin fa-spinner').addClass('fa-check-double');                if (parseInt(retour) === -1 ) {                    alert('ERREUR !\r\nUne erreur est survenue...\r\nCode erreur : CZCCAADJ');                    return false;                }                updateBadgeCompteurH1();                chargeListeValidations();            }        }); // FIN aJax    }); // FIN bouton Tout Valider}); // FIN ready// Listener modale validationfunction valideModaleListener() {    $('.togglemaster').bootstrapToggle();    // Validation    $('.btnValiderFromModale, .btnValider').off("click.btnValider").on("click.btnValider", function(e) {        e.preventDefault();        var id_validation = $(this).data('id-validation') === undefined   ? 0 : parseInt($(this).data('id-validation'));        if (id_validation === 0) { return false; }        // ON met le spinner        var objetDom = $(this).find('i.fa');        objetDom.removeClass('fa-check').addClass('fa-spin fa-spinner');        var conformite = -1;        if ($('#updConformite').length) {            conformite = $('#updConformite').is(':checked') ? 1 : 0;        }        // On valide        $.fn.ajax({            'script_execute': 'fct_validations.php',            'arguments': 'mode=validationLot&id_validation=' + id_validation + '&conformite=' + conformite,            'callBack': function (retour) {                objetDom.removeClass('fa-spin fa-spinner').addClass('fa-check');                if (parseInt(retour) === -1 ) {                    alert('ERREUR !\r\nUne erreur est survenue...\r\nCode erreur : TELXHAAQ');                    return false;                }                updateBadgeCompteurH1();                $('#modalValidation').modal('hide');                chargeListeValidations();            }        }); // FIN aJax    }); // Fin validation    // Switch validation courbe de température    $('.switch-courbe-temp').change(function(e) {        e.stopImmediatePropagation();        var courbe_temp = $(this).prop('checked') ?  1 : 0;        var id_val      = parseInt($(this).data('id-val'));        $.fn.ajax({            'script_execute': 'fct_validations.php',            'arguments': 'mode=courbeTemp&id_validation=' + id_val+'&courbe_temp='+courbe_temp        }); // FIN aJax    }); // FIN switch validation courbe de température} // FIN listener// Charge la liste des lots à validerfunction chargeListeValidations() {    // On valide    $.fn.ajax({        'script_execute': 'fct_validations.php',        'arguments': 'mode=showListeValidations',        'return_id': 'listeValidation',        'done': function () {            listeValidationsListener();        }    }); // FIN aJax} // FIN fonction// Listener de la liste des validationsfunction listeValidationsListener() {    $(function () {        $('[data-toggle="tooltip"]').tooltip();    });    // Chargement du contenu de la modale détails à son ouverture    $('#modalValidation').on('show.bs.modal', function (e) {        e.stopImmediatePropagation();        e.stopPropagation();        // On récupère l'ID du lot et le type de détails        var validation_id   = e.relatedTarget.attributes['data-validation-id']   === undefined ? 0 : parseInt(e.relatedTarget.attributes['data-validation-id'].value);        if (validation_id === 0) { return false; }        // On récupère le contenu de la modale        $.fn.ajax({            'script_execute': 'fct_validations.php',            'arguments': 'mode=modalValidationDetails&validation_id=' + validation_id,            'callBack': function (retour) {                if (parseInt(retour) === -1 ) {                    alert('ERREUR !\r\nRécuparation des données impossible...\r\nCode erreur : ZAKVFIHH');                    return false;                }                // On intègre les différents contenus                var retours = retour.toString().split('^');                var body = retours[0];                var footer = retours[1];                $('#modalValidationBody').html(body);                $('#modalValidationFooter').html(footer);                valideModaleListener();            } // FIN Callback        }); // FIN aJax    }); // Fin chargement du contenu de la modale    // Nettoyage du contenu de la modale Détails à sa fermeture    $('#modalValidation').on('hidden.bs.modal', function (e) {        $('#modalValidationBody').html('<i class="fa fa-spin fa-spinner fa-2x"></i>');    }); // FIN fermeture modale Détails    valideModaleListener();} // FIN listener// Met à jour le compteur de lots à valider dans le menu des vuesfunction updateBadgeCompteurH1() {    $.fn.ajax({        'script_execute': 'fct_validations.php',        'arguments': 'mode=updateBadgeCompteurMenu',        'return_id': 'ajaxCompteurH1'    }); // FIN aJax} // FIN fonction