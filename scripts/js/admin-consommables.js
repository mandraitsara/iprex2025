/** ------------------------------------------------------------------------ JS - Admin consommables (hors emballages) Copyright (C) 2019 Intersed http://www.intersed.fr/ ------------------------------------------------------------------------ @author    Cédric Bouillon @copyright Copyright (c) 2019 Intersed @version   1.0 @since     2019 ------------------------------------------------------------------------ */$(document).ready(function() {    "use strict";    // Affiche la liste des consommables hors emballages (aJax)    chargeListeConsommables();    // Export PDF    $('.btnExportPdf').click(function() {        var objetDomBtnExport = $(this);        objetDomBtnExport.find('i').removeClass('fa-file-pdf').addClass('fa-spin fa-spinner');        objetDomBtnExport.attr('disabled', 'disabled');        var id_famille = parseInt($('#consommablesFamilleId').val());        $.fn.ajax({            'script_execute': 'fct_consommables.php',            'arguments': 'mode=exportPdf&type=cons&id_famille='+id_famille,            'callBack' : function (url_fichier) {                objetDomBtnExport.find('i').removeClass('fa-spin fa-spinner').addClass('fa-file-pdf');                objetDomBtnExport.prop('disabled', false);                $('#lienPdf').attr('href', url_fichier);                $('#lienPdf')[0].click();            } // FIN callBack        }); // FIN ajax    }); // FIN bouton PDF    // Chargement du contenu de la modale du Consommable à son ouverture    $('#modalConsommable').on('show.bs.modal', function (e) {        // On récupère l'ID du consommable        var consommable_id = e.relatedTarget.attributes['data-consommable-id'] === undefined ? 0 : parseInt(e.relatedTarget.attributes['data-consommable-id'].value);        var id_famille = parseInt($('#consommablesFamilleId').val());        // On récupère le contenu de la modale        $.fn.ajax({            'script_execute': 'fct_consommables.php',            'arguments': 'mode=modalConsommable&famille_id=' + id_famille+'&consommable_id='+consommable_id,            'callBack': function (retour) {                // On intègre les différents contenus                var retours = retour.toString().split('^');                var titre = retours[0];                var body = retours[1];                var footer = retours[2];                $('#modalConsommableTitre').html(titre);                $('#modalConsommableBody').html(body);                $('#modalConsommableFooter').html(footer);                // Initialisation des outils JS                $('.selectpicker').selectpicker('render');                $(".datepicker").datepicker({                    dateFormat:      "dd/mm/yy",                    dayNames:        ["Dimanche", "Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi"],                    dayNamesMin:     ["Di", "Lu", "Ma", "Me", "Je", "Ve", "Sa"],                    dayNamesShort:   ["Dim", "Lun", "Mar", "Mer", "Jeu", "Ven", "Sam"],                    firstDay:        1,                    monthNames:      ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"],                    monthNamesShort: ["Jan", "Fév", "Mar", "Avr", "Mai", "Juin", "Juil", "Août", "Sep", "Oct", "Nov", "Déc"],                    nextText:        "Mois suivant",                    prevText:        "Mois précédent"                }); // FIN DatePicker                // Appel au listener de la modale                consommableModalListener();            } // FIN Callback        }); // FIN aJax    }); // Fin chargement du contenu de la modale    // Nettoyage du contenu de la modale à sa fermeture    $('#modalConsommable').on('hidden.bs.modal', function (e) {        $('#modalConsommableTitre').html('<i class="fa fa-spin fa-spinner fa-2x"></i>');        $('#modalConsommableBody').html('<i class="fa fa-spin fa-spinner fa-2x"></i>');        $('#modalConsommableFooter').html('<i class="fa fa-spin fa-spinner fa-2x"></i>');    }); // FIN fermeture modale}); // FIN ready/** **************************************** * Listener de la modale Consommable **************************************** */function consommableModalListener() {    "use strict";    // --------------------------------    // Bouton Enregistrer    // --------------------------------    $('.btnsaveConsommable').off("click.btnsaveConsommable").on("click.btnsaveConsommable", function(e) {        e.preventDefault();        // Si le champ Référence est vide        if ($('#input_numlot_frs').val().length < 1 || $('#input_numlot_frs').val() === '') {            // On affiche l'invalidité sur le champ correspondant (Bootstrap) pendant 3 secondes            $('#input_numlot_frs').addClass('is-invalid');            setTimeout(function(){                $('#input_numlot_frs').removeClass('is-invalid');            }, 3000);            return false;        } // FIN test validité du champ        // Si le champ fournisseur est vide        if (isNaN(parseInt($('#input_id_fournisseur').val()))  || parseInt($('#input_id_fournisseur').val()) === 0) {            // On affiche l'invalidité sur le champ correspondant (Bootstrap) pendant 3 secondes            alert('Sélectionnez le fournisseur...');            return false;        } // FIN test validité du champ        goAddUpd();    }); // FIN bouton Enregistrer    // --------------------------------    // Bouton Supprimer    // --------------------------------    $('.btnSupprimeConsommable').off("click.btnSupprimeConsommable").on("click.btnSupprimeConsommable", function(e) {        e.preventDefault();        // Si on ne trouve pas l'ID du consommable, on ne va pas plus loin...        if ( $('#formConsommableAddUpd').find('input[name=consommable_id]') === undefined) { return false; }        // On initialise, formate et contrôle l'ID du consommable        var consommable_id = parseInt($('#formConsommableAddUpd').find('input[name=consommable_id]').val());        if (consommable_id === 0) { return false; }        // Message de confirmation        var texte = "CONFIRMER\r\nVous allez supprimer cette référence...\r\nContinuer ?";        if (!confirm(texte)) { return false; }        // Confirmation OK, on supprime (aJax)        $.fn.ajax({            'script_execute': 'fct_consommables.php',            'arguments': 'mode=supprConsommable&consommable_id='+consommable_id,            'callBack': function () {                // On recharge la liste à jour des emballages et on ferme la modale.                chargeListeConsommables();                $('#modalConsommable').modal('hide');            } // FIN callback        }); // FIN ajax        return false;    }); // FIN bouton supprime} // FIN listener/** ******************************************** * Affiche la liste des consommables ******************************************** */function chargeListeConsommables() {    var famille_id = parseInt($('#consommablesFamilleId').val());    if (isNaN(famille_id) || famille_id === 0 || famille_id === undefined) { return false; }    $.fn.ajax({        'script_execute': 'fct_consommables.php',        'arguments': 'mode=showListeConsommables&famille_id='+famille_id,        'return_id': 'listesConsommables',        'done' : function() {            listeConsommablesListener();        }    }); // FIN ajax    return true;} // FIN fonction/** ****************************************** * Valide l'enregistrement ****************************************** */function goAddUpd () {    "use strict";    // On échape les esperluettes pour l'ajax    var nomClean = $('#input_numlot_frs').val().replace('&', '#et#');    $('#input_numlot_frs').val(nomClean);    $.fn.ajax({        'script_execute': 'fct_consommables.php',        'form_id': 'formConsommableAddUpd',        'callBack': function () {            // on recharge la liste à jour et on ferme la modale            chargeListeConsommables();            $('#modalConsommable').modal('hide');        } // FIN callback    }); // FIN ajax    return false;} // FIN fonction/** ******************************************** * Listener de la liste de types de consommables ******************************************** */function listeConsommablesListener() {} // FIN fonction