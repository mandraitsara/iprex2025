/** ------------------------------------------------------------------------ JS - Vue Emballage Copyright (C) 2018 Intersed http://www.intersed.fr/ ------------------------------------------------------------------------ @author    Cédric Bouillon @copyright Copyright (c) 2018 Intersed @version   1.0 @since     2018 ------------------------------------------------------------------------ */$('document').ready(function() {    "use strict";    chargeEtape(1, 0);    // Nettoyage du contenu de la modale Nouvel Emballage à sa fermeture    $('#modalNouvelEmballage').on('hidden.bs.modal', function (e) {        $('#modalNouvelEmballageBody').html('<i class="fa fa-spin fa-spinner fa-2x"></i>');    }); // FIN fermeture modale Nouvel Emballage}); // FIN ready// Fonction chargeant les étapes pour intégrer leur contenufunction chargeEtape(numeroEtape, identifiant) {    $('.etapes-suivantes').hide('fast');    $('#etape'+numeroEtape).show('fast');    $('#etape'+numeroEtape).html('<div class="padding-50 text-center"><i class="fa fa-spin fa-spinner fa-5x gris-c"></i></div>');    // Ajax qui charge le contenu de l'étape    $.fn.ajax({        'rep_script_execute': "../scripts/ajax/", // Gestion de l'URL Rewriting        'script_execute': 'fct_vue_emb.php',        'arguments': 'mode=chargeEtapeVue&etape=' + numeroEtape + '&id='+identifiant,        'return_id': 'etape'+numeroEtape,        'done': function () {            var fctnom = "listenerEtape"+numeroEtape;            var fn  = window[fctnom];            fn(identifiant);        } // FIN Callback    }); // FIN ajax} // FIN fonction chargeEtape// Charge le Ticket (maj)function chargeTicketLot(etape, identifiant) {    // Ajax qui charge le contenu du ticket    $.fn.ajax({        'rep_script_execute': "../scripts/ajax/", // Gestion de l'URL Rewriting        'script_execute': 'fct_vue_emb.php',        'arguments': 'mode=chargeTicketLot&etape='+etape+'&id=' + identifiant,        'return_id': 'ticketLotContent',        'done' : function() {            listenerTicketLot(identifiant);        }    }); // FIN ajax} // FIN fonction// Listener de l'étape 1function listenerEtape1(identifiant) {    "use strict";    chargeTicketLot(1, identifiant);    $('.btn-emb-change').off("click.btnembchange").on("click.btnembchange", function(e) {        e.preventDefault();        var id_fam = parseInt($(this).parents('.card').data('id-fam'));        var id_old_emb = parseInt($(this).data('id-old-emb'));        if (id_fam === undefined || id_fam === 0 || isNaN(id_fam)) { alert("Identifaction de la famille impossible.\nCode erreur : YQMOBJCM"); return false; }        // Famille identifiée, on rechage le body de la modale avec les emballages disponibles ayant du stock et non par défaut:        $('#modalNouvelEmballage').modal('show');        $.fn.ajax({            'rep_script_execute': "../scripts/ajax/",            'script_execute': 'fct_emballages.php',            'arguments': 'mode=modalNouvelEmballageFrontEtape2&vue_code=atl&id_fam='+id_fam+'&id_old_emb='+id_old_emb,            'return_id' : 'modalNouvelEmballageBody',            'done': function() {                modalNouvelEmballageFrontEtape2Listener();            }        }); // FIN aJax    }); // FIN bouton changer rouleau sur emballage    // Bouton déclarer un défectueux sur l'emballage    $('.btn-emb-defectueux').off("click.btnembchange").on("click.btnembchange", function(e) {        e.preventDefault();        var id_emb = parseInt($(this).data('id-emb'));        if (id_emb === undefined || id_emb === 0 || isNaN(id_emb)) { alert("Identifaction du rouleau impossible.\nCode erreur : RAEBPCOD"); return false; }        var ifa = $(this).find('i.fa');        ifa.removeClass('fa-exclamation-triangle').addClass('fa-spin fa-spinner');        $.fn.ajax({            'rep_script_execute': "../scripts/ajax/",            'script_execute': 'fct_emballages.php',            'arguments': 'mode=declareDefectueux&id_emb='+id_emb,            'done': function() {                chargeTicketLot(1, 0);                ifa.removeClass('fa-spin fa-spinner').addClass('fa-check');                setTimeout(function(){                    ifa.removeClass('fa-check').addClass('fa-exclamation-triangle');                }, 500);            }        }); // FIN aJax    }); // FIN bouton déclarer un défectueux sur l'emballage    // Bouton imprimer étiquette    $('.btn-emb-print').off("click.btnembprint").on("click.btnembprint", function(e) {        e.preventDefault();        var id_con = parseInt($(this).data('id-fam'));        $('#idToPrint').val(id_con);        $('#modalQuantiteEtiquettesInfo').text('0');        var nom_court = $(this).parents('.card').find('.card-title').text().trim();        $('#modalQuantiteEtiquettesProduit').text(nom_court);        $('#modalQuantiteEtiquettes').modal('show');    }); // FIN bouton imprimer    // Pavé numérique quantité à imprimer    $('#modalQuantiteEtiquettes .clavier .btn').off("click.appuietoucheclavier").on("click.appuietoucheclavier", function(e) {        e.preventDefault();        // On récupère la valeur de la touche        var touche = $(this).data('valeur');        var qte = parseInt($('#modalQuantiteEtiquettesInfo').text().trim());        if (isNaN(qte)) {            qte = 0;            $('#modalQuantiteEtiquettesInfo').text(qte);            return false;        }        if (qte === 0 && touche !== 'C' && parseInt(touche) > 0) {            qte =  parseInt(touche);        } else if ( touche !== 'C') {            qte = parseInt(qte.toString() + touche.toString());        } else if (touche === 'C') {            qte = parseInt(qte.toString().slice(0,-1));            if (qte === '' || isNaN(parseInt(qte))) {                qte = 0;            }        }        if (parseInt(qte) > 999) {            return false;        }        $('#modalQuantiteEtiquettesInfo').text(qte);    }); // FIN pavé numérique quantité    // Imprimer étiquettes    $('#modalQuantiteEtiquettes .btn-imprimer-etiquettes').off("click.btnimprimeretiquettes").on("click.btnimprimeretiquettes", function(e) {        e.preventDefault();        var copies = parseInt($('#modalQuantiteEtiquettesInfo').text().trim());        if (isNaN(copies) || copies === 0) { return false; }        var id_fam = parseInt($('#idToPrint').val());        // IMPRESSION        $.fn.ajax({            'rep_script_execute': "../scripts/ajax/",            'script_execute': 'fct_etiquettes.php',            'arguments': 'mode=imprimerEtiquette&id_fam='+id_fam+'&copies='+copies+'&vue=con',            'callBack': function(retour) {                if (retour === '') {                    alert('Impression impossible !');                    return false;                }                var doc = document.getElementById('etiquetteFrame').contentWindow.document;                doc.open();                doc.write(retour);                doc.close();                window.frames["imprimerEtiquette"].focus();                window.frames["imprimerEtiquette"].print();            }        }); // FIN aJax    }); // FIN bouton imprimer étiquettes    // Pagination Ajax sur les emballages    $(document).on('click','.carte-pdt-pagination',function(){        if ($(this).attr('data-url') === undefined) { return false; }        // on affiche le loading d'attente        $('#etape3').html('<i class="fa fa-spin fa-spinner fa-2x"></i>');        // on fait l'appel ajax qui va rafraichir la liste        $.fn.ajax({            'rep_script_execute': "../scripts/ajax/",            'script_execute':'fct_vue_emb.php'+$(this).attr('data-url'),            'return_id':'containerListeEmballages',            'done': function() {                listenerEtape1();            }        }); // FIN ajax        // on désactive le lien hypertexte        return false;    }); // FIN pagination ajax} // FIN listener etape// Listener du Ticketfunction listenerTicketLot(identifiant) {    "use strict";} // FIN listener Ticket// Listener de la modale changement de rouleau (Etape 2)function modalNouvelEmballageFrontEtape2Listener() {    // Sélection d'une famille    $('.carte-new-emb-defaut').off("click.cartenewembdefaut'").on("click.cartenewembdefaut", function(e) {        e.preventDefault();        var id_emb = parseInt($(this).data('id-emballage'));        if (id_emb === undefined || id_emb === 0 || isNaN(id_emb)) { alert("Identifaction de l'emballage impossible.\nCode erreur : VMPJGEOU"); return false; }        // Emballage identifiée, on le définie comme en cours et on recharge l'étape du lot...        $.fn.ajax({            'rep_script_execute': "../scripts/ajax/",            'script_execute': 'fct_emballages.php',            'arguments': 'mode=setNewEmballageEnCours&id_emb='+id_emb+'&code_vue=emb',            'done': function() {                // On ferme la modale                $('#modalNouvelEmballage').modal('hide');                // On met à jour la liste des emballages dans la vue principale (avec le numéro de lot)                //var id_lot  = parseInt($('#numLotTicket').data('id-lot'));                chargeEtape(1, 0);            } // FIN callback        }); // FIN aJax    }); // FIN Sélection d'une famille} // FIN Listener