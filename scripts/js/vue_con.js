/** ------------------------------------------------------------------------ JS - Vue Consommables Copyright (C) 2018 Intersed http://www.intersed.fr/ ------------------------------------------------------------------------ @author    Cédric Bouillon @copyright Copyright (c) 2019 Intersed @version   1.0 @since     2019 ------------------------------------------------------------------------ */$('document').ready(function() {    "use strict";    chargeEtape(1, 0);    // Nettoyage du contenu de la modale Nouvel Emballage à sa fermeture    $('#modalNouvelEmballage').on('hidden.bs.modal', function (e) {        $('#modalNouvelEmballageBody').html('<i class="fa fa-spin fa-spinner fa-2x"></i>');    }); // FIN fermeture modale Nouvel Emballage    // Comme on utilise la même modale que pour les emballage, on corrige un peu le titre...    $('#modalNouvelEmballage .modal-title').html('<i class="fa fa-retweet mr-1"></i>Changer de référence…');}); // FIN ready// Fonction chargeant les étapes pour intégrer leur contenufunction chargeEtape(numeroEtape, identifiant) {    $('.etapes-suivantes').hide('fast');    $('#etape'+numeroEtape).show('fast');    $('#etape'+numeroEtape).html('<div class="padding-50 text-center"><i class="fa fa-spin fa-spinner fa-5x gris-c"></i></div>');    // Ajax qui charge le contenu de l'étape    $.fn.ajax({        'rep_script_execute': "../scripts/ajax/", // Gestion de l'URL Rewriting        'script_execute': 'fct_vue_con.php',        'arguments': 'mode=chargeEtapeVue&etape=' + numeroEtape + '&id='+identifiant,        'return_id': 'etape'+numeroEtape,        'done': function () {            var fctnom = "listenerEtape"+numeroEtape;            var fn  = window[fctnom];            fn(identifiant);        } // FIN Callback    }); // FIN ajax} // FIN fonction chargeEtape// Charge le Ticket (maj)function chargeTicketLot(etape, identifiant) {    // Ajax qui charge le contenu du ticket    $.fn.ajax({        'rep_script_execute': "../scripts/ajax/", // Gestion de l'URL Rewriting        'script_execute': 'fct_vue_con.php',        'arguments': 'mode=chargeTicketLot&etape='+etape+'&id=' + identifiant,        'return_id': 'ticketLotContent',        'done' : function() {            listenerTicketLot(identifiant);        }    }); // FIN ajax} // FIN fonction// Listener de l'étape 1function listenerEtape1(identifiant) {    "use strict";    chargeTicketLot(1, identifiant);    $('.btn-emb-change').off("click.btnembchange").on("click.btnembchange", function(e) {        e.preventDefault();        var id_fam = parseInt($(this).parents('.card').data('id-fam'));        var id_old_con = parseInt($(this).data('id-old-con'));        if (id_fam === undefined || id_fam === 0 || isNaN(id_fam)) { alert("Identifaction de la famille impossible.\nCode erreur : YQMOBJCM"); return false; }        // Famille identifiée, on rechage le body de la modale avec les emballages disponibles ayant du stock et non par défaut:        $('#modalNouvelEmballage').modal('show');        $.fn.ajax({            'rep_script_execute': "../scripts/ajax/",            'script_execute': 'fct_consommables.php',            'arguments': 'mode=modalChangementConsommable&id_fam='+id_fam+'&id_old_con='+id_old_con,            'return_id' : 'modalNouvelEmballageBody',            'done': function() {                modalNouvelEmballageFrontEtape2Listener();            }        }); // FIN aJax    }); // FIN bouton changer rouleau sur emballage    // Bouton déclarer un défectueux sur l'emballage    $('.btn-con-defectueux').off("click.btncondefectueux").on("click.btncondefectueux", function(e) {        e.preventDefault();        var id_con = parseInt($(this).data('id-con'));        if (id_con === undefined || id_con === 0 || isNaN(id_con)) { alert("Identifaction du consommable impossible.\nCode erreur : IYNB9S7Q"); return false; }        var ifa = $(this).find('i.fa');        ifa.removeClass('fa-exclamation-triangle').addClass('fa-spin fa-spinner');        $.fn.ajax({            'rep_script_execute': "../scripts/ajax/",            'script_execute': 'fct_consommables.php',            'arguments': 'mode=declareDefectueux&id_con='+id_con,            'done': function() {                chargeTicketLot(1, 0);                ifa.removeClass('fa-spin fa-spinner').addClass('fa-check');                setTimeout(function(){                    ifa.removeClass('fa-check').addClass('fa-exclamation-triangle');                }, 500);            }        }); // FIN aJax    }); // FIN bouton déclarer un défectueux sur l'emballage    // Bouton imprimer étiquette    $('.btn-emb-print').off("click.btnembprint").on("click.btnembprint", function(e) {        e.preventDefault();        var id_con = parseInt($(this).data('id-fam'));        $('#idToPrint').val(id_con);        $('#modalQuantiteEtiquettesInfo').text('0');        var nom_court = $(this).parents('.card').find('.card-title').text().trim();        $('#modalQuantiteEtiquettesProduit').text(nom_court);        $('#modalQuantiteEtiquettes').modal('show');    }); // FIN bouton imprimer    // Pavé numérique quantité à imprimer    $('#modalQuantiteEtiquettes .clavier .btn').off("click.appuietoucheclavier").on("click.appuietoucheclavier", function(e) {        e.preventDefault();        // On récupère la valeur de la touche        var touche = $(this).data('valeur');        var qte = parseInt($('#modalQuantiteEtiquettesInfo').text().trim());        if (isNaN(qte)) {            qte = 0;            $('#modalQuantiteEtiquettesInfo').text(qte);            return false;        }        if (qte === 0 && touche !== 'C' && parseInt(touche) > 0) {            qte =  parseInt(touche);        } else if ( touche !== 'C') {            qte = parseInt(qte.toString() + touche.toString());        } else if (touche === 'C') {            qte = parseInt(qte.toString().slice(0,-1));            if (qte === '' || isNaN(parseInt(qte))) {                qte = 0;            }        }        if (parseInt(qte) > 999) {            return false;        }        $('#modalQuantiteEtiquettesInfo').text(qte);    }); // FIN pavé numérique quantité    // Imprimer étiquettes    $('#modalQuantiteEtiquettes .btn-imprimer-etiquettes').off("click.btnimprimeretiquettes").on("click.btnimprimeretiquettes", function(e) {        e.preventDefault();        var copies = parseInt($('#modalQuantiteEtiquettesInfo').text().trim());        if (isNaN(copies) || copies === 0) { return false; }        var id_fam = parseInt($('#idToPrint').val());        // IMPRESSION        $.fn.ajax({            'rep_script_execute': "../scripts/ajax/",            'script_execute': 'fct_etiquettes.php',            'arguments': 'mode=imprimerEtiquette&id_fam='+id_fam+'&copies='+copies+'&vue=con',            'callBack': function(retour) {                if (retour === '') {                    alert('Impression impossible !');                    return false;                }                var doc = document.getElementById('etiquetteFrame').contentWindow.document;                doc.open();                doc.write(retour);                doc.close();                window.frames["imprimerEtiquette"].focus();                window.frames["imprimerEtiquette"].print();            }        }); // FIN aJax    }); // FIN bouton imprimer étiquettes    // Pagination Ajax sur les emballages    $(document).on('click','.carte-pdt-pagination',function(){        if ($(this).attr('data-url') === undefined) { return false; }        // on affiche le loading d'attente        $('#etape3').html('<i class="fa fa-spin fa-spinner fa-2x"></i>');        // on fait l'appel ajax qui va rafraichir la liste        $.fn.ajax({            'rep_script_execute': "../scripts/ajax/",            'script_execute':'fct_vue_con.php'+$(this).attr('data-url'),            'return_id':'containerListeEmballages',            'done': function() {                listenerEtape1();            }        }); // FIN ajax        // on désactive le lien hypertexte        return false;    }); // FIN pagination ajax} // FIN listener etape// Listener de l'étape 2function listenerEtape2(identifiant) {    "use strict";    chargeTicketLot(2, identifiant);    // Sélection d'un type de consommables    $('.carte-consommable-type').off("click.carteconsommabletype'").on("click.carteconsommabletype", function(e) {        var id_type = parseInt($(this).data('id-type'));        // Gestion des erreurs        if (id_type === 0 || isNaN(id_type) || id_type === undefined) {            alert("ERREUR !\r\nIdentification du type impossible...\r\nCode erreur : DEKUUVCV");            return false;        } // FIN gestion des erreurs        chargeEtape(3, id_type);    }); // FIN sélection d'un type de consommable} // FIN listener etape// Listener de l'étape 3function listenerEtape3(identifiant) {    "use strict";    chargeTicketLot(3, identifiant);    // Sélection d'une famille de consommables    $('.carte-consommable-famille').off("click.carteconsommablefamille'").on("click.carteconsommablefamille", function(e) {        var id_famille = parseInt($(this).data('id-famille'));        // Gestion des erreurs        if (id_famille === 0 || isNaN(id_famille) || id_famille === undefined) {            alert("ERREUR !\r\nIdentification de la famille impossible...\r\nCode erreur : YPPDEVIV");            return false;        } // FIN gestion des erreurs        chargeEtape(4, id_famille);    }); // FIN sélection d'un type de consommable} // FIN listener etape// Listener de l'étape 4function listenerEtape4(identifiant) {    "use strict";    chargeTicketLot(4, identifiant);    // Sélection d'une famille de consommables    $('.carte-consommable-reference').off("click.carteconsommablereference'").on("click.carteconsommablereference", function(e) {        var id_consommable = parseInt($(this).data('id-consommable'));        // Gestion des erreurs        if (id_consommable === 0 || isNaN(id_consommable) || id_consommable === undefined) {            alert("ERREUR !\r\nIdentification du consommable impossible...\r\nCode erreur : LIVSUHLI");            return false;        } // FIN gestion des erreurs        var stock_restant = parseInt($(this).find('.stock-restant').text());        if (stock_restant === 0) { return false; }        // On décompte une unité du stock + histo        var ifa = $(this).find('i.fa');        ifa.removeClass('fa-cart-arrow-down').addClass('fa-spin fa-spinner');        var objDom = $(this);        $.fn.ajax({            'rep_script_execute': "../scripts/ajax/",            'script_execute': 'fct_consommables.php',            'arguments': 'mode=stockFront&id_consommable='+id_consommable,            'callBack': function(retour) {                var ifaRetour = 'fa-cart-arrow-down';                retour+= ''; // Debug mauvaise interprétation de retours                if(isNaN(retour) || retour === '') {                   alert('ATTENTION !\r\nUne erreur est survenue...\r\nCode erreur : ' + retour);                } else {                    // On affiche le nouveau stock dans la carte                    objDom.find('.stock-restant').text(parseInt(retour));                    // SI on arrive en rupture de stock restant                    if (parseInt(retour) < 1) {                        objDom.find('.alerte-zero-stock').removeClass('d-none');                        objDom.find('.card-footer .btn').removeClass('btn-info').addClass('btn-danger');                        ifaRetour = 'fa-ban';                    } // FIN test out of stock                } // FIN gestion du retour en erreur ou pas                // On recharge le ticket                chargeTicketLot(4, identifiant);                // On affiche l'animation check ok                ifa.removeClass('fa-spin fa-spinner').addClass('fa-check');                setTimeout(function(){                    ifa.removeClass('fa-check').addClass(ifaRetour);                }, 500);            } // FIN callback        }); // FIN aJax    }); // FIN sélection d'un type de consommable} // FIN listener etape// Listener du Ticketfunction listenerTicketLot(identifiant) {    "use strict";    // Bouton "autres consommables"    $('.btnConsommables').off("click.btnConsommables'").on("click.btnConsommables", function(e) {        chargeEtape(2, identifiant);    }); // FIN bouton "autres consommables"    // Bouton "Emballages"    $('.btnEmballages').off("click.btnEmballages'").on("click.btnEmballages", function(e) {        chargeEtape(1, identifiant);    }); // FIN bouton "Emballages"    // Bouton retour à la selection du type de consommables (étape 2)    $('.btnRetourEtape2').off("click.btnRetourEtape2'").on("click.btnRetourEtape2", function(e) {        chargeEtape(2, 0);    }); // FIN bouton retour à la selection du type de consommables (étape 2)    // Bouton retour à la selection de la famille de consommables (étape 3)    $('.btnRetourEtape3').off("click.btnRetourEtape3'").on("click.btnRetourEtape3", function(e) {        var id_type_retour = parseInt($(this).data('id-type'));        // Gestion des erreurs        if (id_type_retour === 0 || isNaN(id_type_retour) || id_type_retour === undefined) {            alert("ERREUR !\r\nIdentification du type impossible...\r\nCode erreur : TTEHZNTJ");            return false;        } // FIN gestion des erreurs        chargeEtape(3, id_type_retour);    }); // FIN bouton retour à la selection de la famille de consommables (étape 3)} // FIN listener Ticket// Listener de la modale changement de rouleau (Etape 2)function modalNouvelEmballageFrontEtape2Listener() {    // Sélection d'une famille    $('.carte-new-emb-defaut').off("click.cartenewembdefaut'").on("click.cartenewembdefaut", function(e) {        e.preventDefault();        var id_emb = parseInt($(this).data('id-emballage'));        if (id_emb === undefined || id_emb === 0 || isNaN(id_emb)) { alert("Identifaction de l'emballage impossible.\nCode erreur : VMPJGEOU"); return false; }        // Emballage identifiée, on le définie comme en cours et on recharge l'étape du lot...        $.fn.ajax({            'rep_script_execute': "../scripts/ajax/",            'script_execute': 'fct_emballages.php',            'arguments': 'mode=setNewEmballageEnCours&id_emb='+id_emb+'&code_vue=emb',            'done': function() {                // On ferme la modale                $('#modalNouvelEmballage').modal('hide');                // On met à jour la liste des emballages dans la vue principale (avec le numéro de lot)                //var id_lot  = parseInt($('#numLotTicket').data('id-lot'));                chargeEtape(1, 0);            } // FIN callback        }); // FIN aJax    }); // FIN Sélection d'une famille} // FIN Listener