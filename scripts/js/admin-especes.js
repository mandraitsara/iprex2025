/** ------------------------------------------------------------------------ JS - Espèces Copyright (C) 2018 Intersed http://www.intersed.fr/ ------------------------------------------------------------------------ @author    Cédric Bouillon @copyright Copyright (c) 2018 Intersed @version   1.0 @since     2018 ------------------------------------------------------------------------ */$(document).ready(function() {    "use strict";    // Export PDF    $('.btnExportPdf').click(function() {        var objetDomBtnExport = $(this);        objetDomBtnExport.find('i').removeClass('fa-file-pdf').addClass('fa-spin fa-spinner');        objetDomBtnExport.attr('disabled', 'disabled');        $.fn.ajax({            'script_execute': 'fct_produits.php',            'arguments': 'mode=exportPdf&type=especes',            'callBack' : function (url_fichier) {                objetDomBtnExport.find('i').removeClass('fa-spin fa-spinner').addClass('fa-file-pdf');                objetDomBtnExport.prop('disabled', false);                $('#lienPdf').attr('href', url_fichier);                $('#lienPdf')[0].click();            } // FIN callBack        }); // FIN ajax    }); // FIN bouton PDF    // Affiche la liste des produits (aJax)    chargeListeEspecesProduits();    // Chargement du contenu de la modale Espèces à son ouverture    $('#modalProduitEspece').on('show.bs.modal', function (e) {        // On récupère l'ID        var espece_id = e.relatedTarget.attributes['data-espece-id'] === undefined ? 0 : parseInt(e.relatedTarget.attributes['data-espece-id'].value);        // On récupère le contenu de la modale        $.fn.ajax({            'script_execute': 'fct_produits.php',            'arguments': 'mode=modalProduitEspece&id=' + espece_id,            'callBack': function (retour) {                // On intègre les différents contenus                var retours = retour.toString().split('^');                var titre = retours[0];                var body = retours[1];                var footer = retours[2];                $('#modalProduitEspeceTitre').html(titre);                $('#modalProduitEspeceBody').html(body);                $('#modalProduitEspeceFooter').html(footer);                // Initialisation des outils JS                //$('.selectpicker').selectpicker('render');                $('.togglemaster').bootstrapToggle();                $('[data-toggle="tooltip"]').tooltip();                $('#input_couleur').colorpicker();                // Appel au listener de la modale                produitsEspeceModalListener();            } // FIN Callback        }); // FIN aJax    }); // Fin chargement du contenu de la modale}); // FIN ready/** ****************************************** * Listener de la modale espèce ****************************************** */function produitsEspeceModalListener() {    // --------------------------------    // Bouton Enregistrer    // --------------------------------    $('.btnSaveEspece').off("click.btnsaveespece").on("click.btnsaveespece", function(e) {        e.preventDefault();        // Si le bloc d'alerte de doublon affiché, on le masque (réinitialisation)        if (!$('.doublon').hasClass('d-none')) {            $('.doublon').addClass('d-none')        } // FIN test bloc alerte doublon affiché        // Initialisation des variables        var erreurs             = false;        var champsObligaroires  = ['nom'];        // On boucle sur tous les champs obligatoires        $.each( champsObligaroires, function( key, value ) {                // Si le champ est vide                if ($('#input_'+value).val().length < 1 ) {                    // On affiche l'invalidité sur le champ correspondant (Bootstrap) pendant 3 secondes                    $('#input_'+value).addClass('is-invalid');                    setTimeout(function(){                        $('#input_'+value).removeClass('is-invalid');                    }, 3000);                    // On déclare l'erreur                    erreurs = true;                } // FIN test validité du champ        }); // FIN boucle sur les champs à vérifier        // Si pas d'erreur jusque là on continue...        if (erreurs === false) {            // Vérification qu'il n'existe pas déjà ce nom ou cet agrément (aJax)            var espece_id       = parseInt($('#input_id').val());            var espece_nom      = $('#input_nom').val();            $.fn.ajax({                'script_execute': 'fct_produits.php',                'arguments': 'mode=checkEspecexisteDeja&id='+espece_id+'&nom='+espece_nom,                'callBack': function (retour) {                    // Si on trouve une concordance déjà enregistrée                    if (parseInt(retour) === 1) {                        // On affiche le message de doublon                        if ($('.doublon').hasClass('d-none')) {                            $('.doublon').removeClass('d-none')                        }                        // Sinon, on peux valider l'enregistrement                    } else {                        var nom = $('#formEspeceAddUpd').find('input[name=nom]').val().trim();                        nom = nom.replace('&', '#et#');                        $('#formEspeceAddUpd').find('input[name=nom]').val(nom);                        goAddUpd();                    } // FIN test retour aJax de nom/numagr déjà attribué                } // FIN callback            }); // FIN aJax        } // FIN test pas d'erreur        return false;    }); // FIN bouton Enregistrer    // --------------------------------    // Bouton Supprimer    // --------------------------------    $('.btnSupprimeEspece').off("click.btnsupprimeespece").on("click.btnsupprimeespece", function(e) {        e.preventDefault();        // Si on ne trouve pas l'ID de l'espèce, on ne va pas plus loin...        if ( $('#formEspeceAddUpd').find('input[name=espece_id]') === undefined) { return false; }        // On initialise, formate et contrôle l'ID de l'espece        var id_espece = parseInt($('#formEspeceAddUpd').find('input[name=espece_id]').val());        if (id_espece === 0) { return false; }        // Message de confirmation        var texte = "ATTENTION !\r\nVous allez supprimer une espèce de l'intranet.\r\nLes produits liés seront à reclasser !\r\nContinuer ?";        if (!confirm(texte)) { return false; }        // Confirmation OK, on supprime l'espèce (aJax)        $.fn.ajax({            'script_execute': 'fct_produits.php',            'arguments': 'mode=supprProduitEspece&id_espece='+id_espece,            'callBack': function () {                // On recharge la liste à jour des produits et on ferme la modale.                chargeListeEspecesProduits();                $('#modalProduitEspece').modal('hide');            } // FIN callback        }); // FIN ajax        return false;    }); // FIN bouton supprime} // FIN listener/** ****************************************** * Affiche la liste des espèces ****************************************** */function chargeListeEspecesProduits() {    $.fn.ajax({        'script_execute': 'fct_produits.php',        'arguments': 'mode=showListeProduitsEspeces',        'return_id': 'listeProduitEspeces'    }); // FIN ajax    return true;} // FIN fonction/** ****************************************** * Valide l'enregistrement ****************************************** */function goAddUpd () {    $.fn.ajax({        'script_execute': 'fct_produits.php',        'form_id': 'formEspeceAddUpd',        'callBack': function () {            // on recharge la liste à jour et on ferme la modale            chargeListeEspecesProduits();            $('#modalProduitEspece').modal('hide');        } // FIN callback    }); // FIN ajax    return false;} // FIN fonction