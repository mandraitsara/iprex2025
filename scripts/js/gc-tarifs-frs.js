/** ------------------------------------------------------------------------ JS - Tarifs Fournisseurs Copyright (C) 2020 Intersed http://www.intersed.fr/ ------------------------------------------------------------------------ @author    Cédric Bouillon @copyright Copyright (c) 2020 Intersed @version   1.0 @since     2020 ------------------------------------------------------------------------ */$(document).ready(function() {    "use strict";    // Affiche la liste des fournisseurs (aJax)    chargeListeTarifs();    // Import CSV    $('.btnImportCsv').click(function() {        $.fn.ajax({            'script_execute': 'fct_tarifs.php',            'arguments': 'mode=modaleImportCsvFrs',            'return_id': 'modalImportTarifsBody',            'done': function () {                $('#modalImportTarifs').modal('show');                modaleImportCsvListener();            } // FIN callBack        }); // FIN ajax    }); // FIN import CSV    // Export PDF    $('.btnExportCsv').click(function() {        var objetDomBtnExport = $(this);        objetDomBtnExport.find('i').removeClass('fa-file-csv').addClass('fa-spin fa-spinner');        objetDomBtnExport.attr('disabled', 'disabled');        $.fn.ajax({            'script_execute': 'fct_tarifs.php',            'arguments': 'mode=exportFrsCsv',            'callBack' : function (url_fichier) {                url_fichier+= '';                objetDomBtnExport.find('i').removeClass('fa-spin fa-spinner').addClass('fa-file-csv');                objetDomBtnExport.prop('disabled', false);                if (url_fichier.slice(0,4) !== 'http') { alert('ERREUR\r\nLe fichier n\'a pas pu être généré...');return false; }                $('#lienExport').attr('href', url_fichier);                $('#lienExport')[0].click();            } // FIN callBack        }); // FIN ajax    }); // FIN bouton PDF    // Export PDF    $('.btnExportPdf').click(function() {        var objetDomBtnExport = $(this);        objetDomBtnExport.find('i').removeClass('fa-file-pdf').addClass('fa-spin fa-spinner');        objetDomBtnExport.attr('disabled', 'disabled');        $.fn.ajax({            'script_execute': 'fct_tarifs.php',            'arguments': 'mode=exportPdf&type=frs',            'callBack' : function (url_fichier) {                url_fichier+= '';                objetDomBtnExport.find('i').removeClass('fa-spin fa-spinner').addClass('fa-file-pdf');                objetDomBtnExport.prop('disabled', false);                if (url_fichier.slice(0,4) !== 'http') { alert('ERREUR\r\nLe fichier n\'a pas pu être généré...');return false; }                $('#lienExport').attr('href', url_fichier);                $('#lienExport')[0].click();            } // FIN callBack        }); // FIN ajax    }); // FIN bouton PDF    // Chargement du contenu de la modale à son ouverture    $('#modalTarif').on('shown.bs.modal', function (e) {        // On récupère l'ID        var id = e.relatedTarget.attributes['data-id'] === undefined ? 0 : parseInt(e.relatedTarget.attributes['data-id'].value);        // On récupère le contenu de la modale        $.fn.ajax({            'script_execute': 'fct_tarifs.php',            'arguments': 'mode=modalTarifFrs&id=' + id,            'callBack': function (retour) {                // On intègre les différents contenus                var retours = retour.toString().split('^');                var titre = retours[0];                var body = retours[1];                var footer = retours[2] !== undefined ? retours[2] : '';                $('#modalTarifTitre').html(titre);                $('#modalTarifBody').html(body);                if (footer.substr(0,9) !== 'hideSuppr') {                    $('.btnSupprimerTarif').show();                } else {                    $('.btnSupprimerTarif').hide();                }                // Initialisation des outils JS                $('#modalTarif .selectpicker').selectpicker('render');                $('.togglemaster').bootstrapToggle();                $('[data-toggle="tooltip"]').tooltip();                // Appel au listener de la modale                tarifsModalListener();            } // FIN Callback        }); // FIN aJax    }); // Fin chargement du contenu de la modale    // Nettoyage du contenu de la modale à sa fermeture    $('#modalTarif').on('hidden.bs.modal', function (e) {        $('#modalTarifTitre').html('<i class="fa fa-spin fa-spinner fa-2x"></i>');        $('#modalTarifBody').html('<i class="fa fa-spin fa-spinner fa-2x"></i>');        $('.btnSupprimerTarif').hide();    }); // FIN fermeture modale Détails    // Nettoyage du contenu de la modale à sa fermeture    $('#modalImportTarifs').on('hidden.bs.modal', function (e) {        $('#modalImportTarifsBody').html('<i class="fa fa-spin fa-spinner fa-2x"></i>');    }); // FIN fermeture modale Détails}); // FIN ready/** ****************************************** * Listener de la modale Tarifs ****************************************** */function tarifsModalListener() {    // --------------------------------    // Bouton Enregistrer    // --------------------------------    $('.btnSaveTarif').off("click.btnSaveTarif").on("click.btnSaveTarif", function(e) {        e.preventDefault();        goAddUpd();        return false;    }); // FIN bouton Enregistrer    // --------------------------------    // Bouton Supprimer    // --------------------------------    $('.btnSupprimerTarif').off("click.btnSupprimerTarif").on("click.btnSupprimerTarif", function(e) {        e.preventDefault();        // On initialise, formate et contrôle l'ID        var id_tarif = parseInt($('#modalTarifBody').find('input[name=id_tarif]').val());        if (id_tarif === 0 || isNaN(id_tarif)) { return false; }        // Message de confirmation        var texte = "ATTENTION !\r\nVous allez supprimer un tarif de l'intranet.\r\nContinuer ?";        if (!confirm(texte)) { return false; }        // Confirmation OK, on supprime le tarif (aJax)        $.fn.ajax({            'script_execute': 'fct_tarifs.php',            'arguments': 'mode=supprTarifFrs&id_tarif='+id_tarif,            'callBack': function () {                // On recharge la liste à jour et on ferme la modale.                chargeListeTarifs();                $('#modalTarif').modal('hide');            } // FIN callback        }); // FIN ajax        return false;    }); // FIN bouton supprime} // FIN listener/** ****************************************** * Affiche la liste des tarifs ****************************************** */function chargeListeTarifs() {    "use strict";    var id_frs  =  $('#filtres select[name=filtre_frs]').val();    var id_pdt  =  $('#filtres select[name=filtre_pdt]').val();    var page    =  $('#filtres input[name=page]').val();    if (id_frs === undefined) { id_frs = 0; }    if (id_pdt === undefined) { id_pdt = 0; }    if (page   === undefined) { page   = 1; }    $.fn.ajax({        'script_execute': 'fct_tarifs.php',        'arguments': 'mode=showlisteTarifsFournisseur&id_frs='+id_frs+'&id_pdt='+id_pdt+'&page='+page,        'return_id': 'listeTarifs',        'done': function () {            listeTarifsListener();        } // FIN callback    }); // FIN ajax    return true;} // FIN fonction/** ****************************************** * Valide l'enregistrement ****************************************** */function goAddUpd () {    $.fn.ajax({        'script_execute': 'fct_tarifs.php',        'form_id': 'modalTarifBody',        'callBack': function () {            // on recharge la liste à jour et on ferme la modale            chargeListeTarifs();            $('#modalTarif').modal('hide');        } // FIN callback    }); // FIN ajax    return false;} // FIN fonction/** ****************************************** * Listener de la liste des tarifs ****************************************** */function listeTarifsListener() {    "use strict";    $('#filtres .selectpicker').selectpicker('render');    // RAZ filtres    $('#filtres .btnRaz').off("click.btnRaz").on("click.btnRaz", function(e) {        e.preventDefault();        $('#filtres select[name=filtre_frs]').selectpicker('val', 0);        $('#filtres select[name=filtre_pdt]').selectpicker('val', 0);        chargeListeTarifs();    }); // FIN Raz    // RAZ vide    $('.btnRazVide').off("click.btnRazVide").on("click.btnRazVide", function(e) {        e.preventDefault();        chargeListeTarifs();    }); // FIN Raz    // Recherche    $('.btnRecherche').click(function() {        chargeListeTarifs();    }); // FIN bouton recherche    $('form#filtres').submit(function() {        return false;    });    // Pagination Ajax    $(document).on('click','#listeTarifs .pagination li a',function(){        if ($(this).attr('data-url') === undefined) { return false; }        // on affiche le loading d'attente        $('#listeTarifs').html('<i class="fa fa-spin fa-spinner fa-2x"></i>');        // on fait l'appel ajax qui va rafraichir la liste        $.fn.ajax({script_execute:'fct_tarifs.php'+$(this).attr('data-url'),return_id:'listeTarifs'});        // on désactive le lien hypertexte        return false;    }); // FIN pagination ajax} // FIN fonction/** ****************************************** * Listener de la modale import tarifs CSV ****************************************** */function modaleImportCsvListener() {    "use strict";    $('.icheck').iCheck({radioClass: 'iradio_square-blue'});    $('#modalImportTarifsBody .selectpicker').selectpicker('render');    $(".custom-file-input").on("change", function() {        var fichier  = $(this).val().split("\\").pop();        var extension = fichier.substr(fichier.length-4);        if (extension !== '.csv') {            alert("Format de fichier incorrect !\r\n\r\nSélectionnez un fichier CSV.\r\n\r\nSous Excel, choisissez le type de fichier « CSV (séparateur : point-virgule) (*.csv) » ");            return false;        }        $(this).siblings(".custom-file-label").addClass("selected").html(fichier);    });    // --------------------------------    // Bouton Importer    // --------------------------------    $('.btnGoImport').off("click.btnGoImport").on("click.btnGoImport", function(e) {        e.preventDefault();        // On vérifie qu'on a bien un fichier et qu'on a bien sélectionné un fournisseur        var fichier = $(".custom-file-input").val().split("\\").pop();        var extension = fichier.substr(fichier.length-4);        if (extension !== '.csv') {            alert("Sélectionnez un fichier à traiter...");            return false;        }        // On vérifie qu'on a bien sélectionné un fournisseur        var frs = parseInt($('select[name=id_frs]').val());        if (isNaN(frs) || frs === 0) {            alert("Sélectionnez un fournisseur...");            return false;        }        $(this).find('i.fa').removeClass('fa-cogs').addClass('fa-spin fa-spinner disabled');        $(this).attr('disabled', 'disabled');        // Ok, on soumet le formulaire...        $('#formImportCsv').submit();        return false;    }); // FIN bouton import} // FIN listener