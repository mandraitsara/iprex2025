/** ------------------------------------------------------------------------ JS - Emballages Copyright (C) 2018 Intersed http://www.intersed.fr/ ------------------------------------------------------------------------ @author    Cédric Bouillon @copyright Copyright (c) 2018 Intersed @version   1.0 @since     2018 ------------------------------------------------------------------------ */$(document).ready(function() {    "use strict";    // Affiche la liste des  d'emballages (aJax)    chargeListeEmballages();    // Export PDF    $('.btnExportPdf').click(function() {        var objetDomBtnExport = $(this);        objetDomBtnExport.find('i').removeClass('fa-file-pdf').addClass('fa-spin fa-spinner');        objetDomBtnExport.attr('disabled', 'disabled');        $.fn.ajax({            'script_execute': 'fct_emballages.php',            'arguments': 'mode=exportPdf&type=lots',            'callBack' : function (url_fichier) {                objetDomBtnExport.find('i').removeClass('fa-spin fa-spinner').addClass('fa-file-pdf');                objetDomBtnExport.prop('disabled', false);                $('#lienPdf').attr('href', url_fichier);                $('#lienPdf')[0].click();            } // FIN callBack        }); // FIN ajax    }); // FIN bouton PDF    // Chargement du contenu de la modale Emballage à son ouverture    $('#modalDefectueux').on('show.bs.modal', function (e) {        // On récupère l'ID de l'utilisateur.        var emballage_id = e.relatedTarget.attributes['data-id-emb'] === undefined ? 0 : parseInt(e.relatedTarget.attributes['data-id-emb'].value);        // On récupère le contenu de la modale        $.fn.ajax({            'script_execute': 'fct_emballages.php',            'arguments': 'mode=modalDefectueux&id=' + emballage_id,            'callBack': function (retour) {                // On intègre les différents contenus                var retours = retour.toString().split('^');                var titre = retours[0];                var body = retours[1];                $('#modalDefectueuxTitre').html(titre);                $('#modalDefectueuxBody').html(body);            }        }); // FIN Ajax    }); // FIN modale détail défectueux        // Chargement du contenu de la modale Emballage à son ouverture    $('#modalEmballage').on('show.bs.modal', function (e) {        // On récupère l'ID de l'utilisateur.        var emballage_id = e.relatedTarget.attributes['data-emballage-id'] === undefined ? 0 : parseInt(e.relatedTarget.attributes['data-emballage-id'].value);        // On récupère le contenu de la modale        $.fn.ajax({            'script_execute': 'fct_emballages.php',            'arguments': 'mode=modalEmballage&id=' + emballage_id,            'callBack': function (retour) {                // On intègre les différents contenus                var retours = retour.toString().split('^');                var titre = retours[0];                var body = retours[1];                var footer = retours[2];                $('#modalEmballageTitre').html(titre);                $('#modalEmballageBody').html(body);                $('#modalEmballageFooter').html(footer);                // Initialisation des outils JS                $('.selectpicker').selectpicker('render');                $('.togglemaster').bootstrapToggle();                $('[data-toggle="tooltip"]').tooltip();                $(".datepicker").datepicker({                    dateFormat:      "dd/mm/yy",                    dayNames:        ["Dimanche", "Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi"],                    dayNamesMin:     ["Di", "Lu", "Ma", "Me", "Je", "Ve", "Sa"],                    dayNamesShort:   ["Dim", "Lun", "Mar", "Mer", "Jeu", "Ven", "Sam"],                    firstDay:        1,                    monthNames:      ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"],                    monthNamesShort: ["Jan", "Fév", "Mar", "Avr", "Mai", "Juin", "Juil", "Août", "Sep", "Oct", "Nov", "Déc"],                    nextText:        "Mois suivant",                    prevText:        "Mois précédent"                }); // FIN DatePicker                // Appel au listener de la modale                emballageModalListener();            } // FIN Callback        }); // FIN aJax    }); // Fin chargement du contenu de la modale    // Nettoyage du contenu de la modale Détails à sa fermeture    $('#modalEmballage').on('hidden.bs.modal', function (e) {        $('#modalEmballageTitre').html('<i class="fa fa-spin fa-spinner fa-2x"></i>');        $('#modalEmballageBody').html('<i class="fa fa-spin fa-spinner fa-2x"></i>');        $('#modalEmballageFooter').html('<i class="fa fa-spin fa-spinner fa-2x"></i>');    }); // FIN fermeture modale Détails    // Nettoyage du contenu de la modale Défectueux à sa fermeture    $('#modalDefectueux').on('hidden.bs.modal', function (e) {        $('#modalDefectueuxTitre').html('<i class="fa fa-spin fa-spinner fa-2x"></i>');        $('#modalDefectueuxBody').html('<i class="fa fa-spin fa-spinner fa-2x"></i>');    }); // FIN fermeture modale Défectueux    // Recherche    $('.btnRecherche').click(function() {        $.fn.ajax({            'script_execute': 'fct_emballages.php',            'form_id': 'filtres',            'return_id': 'listeEmballages',            'done': function () {                listeEmballagesListener();            } // FIN Callback        }); // FIN ajax    }); // FIN bouton recherche    $('form#filtres input[type=text]').keyup(function (e) {        var code = (e.keyCode ? e.keyCode : e.which);        if (code === 13) {            e.preventDefault();            $('.btnRecherche').trigger('click');            return false;        }    });    $('form#filtres').submit(function() {        return false;    });}); // FIN ready/** ****************************************** * Listener de la modale emballage ****************************************** */function emballageModalListener() {    // --------------------------------    // Bouton Enregistrer    // --------------------------------    $('.btnsaveConsommable').off("click.btnsaveConsommable").on("click.btnsaveConsommable", function(e) {        e.preventDefault();        // Si le bloc d'alerte de doublon affiché, on le masque (réinitialisation)        if (!$('.doublon').hasClass('d-none')) {            $('.doublon').addClass('d-none')        } // FIN test bloc alerte doublon affiché        // Initialisation des variables        var erreurs             = false;        //var champsObligaroires  = ['id_famille','id_fournisseur', 'numlot_frs', 'nspe'];        var champsObligaroires  = ['id_famille','id_fournisseur', 'numlot_frs'];        // On boucle sur tous les champs obligatoires        $.each( champsObligaroires, function( key, value ) {                // Si le champ est vide                if ($('#input_'+value).val().length < 1 || $('#input_'+value).val() === '') {                    if (value === 'id_famille') { value = 'id_famille_fb'; }                    if (value === 'id_fournisseur') { value = 'id_fournisseur_fb'; }                    // On affiche l'invalidité sur le champ correspondant (Bootstrap) pendant 3 secondes                    $('#input_'+value).addClass('is-invalid');                    setTimeout(function(){                        $('#input_'+value).removeClass('is-invalid');                    }, 3000);                    // On déclare l'erreur                    erreurs = true;                } // FIN test validité du champ        }); // FIN boucle sur les champs à vérifier        // Si pas d'erreur jusque là on continue...        if (erreurs === false) {            // Vérification qu'il n'existe pas déjà ce nspe (aJax)            var emb_id       = parseInt($('#input_id').val());            var emb_nspe      = $('#input_nspe').val();/*            $.fn.ajax({                'script_execute': 'fct_emballages.php',                'arguments': 'mode=checkExisteDeja&id='+emb_id+'&nspe='+emb_nspe,                'callBack': function (retour) {                    // Si on trouve une concordance déjà enregistrée                    if (parseInt(retour) === 1) {                        // On affiche le message de doublon                        if ($('.doublon').hasClass('d-none')) {                            $('.doublon').removeClass('d-none')                        }                        // Sinon, on peux valider l'enregistrement                    } else {                        goAddUpd();                    } // FIN test retour aJax de nom/numagr déjà attribué                } // FIN callback            }); // FIN aJax*/            goAddUpd();        } // FIN test pas d'erreur        return false;    }); // FIN bouton Enregistrer    // --------------------------------    // Bouton Supprimer    // --------------------------------    $('.btnSupprimeEmballage').off("click.btnsupprimeemballage").on("click.btnsupprimeemballage", function(e) {        e.preventDefault();        // Si on ne trouve pas l'ID de l'emballage, on ne va pas plus loin...        if ( $('#formEmballageAddUpd').find('input[name=emballage_id]') === undefined) { return false; }        // On initialise, formate et contrôle l'ID de l'emballage        var id_emballage_ = parseInt($('#formEmballageAddUpd').find('input[name=emballage_id]').val());        if (id_emballage_ === 0) { return false; }        // Message de confirmation        var texte = "ATTENTION !\r\nVous allez sortir cet emballage de l'intranet.\r\nContinuer ?";        if (!confirm(texte)) { return false; }        // Confirmation OK, on supprime l'emballage (aJax)        $.fn.ajax({            'script_execute': 'fct_emballages.php',            'arguments': 'mode=supprEmballage&id_emballage='+id_emballage_,            'callBack': function () {                // On recharge la liste à jour des emballages et on ferme la modale.                chargeListeEmballages();                $('#modalEmballage').modal('hide');            } // FIN callback        }); // FIN ajax        return false;    }); // FIN bouton supprime} // FIN listener/** ****************************************** * Affiche la liste des emballages ****************************************** */function chargeListeEmballages() {    var filtre_ref = $('input[name=filtre_ref]').val();    var filtre_frs = $('select[name=filtre_frs]').val();    var filtre_famille = $('select[name=filtre_famille]').val();    $.fn.ajax({        'script_execute': 'fct_emballages.php',        'arguments': 'mode=showListeEmballages&filtre_ref='+filtre_ref+'&filtre_frs='+filtre_frs+'&filtre_famille='+filtre_famille,        'return_id': 'listeEmballages',        'done' : function() {            listeEmballagesListener();        }    }); // FIN ajax    return true;} // FIN fonction/** ****************************************** * Valide l'enregistrement ****************************************** */function goAddUpd () {    $.fn.ajax({        'script_execute': 'fct_emballages.php',        'form_id': 'formEmballageAddUpd',        'callBack': function () {            // on recharge la liste à jour et on ferme la modale            chargeListeEmballages();            $('#modalEmballage').modal('hide');        } // FIN callback    }); // FIN ajax    return false;} // FIN fonction/** ****************************************** * Listener de la liste d'emballages ****************************************** */function listeEmballagesListener() {    $('.icheck').iCheck({radioClass: 'iradio_square-blue'});    // Pagination Ajax    $(document).on('click','#listeEmballages .pagination li a',function(){        if ($(this).attr('data-url') === undefined) { return false; }        // on affiche le loading d'attente        $('#listeProduits').html('<i class="fa fa-spin fa-spinner fa-2x"></i>');        // on fait l'appel ajax qui va rafraichir la liste        $.fn.ajax({script_execute:'fct_emballages.php'+$(this).attr('data-url'),return_id:'listeEmballages'});        // on désactive le lien hypertexte        return false;    }); // FIN pagination ajax    // Sélection d'un emballage par défaut    $('.checkEmbDefaut').on('ifChecked', function(event){        var id_emb = parseInt($(this).data('id-emb'));        $.fn.ajax({            'script_execute': 'fct_emballages.php',            'arguments': 'mode=setNewEmballageEnCours&id_emb='+id_emb        }); // FIN aJax        return false;    }); // FIN selection d'un emballage par défaut} // FIN fonction