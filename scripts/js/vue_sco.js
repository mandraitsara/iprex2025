/** ------------------------------------------------------------------------ JS - Vue Scellés colis Copyright (C) 2018 Intersed http://www.intersed.fr/ ------------------------------------------------------------------------ @author    Cédric Bouillon @copyright Copyright (c) 2018 Intersed @version   1.0 @since     2018 ------------------------------------------------------------------------ */$('document').ready(function() {    "use strict";    chargeEtape(1, 0);}); // FIN ready// Fonction chargeant les étapes pour intégrer leur contenufunction chargeEtape(numeroEtape, identifiant) {    $('.etapes-suivantes').hide('fast');    // Ajax qui charge le contenu de l'étape    $('#etape'+numeroEtape).show('fast');    $('#etape'+numeroEtape).html('<div class="padding-50 text-center"><i class="fa fa-spin fa-spinner fa-5x gris-c"></i></div>');    $.fn.ajax({        'rep_script_execute': "../scripts/ajax/", // Gestion de l'URL Rewriting        'script_execute': 'fct_vue_sco.php',        'arguments': 'mode=chargeEtapeVue&etape=' + numeroEtape + '&id='+identifiant,        'return_id': 'etape'+numeroEtape,        'done': function () {            var fctnom = "listenerEtape"+numeroEtape;            var fn  = window[fctnom];            fn(identifiant);        } // FIN Callback    }); // FIN ajax} // FIN fonction chargeEtape// Charge le Ticket (maj)function chargeTicketLot(etape, identifiant) {    // Ajax qui charge le contenu du ticket    $.fn.ajax({        'rep_script_execute': "../scripts/ajax/", // Gestion de l'URL Rewriting        'script_execute': 'fct_vue_sco.php',        'arguments': 'mode=chargeTicketLot&etape='+etape+'&id=' + identifiant,        'return_id': 'ticketLotContent',        'done' : function() {            listenerTicketLot(identifiant);        }    }); // FIN ajax} // FIN fonction// Listener de l'étape 1function listenerEtape1(identifiant) {    "use strict";    chargeTicketLot(1, identifiant);        // Selection de la vue sur carte    $('.carte-lot').off("click.selectcartevue").on("click.selectcartevue", function(e) {        e.preventDefault();        var id_lot = parseInt($(this).data('id-lot'));        if (id_lot === undefined || id_lot === 0 || isNaN(id_lot)) { alert("Une erreur est survenue !\r\nCode erreur : STTXGHAG");return false; }        // Appel étape 2        chargeEtape(2, id_lot);    }); // FIN click vue carte} // FIN listener étape 1// Listener de l'étape 2function listenerEtape2(identifiant) {    "use strict";    chargeTicketLot(2, identifiant);    // Selection d'une catégorie de produit pour affichage des produits correspondants    $('.btnCategorie').off("click.btncategorie").on("click.btncategorie", function(e) {        e.preventDefault();        var id_categorie = parseInt($(this).data('id-categorie'));        if (id_categorie === undefined || id_categorie === 0 || isNaN(id_categorie)) { alert("Identifaction de la catégorie impossible.\nCode erreur : REROUSSA"); return false; }        // Catégorie identifiée, on affiche les produits correspondants        $('#containerCategories .btn').removeClass('btn-success').addClass('btn-secondary');        $(this).removeClass('btn-primary').addClass('btn-success');        $('#containerEtiquettesProduits').html('<div class="col text-center"><i class="fa fa-spin fa-spinner fa-lg gris-9"></i></div>');        $.fn.ajax({            'rep_script_execute': "../scripts/ajax/",            'script_execute': 'fct_produits.php',            'arguments': 'mode=showProduitsCourtsCategorie&id_categorie='+id_categorie,            'return_id' : 'containerEtiquettesProduits',            'done': function() {                nomsCourtsListener();            }        }); // FIN aJax    }); // FIN selection catégorie de produit pour étiquetage} // FIN listener étape 2// Listener des noms courts pour étiquetagefunction nomsCourtsListener() {    "use strict";    // Selection d'un produit pour étiquetage -> quantité ? (modale)    $('.btnNomCourt').off("click.btnnomcourt").on("click.btnnomcourt", function(e) {        e.preventDefault();        $('#modalQuantiteEtiquettesInfo').text('0');        var nom_court = $(this).text().trim();        if (nom_court === undefined || nom_court === '' ) { alert("Récupération du nom court impossible !.\nCode erreur : YNMNTADN"); return false; }        $('#modalQuantiteEtiquettesProduit').text(nom_court);        $('#modalQuantiteEtiquettes').modal('show');    }); // FIN selection d'un produit pour étiquetag    // Pavé numérique quantité à imprimer    $('#modalQuantiteEtiquettes .clavier .btn').off("click.appuietoucheclavier").on("click.appuietoucheclavier", function(e) {        e.preventDefault();        // On récupère la valeur de la touche        var touche = $(this).data('valeur');        var qte = parseInt($('#modalQuantiteEtiquettesInfo').text().trim());        if (isNaN(qte)) {            qte = 0;            $('#modalQuantiteEtiquettesInfo').text(qte);            return false;        }        if (qte === 0 && touche !== 'C' && parseInt(touche) > 0) {            qte =  parseInt(touche);        } else if ( touche !== 'C') {            qte = parseInt(qte.toString() + touche.toString());        } else if (touche === 'C') {            qte = parseInt(qte.toString().slice(0,-1));            if (qte === '' || isNaN(parseInt(qte))) {                qte = 0;            }        }        if (parseInt(qte) > 999) {            return false;        }        $('#modalQuantiteEtiquettesInfo').text(qte);    }); // FIN pavé numérique quantité    // Imprimer étiquettes    $('#modalQuantiteEtiquettes .btn-imprimer-etiquettes').off("click.btnimprimeretiquettes").on("click.btnimprimeretiquettes", function(e) {        e.preventDefault();        var copies = parseInt($('#modalQuantiteEtiquettesInfo').text().trim());        if (isNaN(copies) || copies === 0) { return false; }        var nom_court = $('#modalQuantiteEtiquettesProduit').text().trim();        var id_lot = parseInt($('#numLotTicket').data('id-lot'));        // IMPRESSION        $.fn.ajax({            'rep_script_execute': "../scripts/ajax/",            'script_execute': 'fct_etiquettes.php',            'arguments': 'mode=imprimerEtiquette&nom_court='+nom_court+'&id_lot='+id_lot+'&vue=sco&copies='+copies,            'callBack': function(retour) {                if (retour === '') {                    alert('Impression impossible !');                    return false;                }                var doc = document.getElementById('etiquetteFrame').contentWindow.document;                doc.open();                doc.write(retour);                doc.close();                window.frames["imprimerEtiquette"].focus();                window.frames["imprimerEtiquette"].print();            }        }); // FIN aJax    }); // FIN bouton imprimer étiquettes} // FIN listener des noms courts pour étiquetage// Listener du Ticketfunction listenerTicketLot(identifiant) {    // Retour vers les vues    $('.btnChangeVue').off("click.btnchangevue'").on("click.btnchangevue", function(e) {        e.preventDefault();        chargeEtape(1, 0);    }); // FIN Retour vers les vues} // FIN listener Ticket