/** ------------------------------------------------------------------------ JS - Tarifs Clients Copyright (C) 2020 Intersed http://www.intersed.fr/ ------------------------------------------------------------------------ @author    Cédric Bouillon @copyright Copyright (c) 2020 Intersed @version   1.0 @since     2020 ------------------------------------------------------------------------ */$(document).ready(function() {    "use strict";    // Affiche la liste des clients (aJax)    chargeListeTarifs();    // Import CSV    $('.btnImportCsv').click(function() {        $.fn.ajax({            'script_execute': 'fct_tarifs.php',            'arguments': 'mode=modaleImportCsvClt',            'return_id': 'modalImportTarifsBody',            'done': function () {                $('#modalImportTarifs').modal('show');                modaleImportCsvListener();            } // FIN callBack        }); // FIN ajax    }); // FIN import CSV    // Export CSV    $('.btnExportCsv').click(function() {        var objetDomBtnExport = $(this);        objetDomBtnExport.find('i').removeClass('fa-file-csv').addClass('fa-spin fa-spinner');        objetDomBtnExport.attr('disabled', 'disabled');        $.fn.ajax({            'script_execute': 'fct_tarifs.php',            'arguments': 'mode=exportCltCsv',            'callBack' : function (url_fichier) {                url_fichier+= '';                objetDomBtnExport.find('i').removeClass('fa-spin fa-spinner').addClass('fa-file-csv');                objetDomBtnExport.prop('disabled', false);                if (url_fichier.slice(0,4) !== 'http') { alert('ERREUR\r\nLe fichier n\'a pas pu être généré...');return false; }                $('#lienExport').attr('href', url_fichier);                $('#lienExport')[0].click();            } // FIN callBack        }); // FIN ajax    }); // FIN bouton PDF    // Export PDF    $('.btnExportPdf').click(function() {        var objetDomBtnExport = $(this);        objetDomBtnExport.find('i').removeClass('fa-file-pdf').addClass('fa-spin fa-spinner');        objetDomBtnExport.attr('disabled', 'disabled');        var id_client = parseInt($('select[name=filtre_clt]').val());        if (isNaN(id_client)) { id_client = 0; }        $.fn.ajax({            'script_execute': 'fct_tarifs.php',            'arguments': 'mode=exportPdf&type=clt&id_client='+id_client,            'callBack' : function (url_fichier) {                url_fichier+= '';                objetDomBtnExport.find('i').removeClass('fa-spin fa-spinner').addClass('fa-file-pdf');                objetDomBtnExport.prop('disabled', false);                if (url_fichier.slice(0,4) !== 'http') { alert('ERREUR\r\nLe fichier n\'a pas pu être généré...');return false; }                $('#lienExport').attr('href', url_fichier);                $('#lienExport')[0].click();            } // FIN callBack        }); // FIN ajax    }); // FIN bouton PDF    // Chargement du contenu de la modale à son ouverture    $('#modalTarif').on('shown.bs.modal', function (e) {        // On récupère l'ID        var id = e.relatedTarget.attributes['data-id'] === undefined ? 0 : parseInt(e.relatedTarget.attributes['data-id'].value);        // On récupère le contenu de la modale        $.fn.ajax({            'script_execute': 'fct_tarifs.php',            'arguments': 'mode=modalTarifClt&id=' + id,            'callBack': function (retour) {                // On intègre les différents contenus                var retours = retour.toString().split('^');                var titre = retours[0];                var body = retours[1];                var footer = retours[2] !== undefined ? retours[2] : '';                $('#modalTarifTitre').html(titre);                $('#modalTarifBody').html(body);                if (footer.substr(0,9) !== 'hideSuppr') {                    $('.btnSupprimerTarif').show();                } else {                    $('.btnSupprimerTarif').hide();                }                // Initialisation des outils JS                $('#modalTarif .selectpicker').selectpicker('render');                $('.togglemaster').bootstrapToggle();                $('[data-toggle="tooltip"]').tooltip();                // Appel au listener de la modale                tarifsModalListener();            } // FIN Callback        }); // FIN aJax    }); // Fin chargement du contenu de la modale    // Chargement du contenu de la modale à son ouverture    $('#modalEnvoiMail').on('shown.bs.modal', function (e) {        // On récupère l'ID        var id_client = e.relatedTarget.attributes['data-id-client'] === undefined ? 0 : parseInt(e.relatedTarget.attributes['data-id-client'].value);        if (isNaN(id_client) || id_client === 0) { alert('Identification du client impossible !');return false; }        $.fn.ajax({            'script_execute': 'fct_tarifs.php',            'arguments': 'mode=modalEnvoiMail&id_client='+id_client,            'return_id': 'modalEnvoiMailBody',            'done': function () {                $('.selectpicker').selectpicker('render');                $('.togglemaster').bootstrapToggle();                $('.btnEnvoiMail').off("click.btnEnvoiMail").on("click.btnEnvoiMail", function(e) {                    e.preventDefault();                    var id_client =$('#modalEnvoiMailBody .idclt').val();                    var id_ctc = $('#modalEnvoiMailBody select').val();                    var cc = $('#modalEnvoiMailBody .togglemaster').is(':checked') ? 1 : 0;                    if (isNaN(id_client)) { alert('Identification du client impossible !');return false; }                    $.fn.ajax({                        'script_execute': 'fct_tarifs.php',                        'arguments': 'mode=envoiPdfClient&id_client=' + id_client+'&id_ctc='+id_ctc+'&cc='+cc,                        'callBack': function (retour) {                            retour+='';                            if (parseInt(retour) === 1) {                                $('#modalEnvoiMail').modal('hide');                                //alert("Les tarifs client sont en cours d'envoi.");                            } else {                                alert("Envoi des tarifs échoué !");                            }                           return false;                        }                    }); // FIN ajax                }); // Fin bouton envoi            } // FIN done        });// FIN ajax    }); // Fin chargement du contenu de la modale    // Nettoyage du contenu de la modale à sa fermeture    $('#modalTarif').on('hidden.bs.modal', function (e) {        $('#modalTarifTitre').html('<i class="fa fa-spin fa-spinner fa-2x"></i>');        $('#modalTarifBody').html('<i class="fa fa-spin fa-spinner fa-2x"></i>');        $('.btnSupprimerTarif').hide();    }); // FIN fermeture modale Détails    // Nettoyage du contenu de la modale à sa fermeture    $('#modalImportTarifs').on('hidden.bs.modal', function (e) {        $('#modalImportTarifsBody').html('<i class="fa fa-spin fa-spinner fa-2x"></i>');    }); // FIN fermeture modale Détails    // Nettoyage du contenu de la modale à sa fermeture    $('#modalEnvoiMail').on('hidden.bs.modal', function (e) {        $('#modalEnvoiMailBody').html('<i class="fa fa-spin fa-spinner fa-2x"></i>');    }); // FIN fermeture modale Détails    // --------------------------------    // Bouton Enregistrer Tarifs    // --------------------------------    $('.btnSaveTousTarifs').off("click.btnSaveTarifs").on("click.btnSaveTarifs", function(e) {        e.preventDefault();        var btnHtml = $(this).html();        $.fn.ajax({            'script_execute': 'fct_tarifs.php',            'form_id': 'formTarifsClients',            'callBack': function (retour) {                retour+='';                if (parseInt(retour) !== 1) { alert('Enregistrement échoué !'); return false; }                $('.btnSaveTousTarifs').blur();                $('.btnSaveTousTarifs').html('<i class="fa fa-check fa-fw fa-lg mr-2"></i>Enregistré !</i>');                setTimeout(function(){                    $('.btnSaveTousTarifs').html(btnHtml);                }, 1500);            } // FIN callback        }); // FIN ajax    }); // FIN bouton enregistre tous les tarifs    // Sélection des produits pour un client fixe    $('.btnSelectionPdtsClientFixe').off("click.btnselectionpdtsclientfixe").on("click.btnselectionpdtsclientfixe", function(e) {        e.preventDefault();        var id_client_fixe = parseInt($('#clientFixe').val());        if (isNaN(id_client_fixe)) { id_client_fixe = 0; }        if (id_client_fixe === 0) { alert('Identification du client impossible !'); return false; }        var ifa = $(this).find('i.fa');        ifa.removeClass('fa-check-square').addClass('fa-spin fa-spinner');        $(this).blur();        $.fn.ajax({            'script_execute': 'fct_tarifs.php',            'arguments': 'mode=selectionPdtsClient&id_client='+id_client_fixe,            'return_id': 'listeTarifs',            'done': function() {                ifa.removeClass('fa-spin fa-spinner').addClass('fa-check-square');                $('.boutons-droite').hide();                $('.boutons-droite-selpdt').show();                $("input[type=checkbox].icheck").iCheck(                    {checkboxClass: "icheckbox_square-blue"}                );                // Recherche                $("#ctrlf").on("keyup", function() {                    var rech = $(this).val();                    $("#selectPdts4clt tr").each(function(index) {                        if (index !== 0) {                            var ligne = $(this);                            var id = ligne.find("td:first").text()+' '+ligne.find("td").eq(1).text();                            if (id.indexOf(rech.toUpperCase()) === -1) {                                ligne.hide();                            } else {                                ligne.show();                            }                        }                    });                });                $('.btnSaveAssoPdtClt').click(function () {                    var objDom =  $(this).find('i.fa');                    objDom.removeClass('fa-save').addClass('fa-spin fa-spinner');                    $.fn.ajax({                        'script_execute': 'fct_tarifs.php',                        'form_id': 'assoPdtClt',                        'done': function () {                            objDom.removeClass('fa-spin fa-spinner').addClass('fa-save');                            $('.boutons-droite-selpdt').hide();                            $('.boutons-droite').show();                            $('#listeTarifs').html('<i class="fa fa-spin fa-spinner"></i>');                            chargeListeTarifs();                        }                    });                });                $('#selectPdts4clt thead th').click(function () {                    var colonne = parseInt($(this).data('colonne'));                    if (isNaN(colonne)) { colonne = 2; }                    if (colonne === 2) { return false; }                    sortTable(colonne);                });            } // FIN done        }); // FIN ajax    }); // FIN sélection des produits pour un client fixe}); // FIN ready/** ****************************************** * Listener de la modale Tarifs ****************************************** */function tarifsModalListener() {    "use strict";    // Empèche une boucle infinie entre les déclancheurs d'évènement de SelectPicker    var skipAuto = false;    // Si on sélectionne un client, on raz le groupe    $('select[name=id_clt]').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {        e.stopImmediatePropagation();        if (skipAuto) { skipAuto = false; return false; }        skipAuto = true; // Bloque la propagation du selectpicker (boucle infinie)        $('select[name=id_grp]').selectpicker('val', 0);    });    // Et inversement    $('select[name=id_grp]').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {        e.stopImmediatePropagation();        if (skipAuto) { skipAuto = false; return false; }        skipAuto = true; // Bloque la propagation du selectpicker (boucle infinie)        $('select[name=id_clt]').selectpicker('val', 0);    });    // --------------------------------    // Bouton Enregistrer    // --------------------------------    $('.btnSaveTarif').off("click.btnSaveTarif").on("click.btnSaveTarif", function(e) {        e.preventDefault();        goAddUpd();        return false;    }); // FIN bouton Enregistrer    // --------------------------------    // Bouton Supprimer    // --------------------------------    $('.btnSupprimerTarif').off("click.btnSupprimerTarif").on("click.btnSupprimerTarif", function(e) {        e.preventDefault();        // On initialise, formate et contrôle l'ID        var id_tarif = parseInt($('#modalTarifBody').find('input[name=id_tarif]').val());        if (id_tarif === 0 || isNaN(id_tarif)) { return false; }        // Message de confirmation        var texte = "ATTENTION !\r\nVous allez supprimer un tarif de l'intranet.\r\nContinuer ?";        if (!confirm(texte)) { return false; }        // Confirmation OK, on supprime le tarif (aJax)        $.fn.ajax({            'script_execute': 'fct_tarifs.php',            'arguments': 'mode=supprTarifClt&id_tarif='+id_tarif,            'callBack': function () {                // On recharge la liste à jour et on ferme la modale.                chargeListeTarifs();                $('#modalTarif').modal('hide');            } // FIN callback        }); // FIN ajax        return false;    }); // FIN bouton supprime} // FIN listener/** ****************************************** * Affiche la liste des tarifs ****************************************** */function chargeListeTarifs() {    "use strict";    var id_client_fixe = parseInt($('#clientFixe').val());    if (isNaN(id_client_fixe)) { id_client_fixe = 0; }    var id_clt  =  id_client_fixe === 0 ? $('#filtres select[name=filtre_clt]').val() : id_client_fixe;    var id_grp  =  $('#filtres select[name=filtre_grp]').val();    var id_pdt  =  $('#filtres select[name=filtre_pdt]').val();    var page    =  $('#filtres input[name=page]').val();    var fixe    = id_client_fixe > 0 ? 1 : 0;    if (id_clt === undefined) { id_clt = 0; }    if (id_grp === undefined) { id_grp = 0; }    if (id_pdt === undefined) { id_pdt = 0; }    if (page   === undefined) { page   = 1; }    $.fn.ajax({        'script_execute': 'fct_tarifs.php',        'arguments': 'mode=showlisteTarifsClient&id_clt='+id_clt+'&id_grp='+id_grp+'&id_pdt='+id_pdt+'&page='+page+'&fixe='+fixe,        'return_id': 'listeTarifs',        'done': function () {            listeTarifsListener();        } // FIN callback    }); // FIN ajax    return true;} // FIN fonction/** ****************************************** * Valide l'enregistrement ****************************************** */function goAddUpd () {    $.fn.ajax({        'script_execute': 'fct_tarifs.php',        'form_id': 'modalTarifBody',        'callBack': function () {            // on recharge la liste à jour et on ferme la modale            chargeListeTarifs();            $('#modalTarif').modal('hide');        } // FIN callback    }); // FIN ajax    return false;} // FIN fonction/** ****************************************** * Listener de la liste des tarifs ****************************************** */function listeTarifsListener() {    "use strict";    $('#filtres .selectpicker').selectpicker('render');    // RAZ filtres    $('#filtres .btnRaz').off("click.btnRaz").on("click.btnRaz", function(e) {        e.preventDefault();        $('#filtres select[name=filtre_clt]').selectpicker('val', 0);        $('#filtres select[name=filtre_grp]').selectpicker('val', 0);        $('#filtres select[name=filtre_pdt]').selectpicker('val', 0);        chargeListeTarifs();    }); // FIN Raz    // RAZ vide    $('.btnRazVide').off("click.btnRazVide").on("click.btnRazVide", function(e) {        e.preventDefault();        chargeListeTarifs();    }); // FIN Raz    // Recherche    $('.btnRecherche').click(function() {        chargeListeTarifs();    }); // FIN bouton recherche    $('form#filtres').submit(function() {        return false;    });    // --------------------------------    // Bouton Supprimer tarif    // --------------------------------    $('.btnSupprTarifClient').off("click.btnSupprTarifClient").on("click.btnSupprTarifClient", function(e) {        e.preventDefault();        var id_tarif = parseInt($(this).data('id'));        if (isNaN(id_tarif)) { id_tarif = 0; }        if (id_tarif === 0) { alert("Identification du tarif impossible !"); return false; }        $(this).find('i.fa').removeClass('fa-trash-alt').addClass('fa-spin fa-spinner');        $.fn.ajax({            'script_execute': 'fct_tarifs.php',            'arguments': 'mode=supprTarifClient&id_tarif='+id_tarif,            'done': function () {                chargeListeTarifs();            } // FIN callback        }); // FIN ajax    }); // FIN bouton enregistre tous les tarifs    // Pagination Ajax    $(document).on('click','#listeTarifs .pagination li a',function(){        if ($(this).attr('data-url') === undefined) { return false; }        // on affiche le loading d'attente        $('#listeTarifs').html('<i class="fa fa-spin fa-spinner fa-2x"></i>');        // on fait l'appel ajax qui va rafraichir la liste        $.fn.ajax({script_execute:'fct_tarifs.php'+$(this).attr('data-url'),return_id:'listeTarifs'});        // on désactive le lien hypertexte        return false;    }); // FIN pagination ajax} // FIN fonction/** ****************************************** * Listener de la modale import tarifs CSV ****************************************** */function modaleImportCsvListener() {    "use strict";    $('.icheck').iCheck({radioClass: 'iradio_square-blue'});    $('#modalImportTarifsBody .selectpicker').selectpicker('render');    // Empèche une boucle infinie entre les déclancheurs d'évènement de SelectPicker    var skipAuto = false;    // Si on sélectionne un client, on raz le groupe    $('#modalImportTarifsBody select[name=id_clt]').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {        e.stopImmediatePropagation();        if (skipAuto) { skipAuto = false; return false; }        skipAuto = true; // Bloque la propagation du selectpicker (boucle infinie)        $('#modalImportTarifsBody select[name=id_grp]').selectpicker('val', 0);    });    // Et inversement    $('#modalImportTarifsBody select[name=id_grp]').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {        e.stopImmediatePropagation();        if (skipAuto) { skipAuto = false; return false; }        skipAuto = true; // Bloque la propagation du selectpicker (boucle infinie)        $('#modalImportTarifsBody select[name=id_clt]').selectpicker('val', 0);    });    $(".custom-file-input").on("change", function() {        var fichier  = $(this).val().split("\\").pop();        var extension = fichier.substr(fichier.length-4);        if (extension !== '.csv') {            alert("Format de fichier incorrect !\r\n\r\nSélectionnez un fichier CSV.\r\n\r\nSous Excel, choisissez le type de fichier « CSV (séparateur : point-virgule) (*.csv) » ");            return false;        }        $(this).siblings(".custom-file-label").addClass("selected").html(fichier);    });    // --------------------------------    // Bouton Importer    // --------------------------------    $('.btnGoImport').off("click.btnGoImport").on("click.btnGoImport", function(e) {        e.preventDefault();        // On vérifie qu'on a bien un fichier et qu'on a bien sélectionné un client ou un groupe        var fichier = $(".custom-file-input").val().split("\\").pop();        var extension = fichier.substr(fichier.length-4);        if (extension !== '.csv') {            alert("Sélectionnez un fichier à traiter...");            return false;        }        // On vérifie qu'on a bien sélectionné un client ou un groupe        var clt  = parseInt($('select[name=id_clt]').val());        var grp  = parseInt($('select[name=id_grp]').val());        if ((isNaN(clt) || clt === 0) && (isNaN(grp) || grp === 0)) {            alert("Sélectionnez un client ou un groupe de clients...");            return false;        }        $(this).find('i.fa').removeClass('fa-cogs').addClass('fa-spin fa-spinner disabled');        $(this).attr('disabled', 'disabled');        // Ok, on soumet le formulaire...        $('#formImportCsv').submit();        return false;    }); // FIN bouton import} // FIN listenerfunction sortTable(n) {    "use strict";    var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;    table = document.getElementById("selectPdts4clt");    switching = true;    // Set the sorting direction to ascending:    dir = "asc";    /* Make a loop that will continue until    no switching has been done: */    while (switching) {        // Start by saying: no switching is done:        switching = false;        rows = table.rows;        /* Loop through all table rows (except the        first, which contains table headers): */        for (i = 1; i < (rows.length - 1); i++) {            // Start by saying there should be no switching:            shouldSwitch = false;            /* Get the two elements you want to compare,            one from current row and one from the next: */            x = rows[i].getElementsByTagName("TD")[n];            y = rows[i + 1].getElementsByTagName("TD")[n];            /* Check if the two rows should switch place,            based on the direction, asc or desc: */            if (dir == "asc") {                if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {                    // If so, mark as a switch and break the loop:                    shouldSwitch = true;                    break;                }            } else if (dir == "desc") {                if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {                    // If so, mark as a switch and break the loop:                    shouldSwitch = true;                    break;                }            }        }        if (shouldSwitch) {            /* If a switch has been marked, make the switch            and mark that a switch has been done: */            rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);            switching = true;            // Each time a switch is done, increase this count by 1:            switchcount ++;        } else {            /* If no switching has been done AND the direction is "asc",            set the direction to "desc" and run the while loop again. */            if (switchcount == 0 && dir == "asc") {                dir = "desc";                switching = true;            }        }    }}