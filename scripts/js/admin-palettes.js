/** ------------------------------------------------------------------------ JS - Palettes Copyright (C) 2019 Intersed http://www.intersed.fr/ ------------------------------------------------------------------------ @author    Cédric Bouillon @copyright Copyright (c) 2018 Intersed @version   1.0 @since     2018 ------------------------------------------------------------------------ */$(document).ready(function() {    "use strict";    // Affiche la liste des palettes    chargeListePalettes();    // Export PDF    $('.btnExportPdf').click(function() {        var objetDomBtnExport = $(this);        objetDomBtnExport.find('i').removeClass('fa-file-pdf').addClass('fa-spin fa-spinner');        objetDomBtnExport.attr('disabled', 'disabled');        $.fn.ajax({            'script_execute': 'fct_palettes.php',            'arguments': 'mode=exportPdf',            'callBack' : function (url_fichier) {                objetDomBtnExport.find('i').removeClass('fa-spin fa-spinner').addClass('fa-file-pdf');                objetDomBtnExport.prop('disabled', false);                $('#lienPdf').attr('href', url_fichier);                $('#lienPdf')[0].click();            } // FIN callBack        }); // FIN ajax    }); // FIN bouton PDF    // Recherche    $('.btnRecherche').click(function() {        $.fn.ajax({            'script_execute': 'fct_palettes.php',            'form_id': 'filtres',            'return_id': 'listePalettes',            'done': function (retour) {                listePalettesListener();            } // FIN Callback        }); // FIN ajax    }); // FIN bouton recherche    $('form#filtres input[type=text]').keyup(function (e) {        var code = (e.keyCode ? e.keyCode : e.which);        if (code === 13) {            e.preventDefault();            $('.btnRecherche').trigger('click');            return false;        }    });    $('form#filtres').submit(function() {        return false;    });    // Nettoyage du contenu de la modale à sa fermeture    $('#modalPalette').on('hidden.bs.modal', function (e) {        $('#modalPaletteTitre').html('<i class="fa fa-spin fa-spinner fa-2x"></i>');        $('#modalPaletteBody').html('<i class="fa fa-spin fa-spinner fa-2x"></i>');        // On raffraichit aussi la liste        chargeListePalettes();    }); // FIN fermeture modale    // Réinitialisation des numéros de palette    $('.btnReinitPalettes').click(function() {        if (!confirm("CONFIRMATION\r\nVous allez réinitialiser les prochains numéros de palettes à 1.\r\nContinuer ?")) { return false; }        $.fn.ajax({            'script_execute': 'fct_palettes.php',            'arguments': 'mode=reinitNumeros',            'callBack' : function(retour) {                if (parseInt(retour) !== 1) {                    alert("ERREUR !\r\nEchec lors de la réinitilisation des numéros de palettes...\r\nCode erreur : QJEBMXMN");                    return false;                }                alert('Les numéros de palette ont bien été réinitialisés.');            }        }); // FIN ajax    }); // FIN bouton réinitialisation des numéros de palette}); // FIN ready/** ****************************************** * Affiche la liste des palettes ****************************************** */function chargeListePalettes() {    $.fn.ajax({        'script_execute': 'fct_palettes.php',        'form_id': 'filtres',        'return_id': 'listePalettes',        'done' : function() {            listePalettesListener();        }    }); // FIN ajax    return true;} // FIN fonction/** ****************************************** * Listener de la liste des palettes ****************************************** */function listePalettesListener() {    "use strict";    // Pagination Ajax    $(document).on('click','#listePalettes .pagination li a',function(){        if ($(this).attr('data-url') === undefined) { return false; }        // On met à jour le numéro de page dans les filtres        var page = $(this).attr('data-url').substr($(this).attr('data-url').indexOf("&page=") + 6);        $('#filtres input[name=page]').val(page);        // on affiche le loading d'attente        $('#listePalettes').html('<i class="fa fa-spin fa-spinner fa-2x"></i>');        // on fait l'appel ajax qui va rafraichir la liste        $.fn.ajax({            'script_execute': 'fct_palettes.php'+$(this).attr('data-url'),            'return_id': 'listePalettes',            'done' : function() {                listePalettesListener();            }        });        // on désactive le lien hypertexte        return false;    }); // FIN pagination ajax    // Modale    $('.btnEditPalette').off("click.btneditpalette").on("click.btneditpalette", function(e) {        e.preventDefault();        var id_palette = $(this).data('id-palette');        chargeModaleEditPalette(id_palette);    }); // FIn modale} // FIN listener liste palettes/** ****************************************** * Charge le contenu de la modal Edit Palette ****************************************** */function chargeModaleEditPalette(id_palette) {    // On récupère le contenu de la modale    $.fn.ajax({        'script_execute': 'fct_palettes.php',        'arguments': 'mode=modalPalette&id=' + id_palette,        'callBack': function (retour) {            // On intègre les différents contenus            var retours = retour.toString().split('^');            var titre = retours[0];            var body = retours[1];            $('#modalPaletteTitre').html(titre);            $('#modalPaletteBody').html(body);            // Initialisation des outils JS            $('.selectpicker').selectpicker('render');            $('.togglemaster').bootstrapToggle();            $('#modalPalette').modal('show');            // Appel au listener de la modale            modalPaletteListener();        } // FIN Callback    }); // FIN aJax} // FIN chargement modale Edit Palette/** ****************************************** * Listener de la modale palette ****************************************** */function modalPaletteListener() {    // --------------------------------    // Change statut    // --------------------------------    $('#changeStatutPalette').on('changed.bs.select', function () {        var statut = parseInt($(this).val());        if (isNaN(statut)) { alert("ERREUR ! \r\nIdentification du statut impossible...\r\nCode erreur : O0DNF14M");return false; }        var id_palette = parseInt($(this).data('id-palette'));        if (isNaN(id_palette) || id_palette === 0 ) { alert("ERREUR ! \r\nIdentification de la palette impossible...\r\nCode erreur : UHRF74NU");return false; }        // On récupère le contenu de la modale        $.fn.ajax({            'script_execute': 'fct_palettes.php',            'arguments': 'mode=changeStatutPalette&id_palette=' + id_palette + '&statut='+statut,            'callBack': function (retour) {                if (parseInt(retour) !== 1) {                    alert("ERREUR !\r\nEchec lors du changement des statut...\r\nCode erreur : SM33VRUY");                    return false;                }                $('#modifOk').fadeIn('fast');                setTimeout(function() { $('#modifOk').fadeOut('slow'); }, 2000);            } // FIN callback        }); // FIN ajax    }); // FIN change statut    // --------------------------------    // Bouton Enregistrer compo    // --------------------------------    $('.btnSaveCompo').off("click.btnSaveCompo").on("click.btnSaveCompo", function(e) {        var domifa = $(this).find('i.fa');        domifa.removeClass('fa-check').addClass('fa-spin fa-spinner');        var id_compo    = parseInt($(this).parents('tr').data('id-palette-composition'));        var id_client   = parseInt($(this).parents('tr').find('select[name=id_client]').val());        var id_produit  = parseInt($(this).parents('tr').find('select[name=id_produit]').val());        var nb_colis    = parseInt($(this).parents('tr').find('input[name=nb_colis]').val());        var poids       = parseFloat($(this).parents('tr').find('input[name=poids]').val());        $.fn.ajax({            'script_execute': 'fct_palettes.php',            'arguments': 'mode=modifComposition&id_compo=' + id_compo+'&id_client='+id_client+'&id_produit='+id_produit+'&poids='+poids+'&nb_colis='+nb_colis,            'callBack': function (retour) {                domifa.removeClass('fa-spin fa-spinner').addClass('fa-check');                if (parseInt(retour) !== 1) {                    alert("ERREUR !\r\nEchec lors de l'enregistrement des modifications...\r\nVérifiez la validité des données saisies.\r\nCode erreur : NBB8PL9G");                    return false;                }                chargeListePalettes();            } // FIN callback        }); // FIN aJax    }); // FIN bouton Enregistrer    // --------------------------------    // Bouton Supprimer compo    // --------------------------------    $('.btnSupprCompo').off("click.btnSupprCompo").on("click.btnSupprCompo", function(e) {        e.preventDefault();        if (!confirm("ATTENTION !\r\nVous allez supprimer le contenu d'une palette...\r\nContinuer ?")) { return false; }        var id_compo    = parseInt($(this).parents('tr').data('id-palette-composition'));        var id_palette  = parseInt($('#formPaletteUpd').find('input[name=id_palette]').val());        $.fn.ajax({            'script_execute': 'fct_palettes.php',            'arguments': 'mode=supprimeComposition&id_compo=' + id_compo,            'callBack': function (retour) {                if (parseInt(retour) !== 1) {                    alert("ERREUR !\r\nEchec lors de la suppression...\r\nCode erreur : G95R35ES");                    return false;                }                chargeModaleEditPalette(id_palette);                chargeListePalettes();            } // FIN callback        }); // FIN aJax    }); // FIN bouton supprime compo    // Bouton Supprimer palette vide    // --------------------------------    // --------------------------------    $('.btnSupprimerPaletteVide').off("click.btnSupprimerPaletteVide").on("click.btnSupprimerPaletteVide", function(e) {        e.preventDefault();        var id_palette  = parseInt($('#formPaletteUpd').find('input[name=id_palette]').val());        $.fn.ajax({            'script_execute': 'fct_palettes.php',            'arguments': 'mode=supprimePaletteVide&id_palette=' + id_palette,            'callBack': function (retour) {                if (parseInt(retour) !== 1) {                    alert("ERREUR !\r\nEchec lors de la suppression...\r\nCode erreur : N0S58N49");                    return false;                }                $('#modalPalette').modal('hide');            } // FIN callback        }); // FIN aJax    }); // FIN bouton supprime compo} // FIN listener