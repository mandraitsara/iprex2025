<?phpini_set('display_errors' ,1);/* ****************************************************************************** *  TACHE CRON *  Purge et archive des logs de plus de X jours * *  (c) Cédric Bouillon 2019 *  INTERSED ****************************************************************************** */require_once dirname( __FILE__ ).'/../php/config.cli.php';require_once dirname( __FILE__ ).'/../../class/Cron.class.php';require_once dirname( __FILE__ ).'/../../class/CronsManager.class.php';require_once dirname( __FILE__ ).'/../../class/Log.class.php';require_once dirname( __FILE__ ).'/../../class/LogManager.class.php';$cronsManager = new CronsManager($cnx);$cron = $cronsManager->getCronByFileName(basename(__FILE__));if (!$cron instanceof Cron) { exit('Non déclaré en BSDD'); }if (!$cron->isActif()) { exit('Inactif'); }$cron->setExecution(date('Y-m-d H:i:s'));$cronsManager->saveCron($cron);/* ****************************************************************************** *  PARAMETRES ****************************************************************************** */$rootPath = dirname( __FILE__ ).'/../../../saves/bizerba/';$maxJours = 90;$nom_cron = 'Purge des fichiers archivés transmis à BizTrack';/* ****************************************************************************** *  FIN PARAMETRES ****************************************************************************** */$show_debug = isset($_REQUEST['show_debug']);if ($show_debug) { ?>    <!DOCTYPE html><html>    <head>        <meta charset="utf-8"/>        <meta name="robots" content="noindex, nofollow">        <title>iPrex</title>        <style type="text/css">            body { font-family: "Courier New", Courier, monospace; margin: 0; padding: 10px; }            body * { padding: 0;}        </style>    </head>    <body>    <h1>CRON iPrex</h1><hr>    <h2><?php echo $nom_cron; ?></h2><hr><?php }$fichierZip = 'BIZERBA-'.date('Ymd').'.zip';$zipPath = $rootPath;$zip = new ZipArchive();$zip->open($zipPath.$fichierZip, ZipArchive::CREATE);$filesToDelete = [];$files = glob($rootPath."*.TXT");$dtJour = new DateTime(date('Y-m-d'));foreach ($files as $filePath) {    $relativePath   = substr($filePath, strlen($rootPath) + 1);	$dateFichier    = substr($relativePath, 2,8);	$dtFichier      = DateTime::createFromFormat('Ymd', $dateFichier);	$abs_diff       = intval($dtJour->diff($dtFichier)->format("%a"));	if ($abs_diff < $maxJours) { continue; }	$zip->addFile($filePath, $relativePath);	$filesToDelete[] = $filePath;}$zip->close();foreach ($filesToDelete as $file){	unlink($file);}if (!empty($filesToDelete)) {	$logsManager = new LogManager($cnx);	$log = new Log();	$log->setLog_type('info');	$log->setLog_texte("[CRON] - Purge des fichiers archivés transmis à BizTrack de plus de ".$maxJours." jours.");	$logsManager->saveLog($log);}if ($show_debug) {    echo '-- Traitement terminé --';?>    </body>    </html><?php }