<?phpini_set('display_errors' ,1);/* ****************************************************************************** *  TACHE CRON *  Alter table des décimales à 2 chifres * *  (c) Cédric Bouillon 2021 *  Koesio ****************************************************************************** */require_once dirname( __FILE__ ).'/../php/config.php';?><!doctype html><html lang="en"><head>	<meta charset="UTF-8">	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">	<meta http-equiv="X-UA-Compatible" content="ie=edge">	<title>IPREX CRON DEBUG</title>	<style>        body {            background: #333;            color: #fff;            font-family: "Courier New", Courier, monospace;            font-size: .8em;        }	</style></head><body>	<pre style="font-size: 1.2em;color:lawngreen">######################################  _____ _____  _____  ________   __ |_   _|  __ \|  __ \|  ____\ \ / /   | | | |__) | |__) | |__   \ V /   | | |  ___/|  _  /|  __|   > <  _| |_| |    | | \ \| |____ / . \ |_____|_|    |_|  \_\______/_/ \_\###################################### > Console debug CRON > CWF Framework @ Cédric Bouillon 2021-2022######################################</pre><h1>Réintégration des compos supprimées par John </h1>	<h2>Via la douchette (frais) alors que déjà intégrées à un BL</h2>	<h3>On ne recrée pas le frais, on crée les compos hors stock</h3><hr><?php $finHtml = '</body></html>';// On recherche toutes les données manquantes...$query_liste= 'SELECT bll.id_lot, bll.numlot, bl.id, bl.num_bl, bll.id_compo, bll.date_add AS date, bll.id AS id_ligne_bl,					bl.id_tiers_facturation AS id_client, bll.poids, bll.nb_colis, bll.id_produit, bll.id_palette						FROM pe_bl_lignes bll 							JOIN pe_bl bl ON bl.id = bll.id_bl							LEFT JOIN pe_palette_composition pc ON pc.id = bll.id_compo						WHERE bll.id_compo > 0							AND pc.id IS NULL						ORDER BY bll.date_add DESC';$query = $cnx->prepare($query_liste);$query->execute();$liste = [];$donnees = $query->fetchAll(PDO::FETCH_ASSOC);if (!$donnees) { echo 'ERREUR SQL ! <br>'.$query_liste.$finHtml; exit; }if (empty($donnees)) { echo 'Aucune composition manquante. [OK] <br>'.$query_liste.$finHtml; exit; }$erreurs = [];$ok = [];foreach ($donnees as $donnee) {	$query_add = 'INSERT IGNORE INTO `pe_palette_composition` 					(`id`,										 `id_client`,								 `date`,									 `poids`,									 `id_produit`,								 `nb_colis`,								 `id_palette`,											 `id_user`,									 `id_lot_pdt_froid`,						 `id_lot_hors_stock`,						 `id_frais`,								 `id_lot_regroupement`,						 `archive`,						 `supprime`					 ) VALUES ('.intval($donnee['id_compo']).',					  '.intval($donnee['id_client']).', 					  "'.$donnee['date'].'",					   '.floatval($donnee['poids']).', 					   '.intval($donnee['id_produit']).', 					   '.intval($donnee['nb_colis']).', 					   '.intval($donnee['id_palette']).', 					   23,					   0,					   '.intval($donnee['id_lot']).', 					   0,					   0,					   1,					   1					  ) ';	$query = $cnx->prepare($query_add);	if (!$query->execute()) {		$erreurs[] = $donnee;	} else {		$ok[] = $donnee;	}} // FIN boucleif (!empty($erreurs)) {	echo '<h2>ERREURS ('.count($erreurs).' compo non créées)</h2>';	foreach ($erreurs as $e) {		echo '<kbd>#'.$e['id_compo'].'</kbd>&nbsp;';	}}if (!empty($ok)) {	echo '<h2>OK : '.count($erreurs).' compo(s) recrée(s)</h2>';	foreach ($erreurs as $e) {		echo '<kbd>#'.$e['id_compo'].'</kbd>&nbsp;';	}}// FINecho $finHtml;