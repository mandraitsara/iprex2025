<?phpini_set('display_errors' ,1);/* ****************************************************************************** *  TACHE CRON *  Purge des documents supprimés de plus d'un mois * *  (c) Cédric Bouillon 2019 *  INTERSED ****************************************************************************** */$skipAuth = true;require_once dirname( __FILE__ ).'/../php/config.cli.php';require_once dirname( __FILE__ ).'/../../class/Cron.class.php';require_once dirname( __FILE__ ).'/../../class/CronsManager.class.php';require_once dirname( __FILE__ ).'/../../class/Log.class.php';require_once dirname( __FILE__ ).'/../../class/LogManager.class.php';$cronsManager = new CronsManager($cnx);$cron = $cronsManager->getCronByFileName(basename(__FILE__));if (!$cron instanceof Cron) { exit('Non déclaré en BSDD'); }if (!$cron->isActif()) { exit('Inactif'); }$cron->setExecution(date('Y-m-d H:i:s'));$cronsManager->saveCron($cron);/* ****************************************************************************** *  PARAMETRES ****************************************************************************** */$mail_admin = 'pole-web@intersed.fr';$nom_cron	= 'Purge des documents supprimés de plus d\'un mois';$root	= dirname( __FILE__ ).'/../../uploads/';/* ****************************************************************************** *  FIN PARAMETRES ****************************************************************************** */$show_debug = isset($_REQUEST['show_debug']);if ($show_debug) { ?>	<!DOCTYPE html><html>	<head>		<meta charset="utf-8"/>		<meta name="robots" content="noindex, nofollow">		<title>iPrex</title>		<style type="text/css">			body { font-family: "Courier New", Courier, monospace; margin: 0; padding: 10px; }			body * { padding: 0;}		</style>	</head>	<body>	<h1>CRON iPrex</h1><hr>	<h2><?php echo $nom_cron; ?></h2><hr><?php }// On récup la liste de tous les documents supprimés$query_liste = 'SELECT `id`, `filename`, `lot_id` FROM `pe_documents` WHERE `supprime` = 1 AND `date` < NOW() - INTERVAL 1 MONTH ';$query = $cnx->prepare($query_liste);$query->execute();$ids2purge = [];// boucle sur les documents à purgerforeach ($query->fetchAll(PDO::FETCH_ASSOC) as $purge_doc) {	$purge_chemin = $root.$purge_doc['lot_id'].'/'.$purge_doc['filename'];	// Si le fichier existe pas (O_o) on passe au suivant...	if (!file_exists($purge_chemin)) { continue; }	// Si erreur lors de la suppression, on passe au suivant...	if (!unlink($purge_chemin)) { continue; }	// Si la purge s'est bien passée, on l'ajoute à la liste des ID à supprimer	$ids2purge[] = $purge_doc['id'];} // FIN boucle sur les documents$logsManager = new LogManager($cnx);// On supprime les ID en BDDif (!empty($ids2purge)) {	$ids = implode(',', $ids2purge);	if (strlen($ids) < 1) 		{ exit; }	$query_del = 'DELETE FROM `pe_documents` WHERE `id` IN ('.$ids.')';	$query = $cnx->prepare($query_del);	if (!$query->execute()) {		if ($show_debug) {			echo "<p>Echec de la suppression en BDD. Fichier bien supprimés sur le serveur.</p>";		} else {			$email_from = 'contact@profilexport.fr';            envoiMail(['pole-web@intersed.fr'], $email_from, "ERREUR CRON IPREX", utf8_decode("[CRON] - Purge des documents supprimés de plus d'un mois<br>ECHEC DE LA SUPPRESSION EN BDD !<br>Fichiers supprimés sur le serveur."));        }	} else if ($show_debug) {		echo "<p>Terminé : ".count($ids2purge)." document(s) purgé(s).</p>";	} else if (!$show_debug) {        echo "[CRON] - Purge de ".count($ids2purge)." document(s) supprimé(s) de plus d'un mois.";		$log = new Log();		$log->setLog_type('success');		$log->setLog_texte("[CRON] - Purge de ".count($ids2purge)." document(s) supprimé(s) de plus d'un mois.");		$logsManager->saveLog($log);	}} else  {	echo "<p>Terminé, aucun document à purger.</p>";} // FIN IDs à supprimer en baseif ($show_debug) { ?>	</body></html><?php }