<?php/*   _|_|_|  _|_|_|    _| _|        _|    _|  _|        CBO FrameWork _|        _|_|_|    _|        (c) 2019 Cédric Bouillon _|        _|    _|  _|   _|_|_|  _|_|_|    _|_|_|_|--------------------------------------------------------Contrôleur Ajax API------------------------------------------------------*///ini_set('display_errors',1);// Initialisation du mode d'appel$mode       = isset($_REQUEST['mode']) ? $_REQUEST['mode'] : '';// Intégration de la configuration du FrameWork et des autorisationsrequire_once '../php/config.php';require_once '../../api/inc.config.php';require_once '../../api/AppAPI.class.php';$apiManager = new AppAPI($cnx);if (!$apiManager instanceof AppAPI) { echo '-1'; exit; }$fonctionNom = 'mode'.ucfirst($mode);if (function_exists($fonctionNom)) {		$fonctionNom();}/* ------------------------------------MODE - Prendre Photos (iPrex)------------------------------------*/function modePrendrePhotos() {	global $cnx;    $id_lot = isset($_REQUEST['id_lot']) ? $_REQUEST['id_lot'] : 0;	$id_vue = isset($_REQUEST['id_vue']) ? $_REQUEST['id_vue'] : 0;    if ($id_lot == 0) { echo '-1'; exit; }    $id_lots = explode(',', $id_lot);    if (is_array($id_lots) && !empty($id_lots) && isset($id_lots[1])) {		foreach ($id_lots as $id_lot) {			prendrePhotoLot($id_lot, $id_vue);    	}	} else {		prendrePhotoLot($id_lot, $id_vue);	}	// Log	$log = new Log([]);	$log->setLog_type('info');	$log->setLog_texte("[FO] Appel à l'APK Photo App depuis la vue ID " . $id_vue . " sur lot(s) ID " . $id_lot) ;	$logsManager = new LogManager($cnx);	$logsManager->saveLog($log);	exit;} // FIN modefunction prendrePhotoLot($id_lot, $id_vue) {	global $cnx, $apiManager;	$lotsManager = new LotManager($cnx);	$lot = $lotsManager->getLot($id_lot);	if (!$lot instanceof Lot) { echo '-1'; exit; }	// Si un token est encore valide pour ce lot, on prolonge la durée du token	if ($apiManager->checkTokenFromLot($lot)) {		// Gestion des erreurs (!)		if (!$apiManager->expendTokenLot($lot)) { echo '-1'; }		// Sinon on crée un token associé à un numéro de lot	} else {		// Gestion des erreurs (!)		if (!$apiManager->initTokenLot($lot, $id_vue)) { echo '-1'; }	} // FIN test token valide pour le lot	return true;}