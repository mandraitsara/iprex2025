<?php/*   _|_|_|  _|_|_|    _| _|        _|    _|  _|        CBO FrameWork _|        _|_|_|    _|        (c) 2018 Cédric Bouillon _|        _|    _|  _|   _|_|_|  _|_|_|    _|_|_|_|--------------------------------------------------------Contrôleur Ajax VUE SCELLES COLIS------------------------------------------------------*/// Initialisation du mode d'appel$mode       = isset($_REQUEST['mode']) ? $_REQUEST['mode'] : '';// Intégration de la configuration du FrameWork et des autorisationsrequire_once '../php/config.php';// Instanciation des Managers$logsManager = new LogManager($cnx);$fonctionNom = 'mode'.ucfirst($mode);if (function_exists($fonctionNom)) {	$fonctionNom();}/* ------------------------------------------FONCTION - Message d'erreur sur ticket lot-------------------------------------------*/function erreurLot() {	?>    <div class="alert alert-danger text-center">        <i class="fa fa-exclamation-triangle fa-3x mb-2"></i><br>        <p>Erreur de récupération du lot !</p>    </div>	<?php	exit;} // FIN fonctions/* ------------------------------------------MODE - Charge le contenu d'une étape de vue-------------------------------------------*/function modeChargeEtapeVue() {	global $utilisateur, $cnx;	$etape  = isset($_REQUEST['etape'])     ? intval($_REQUEST['etape'])            : 0;	$na = '<span class="badge badge-warning badge-pill text-14">Non renseigné</span>';	/** ----------------------------------------	 * DEV - On affiche l'étape pour débug	 *  ----------------------------------- */	if ($utilisateur->isDev()) { ?>        <div class="dev-etape-vue"><i class="fa fa-user-secret fa-lg mr-1"></i>Etape <kbd><?php echo $etape;?></kbd></div>	<?php } // FIN test DEV	/** ----------------------------------------	 * Etape        : 1	 * Description  : Sélection du lot	 *  ----------------------------------- */	if ($etape == 1) {        ?>        <div class="row">            <div class="col mt-3">                <h4><i class="fa fa-angle-down fa-lg ml-2 mr-3"></i>Sélectionnez le lot concerné :</h4>            </div>        </div>        <?php		$lotsManager = new LotManager($cnx);		$listeLot    = $lotsManager->getListeLotsByVue('atl');		// Si aucun lot en atelier		if (empty($listeLot)) { ?>            <div class="col alert alert-secondary mt-3 padding-50">                <h2 class="mb-0 text-secondary text-center"><i class="fa fa-exclamation-circle fa-2x mb-3"></i>                    <p>Aucune lot disponible en atelier&hellip;</p>                </h2>            </div>			<?php		} // FIN test aucun lot atelier		// Boucle sur les lots en atelier		foreach ($listeLot as $lotvue) { ?>            <div class="card text-white mb-3 carte-lot d-inline-block mr-3" style="max-width: 20rem;background-color: <?php echo $lotvue->getCouleur(); ?>" data-id-lot="<?php echo $lotvue->getId(); ?>" data-etape-suivante="2">                <div class="card-header text-36"><?php echo $lotvue->getNumlot(); ?></div>                <div class="card-body">                    <table>                        <tr>                            <td>Espèce</td>                            <th><?php echo $lotvue->getNom_espece($na); ?></th>                        </tr>                        <tr>                            <td>Origine</td>                            <th><?php echo $lotvue->getNom_origine() != '' ? $lotvue->getNom_origine() : $na; ?></th>                        </tr>                        <tr>                            <td>Abattoir</td>                            <th><?php echo $lotvue->getNom_abattoir() != '' ? $lotvue->getNom_abattoir() : $na ; ?></th>                        </tr>                        <tr>                            <td>Réception</td>                            <th><?php echo $lotvue->getDate_reception() != '' && $lotvue->getDate_reception() != '0000-00-00'  ?  Outils::getDate_only_verbose($lotvue->getDate_reception(), true, false) : $na; ?></th>                        </tr>                        <tr>                            <td>Poids</td>                            <th><?php echo $lotvue->getPoids_reception() > 0 ? number_format($lotvue->getPoids_reception(),3, '.', ' ') . ' kgs' : $na; ?></th>                        </tr>                    </table>                </div> <!-- FIN body carte -->            </div> <!-- FIN carte -->			<?php		} // FIN boucle sur les lots en atelier		exit;	} // FIN ETAPE	/** ----------------------------------------	 * Etape        : 2	 * Description  : Sélection du produit	 *  ----------------------------------- */	if ($etape == 2) {	   // On vérifie qu'on a bien un lot valide		$lotManager = new LotManager($cnx);		$id_lot = isset($_REQUEST['id']) ? intval($_REQUEST['id']) : 0;		$lot = $lotManager->getLot($id_lot);		if ($id_lot == 0 || !$lot instanceof Lot) {  exit; }		?>        <div class="row mt-3 align-content-center">        <!-- ETIQUETTES -->            <div class="col-12 text-center" id="etiquettesAtl">                <div class="alert alert-secondary">                    <h4><i class="fa fa-angle-down fa-lg ml-2 mr-3 mb-3"></i>Edition des étiquetages :</h4>                    <div class="row justify-content-md-center" id="containerCategories">                        <?php                        // On récupère les catégories de produit                        $categoriesManager = new ProduitCategoriesManager($cnx);                        $listeCategories = $categoriesManager->getListeProduitCategories();                        // Boucle sur les catégories de produits                        foreach ($listeCategories as $cate) { ?>                            <div class="col-2 mb-3">                               <button type="button" class="btn btn-large btn-primary form-control padding-20-40 text-20 text-uppercase btnCategorie" data-id-categorie="<?php echo $cate->getId(); ?>">                                 <?php echo $cate->getNom(); ?>                               </button>                            </div>                        <?php                        } // FIN boucle sur les catégories                        ?>                    </div>                    <div class="row justify-content-md-center" id="containerEtiquettesProduits"></div>                </div>            </div>        </div>        <?php		exit;	} // FIN ETAPE	exit;} // FIN mode/* ------------------------------------------MODE - Charge le ticket-------------------------------------------*/function modeChargeTicketLot() {	global	$cnx,	$utilisateur;	$etape          = isset($_REQUEST['etape'])     ? intval($_REQUEST['etape'])    : 0;	$identifiant    = isset($_REQUEST['id'])        ? $_REQUEST['id']               : '';	$na  = '<span class="badge badge-warning badge-pill text-14">Non renseigné !</span>';	$err = '<span class="badge danger badge-pill text-14">ERREUR !</span>';	// ETAPE 1 - Sélectionnez un lot	if ($etape == 1) { ?>        <div class="alert alert-secondary text-34 text-center pl-0 pr-0 mb-1" id="numLotTicket" data-id-lot="0">            &mdash;        </div>        <input id="lotid_photo" type="hidden" value="0">        <p class="mt-2 text-center">Sélectionez un lot&hellip;</p>		<?php	} // FIN étape 1	// ETAPE 2	if ($etape == 2) {	    $lotManager = new LotManager($cnx);		$lot = $lotManager->getLot($identifiant);		if ($identifiant == '' || !$lot instanceof Lot) { echo $err; exit; }		$numlotQuantieme =  $lot->getComposition() == 2			? $lot->getNumlot()			: $lot->getNumlot().Outils::getJourAnByDate(date('Y-m-d'));		?>        <div class="alert alert-secondary text-34 text-center pl-0 pr-0 mb-3" id="numLotTicket" data-id-lot=" <?php echo $lot->getId(); ?>">            <?php echo $numlotQuantieme;            // On affiche pas le quantième ici car sur les étiquettes d'exemple, parfois il y est, parfois non et ça va être encore bien compliqué de savoir ce que le client veut...            // On se dit donc qu'on a rien vu, qu'on affiche le numéro de lot sans perdre de temps vu que le temps manque terriblement et que le Xanax ne suffit plus !!! Arrrg...            //. Outils::getJourAnByDate(date('Y-m-d')); ?>        </div>        <input id="lotid_photo" type="hidden" value="<?php echo $lot->getId(); ?>">        <?php        // SI on des incidents...		$incidentsManager = new IncidentsManager($cnx);		if ($incidentsManager->asLotIncidentsCommentaire($lot->getId())) {        ?>        <button type="button" class="btn btn-warning btn-lg form-control btnCommentaires text-left mb-3" data-toggle="modal" data-target="#modalCommentairesFront" data-id-lot="<?php echo $lot->getId(); ?>">            <i class="fa fa-info-circle fa-lg fa-fw vmiddle mr-2"></i>Infos incidents        </button>        <?php } ?>        <!-- Bouton changement de vue -->        <button type="button" class="btn btn-secondary btn-lg form-control btnChangeVue text-left text-18">            <i class="fa fa-undo fa-lg fa-fw vmiddle mr-2"></i>            Retour        </button>		<?php	} // FIN ETAPE} // FIN mode