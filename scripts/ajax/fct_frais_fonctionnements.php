<?php/*   _|_|_|  _|_|_|    _| _|        _|    _|  _|        CBO FrameWork _|        _|_|_|    _|        (c) 2020 Cédric Bouillon _|        _|    _|  _|   _|_|_|  _|_|_|    _|_|_|_|--------------------------------------------------------Contrôleur Ajax Frais de fonctionnement------------------------------------------------------*/// Initialisation du mode d'appel$mode       = isset($_REQUEST['mode']) ? $_REQUEST['mode'] : '';// Intégration de la configuration du FrameWork et des autorisationsrequire_once '../php/config.php';// Instanciation des Managers$fraisFonctionnementManager = new FraisFonctionnementManager($cnx);$logsManager = new LogManager($cnx);$fonctionNom = 'mode'.ucfirst($mode);if (function_exists($fonctionNom)) {	$fonctionNom();}/* ------------------------------------MODE - Modale add/upd------------------------------------*/function modeShowModaleFrais() {    global $logsManager, $fraisFonctionnementManager;    $id = isset($_REQUEST['id']) ? intval($_REQUEST['id']) : 0;    $frais = $id > 0 ? $fraisFonctionnementManager->getFraisFonctionnement($id) : new FraisFonctionnement([]);    if (!$frais instanceof FraisFonctionnement) { $frais = new FraisFonctionnement([]); }    ?>    <input type="hidden" name="mode" value="addUpdFrais"/>    <input type="hidden" name="id" value="<?php echo $frais->getId(); ?>"/>    <div class="row">        <div class="col">            <div class="input-group">                <div class="input-group-prepend">                    <span class="input-group-text">Libellé</span>                </div>                <input type="text" class="datepicker form-control" placeholder="Dénomination du frais" name="nom" value="<?php echo str_replace('"', "''", $frais->getNom()); ?>"/>            </div>        </div>    </div>    <div class="row mt-2">        <div class="col-4">            <div class="input-group">                <div class="input-group-prepend">                    <span class="input-group-text">Montant</span>                </div>                <input type="text" class="datepicker form-control" placeholder="0.00" name="montant" value="<?php echo $frais->getMontant() > 0 ? number_format($frais->getMontant(),2,'.', '') : ''; ?>"/>                <div class="input-group-append">                    <span class="input-group-text">€</span>                </div>            </div>        </div>        <div class="col">            <div class="input-group">                <div class="input-group-prepend">                    <span class="input-group-text">Périodicité</span>                </div>                <select class="selectpicker form-control show-tick" name="periodicite" title="Sélectionnez...">                    <?php                    foreach (FraisFonctionnement::PERIODICITE as $val => $txt) { ?>                        <option value="<?php echo $val; ?>" <?php echo $val == $frais->getPeriodicite() ? 'selected' : ''; ?>><?php echo ucfirst($txt); ?></option>					<?php }                    ?>                </select>            </div>        </div>    </div>    <?php	exit;} // FIN mode// Affiche la liste des frais de fonctionnementsfunction modeShowListeFrais() {    global $fraisFonctionnementManager, $utilisateur;    ?>    <table class="table table-v-middle admin">        <thead>        <tr>            <th class="<?php echo $utilisateur->isDev() ? '' : 'd-none'; ?> w-mini-admin-cell">ID</th>            <th>Libellé</th>            <th>Montant</th>            <th>Périodicité</th>            <th class="t-actions w-court-admin-cell">Activation</th>            <th class="t-actions w-mini-admin-cell">Modifier</th>        </tr>        </thead>        <tbody>		<?php		$liste = $fraisFonctionnementManager->getListeFraisFonctionnement();		if (empty($liste)) { ?>            <tr>                <td colspan="<?php echo $utilisateur->isDev() ? 6 : 5; ?>">                    <div class="alert alert-warning padding-50 text-center">                        <i class="fa fa-exclamation-circle fa-3x mb-2"></i>                        <p class="mb-0 text-20">Aucun frais de fonctionnement n'est défini.</p>                    </div>                </td>            </tr>		<?php } else {			foreach ($liste as $frais) { ?>                <tr>                    <td class="<?php echo $utilisateur->isDev() ? '' : 'd-none'; ?>"><code><?php echo $frais->getId(); ?></code></td>                    <td><?php echo $frais->getNom(); ?></td>                    <td><?php echo number_format($frais->getMontant(),2,'.', ' '); ?> €</td>                    <td><?php echo ucfirst(FraisFonctionnement::PERIODICITE[$frais->getPeriodicite()]);?></td>                    <td class="t-actions">                        <input type="checkbox" class="togglemaster" data-toggle="toggle" name="activation"							<?php echo $frais->isActif() ? 'checked' : ''; ?>                               data-on="Activé"                               data-off="Désactivé"                               data-onstyle="success"                               data-offstyle="danger"                        />                    </td>                    <td class="t-actions"><button type="button" class="btn btn-secondary btnEditFrais"><i class="fa fa-edit"></i></button></td>                </tr>			<?php }		}		?>        </tbody>    </table>    <div class="mb-2 alert alert-info texte-fin">        <i class="fa fa-info-circle mr-1"></i> Ces frais entrent dans le calcul des marges nettes.    </div>    <?php    exit;} // FIN mode// Add/upd frais fonctionnementfunction modeaddUpdFrais() {	global $fraisFonctionnementManager, $cnx;	$id = isset($_REQUEST['id']) ? intval($_REQUEST['id']) : 0;	$frais = $id > 0 ? $fraisFonctionnementManager->getFraisFonctionnement($id) : new FraisFonctionnement([]);	if (!$frais instanceof FraisFonctionnement) { exit("ERR_OBJ_FRAISFONCTINNEMENT"); }	$nom = isset($_REQUEST['nom']) ? Outils::decodeCharAjac($_REQUEST['nom']) : '';	$montant = isset($_REQUEST['montant']) ? floatval($_REQUEST['montant']) : 0;	$periodicite = isset($_REQUEST['periodicite']) ? intval($_REQUEST['periodicite']) : 0;	if ($nom == '') { exit("ERR_NOM_VIDE"); }	if ($montant <=0) { exit("ERR_MONTANT"); }	if ($periodicite < 0) { exit("ERR_PERIODICITE"); }    $frais->setNom($nom);	$frais->setMontant($montant);	$frais->setPeriodicite($periodicite);	$retourSave = $fraisFonctionnementManager->saveFraisFonctionnement($frais);	if ($retourSave == false) { exit("ERR_SAVE_OBJ");}	$logManager = new LogManager($cnx);	$log = new Log([]);	$log->setLog_type('info');	$logTxt = $id > 0 ? 'Modification du frais de fonctionnement #ID' . $id : 'Création nouveau frais de fonctionnement ID #' . intval($retourSave);	$log->setLog_texte($logTxt);	$logManager->saveLog($log);	exit('1'); // Retour positif} // FIN mode// Supprime un frais de fonctionnementfunction modeSupprFrais() {    global $fraisFonctionnementManager, $cnx;	$id = isset($_REQUEST['id']) ? intval($_REQUEST['id']) : 0;	if ($id == 0) { exit("ERR_ID_ZERO"); }	$frais = $fraisFonctionnementManager->getFraisFonctionnement($id);	if (!$frais instanceof FraisFonctionnement) { exit("ERR_OBJ_FRAISFONCTINNEMENT"); }	$frais->setSupprime(1);	$frais->setActivation(0);	if (!$fraisFonctionnementManager->saveFraisFonctionnement($frais)) { exit('ERR_SAVE_OBJ');}	$logManager = new LogManager($cnx);	$log = new Log([]);	$log->setLog_type('warning');	$log->setLog_texte('Suppression (flag) du frais de fonctionnement ID #' . $id);	$logManager->saveLog($log);	exit('1'); // Retour positif} // FIN mode// Switch l'activation du frais de fonctionnementfunction modeSwitchActivationFrais() {	global $fraisFonctionnementManager, $cnx;	$id = isset($_REQUEST['id']) ? intval($_REQUEST['id']) : 0;	$activation = isset($_REQUEST['active']) ? intval($_REQUEST['active']) : -1;	if ($id == 0) { exit("ERR_ID_ZERO"); }	if ($activation < 0 || $activation > 1) { exit("ERR_VAL_ACTIVATION"); }	$frais = $fraisFonctionnementManager->getFraisFonctionnement($id);	if (!$frais instanceof FraisFonctionnement) { exit("ERR_OBJ_FRAISFONCTINNEMENT"); }	$frais->setActivation($activation);	if (!$fraisFonctionnementManager->saveFraisFonctionnement($frais)) { exit('ERR_SAVE_OBJ');}	$logManager = new LogManager($cnx);	$log = new Log([]);	$log->setLog_type('warning');	$logTxt = $activation == 0 ? 'Désactivation' : 'Activation';	$logTxt.= ' du frais de fonctionnement ID #'.$id;	$log->setLog_texte($logTxt);	$logManager->saveLog($log);	exit('1'); // Retour positif} // FIN mode