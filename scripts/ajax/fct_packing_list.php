<?php/*   _|_|_|  _|_|_|    _| _|        _|    _|  _|        CBO FrameWork _|        _|_|_|    _|        (c) 2018 Cédric Bouillon _|        _|    _|  _|   _|_|_|  _|_|_|    _|_|_|_|--------------------------------------------------------Contrôleur Ajax Bons de Livraisons------------------------------------------------------*/ini_set('display_errors',1);// Initialisation du mode d'appel$mode       = isset($_REQUEST['mode']) ? $_REQUEST['mode'] : '';// Intégration de la configuration du FrameWork et des autorisationsrequire_once '../php/config.php';// Instanciation des Managers$tiersManager = new TiersManager($cnx);$logsManager  = new LogManager($cnx);$blsManagers  = new BlManager($cnx);$logManager	  = new LogManager($cnx);$packingListManager = new PackingListManager($cnx);$fonctionNom = 'mode'.ucfirst($mode);if (function_exists($fonctionNom)) {	$fonctionNom();}/* -----------------------------------------------------MODE - Crée une nouvelle Packing List depuis des ID BLs------------------------------------------------------*/function modeCreatePackingListFromBls() {	global $packingListManager, $blsManagers, $logManager;	$id_bls = isset($_REQUEST['id_bls']) ? $_REQUEST['id_bls'] : '';	$id_bls_array = explode(',', $id_bls);	if (empty($id_bls_array)) { exit('-1'); }	$packingList = new PackingList([]);	$packingList->setDate(date('Y-m-d H:i:s'));	$id_packing_list = $packingListManager->savePackingList($packingList);	if (intval($id_packing_list) == 0) { exit('-2'); }	if (!generePdfPackingList($packingList, $id_bls_array)) {		$log = new Log([]);		$log->setLog_type('danger');		$log->setLog_texte("Erreur lors de la création du PDF de la Packing List #".$id_packing_list." !");		$logManager->saveLog($log);		exit('-3');    }	// Un fois réussi, on enregistre le numéro de packing list en BDD pour chaque BL	foreach ($id_bls_array as $id_bl) {	    $bl = $blsManagers->getBl($id_bl, false);	    $bl->setId_packing_list($id_packing_list);	    if (!$blsManagers->saveBl($bl)) {	        $log = new Log([]);	        $log->setLog_type('danger');	        $log->setLog_texte("Erreur SAVE sur BL".$id_bl." # lors de l'ajout de l'id_packing_list #".$id_packing_list." !");			$logManager->saveLog($log);			exit('-4');        }    } // FIN boucle BLs    // On log	$log = new Log([]);	$log->setLog_type('info');	$log->setLog_texte("Création de la Packing List #".$id_packing_list."");	$logManager->saveLog($log);	exit('1');} // FIN mode/* -----------------------------------------------------FONCTION DEPORTEE - Crée le PDF de la Packing List------------------------------------------------------*/function generePdfPackingList(PackingList $packingList, $id_bls_array = []) {	global $blsManagers, $cnx, $packingListManager;	$bls = $blsManagers->getListeBl(['id_packing' => $packingList->getId()]);	// Si on a pas pu récupérer les BL depuis l'objet c'est qu'on est en première création, on les récupère donc depuis les IDS	if (!$bls || empty($bls && !empty($id_bls_array))) {		$bls = $blsManagers->getListeBl(['ids' => $id_bls_array]);	} // FIN récup des Bls par IDs	// Si toujours pas, alors là il y a un bien un problème	if (!$bls || empty($bls)) { return false; }	require_once(__CBO_ROOT_PATH__.'/vendor/html2pdf/html2pdf.class.php');	ob_start();	/**	 * On boucle sur les BL	-> genere pour chaque BL à la suite	-> si facture associée on affiche l'info	Puis une page total	 */	$configManager = new ConfigManager($cnx);	$pdf_top_pl = $configManager->getConfig('pdf_top_pl');	$margeEnTetePdt = $pdf_top_pl instanceof Config ?  (int)$pdf_top_pl->getValeur() : 0;	foreach ($bls as $bl) {		$content_fichier = genereContenuPdf($bl);		$html_additionnel = getDebutTableauBl($bl, $packingList);		$content_header = genereHeaderPdf($bl, $html_additionnel);		$contentPdf = '<page backtop="'.(int)$margeEnTetePdt.'mm">';		$contentPdf.= '<page_header><style type="text/css">'.file_get_contents(__CBO_CSS_URL__.'pdf.css').'</style>'.$content_header.'</page_header>';		$contentPdf.= $content_fichier;		$contentPdf.= '</page>';	}	$contentPdf.= ''. ob_get_clean();	try {		$marges = [7, 12, 7, 12];		$nom_fichier = $packingList->getNum_packing_list().'.pdf';		$dir = $packingListManager->getDossierPackingListPdf($packingList);		$html2pdf = new HTML2PDF('P', 'A4', 'fr', false, 'ISO-8859-15', $marges);		$html2pdf->pdf->SetAutoPageBreak(false, 0);		$html2pdf->setDefaultFont('helvetica');		$html2pdf->writeHTML(utf8_decode($contentPdf));;		$savefilepath = __CBO_ROOT_PATH__ . $dir . $nom_fichier;		$html2pdf->Output($savefilepath, 'F');	} catch (HTML2PDF_exception $e) {		vd($e);		exit;	}    return true;} // FIN fonction/* ----------------------------------------------------------------------------FONCTION DEPORTEE - Génère le contenu HTML du lot pour le PDF-----------------------------------------------------------------------------*/function genereContenuPdf(Bl $bl) {	global $cnx, $blsManagers;	$tiersManager 			= new TiersManager($cnx);	$traductionsManager 	= new TraductionsManager($cnx);	$poidsPalettesManager 	= new PoidsPaletteManager($cnx);	$poidsBruts = $blsManagers->isBlHasPoidsBruts($bl);	$contenu =  '';	$client = $tiersManager->getTiers($bl->getId_tiers_livraison());	if (!$client instanceof Tiers) {		$client = $tiersManager->getTiers($bl->getId_tiers_facturation());	}	if (!$client instanceof Tiers) { $client = new Tiers([]); } // Gestion des erreurs	if ($bl->getId_langue() == 0) { $bl->setId_langue(1); }	$id_langue = $bl->getId_langue();	$w1 = 64;	if ($poidsBruts) {		$w1-=12;	}	$contenu.='<table class="table table-blfact w100 mt-15">';	$contenu.='<tr class="entete">';	$contenu.='<td class="w8 border-t border-l border-r border-b">'.$traductionsManager->getTrad('code', $id_langue).'</td>';	$contenu.='<td class="w'.$w1.' border-t border-l border-r border-b">'.$traductionsManager->getTrad('designation', $id_langue).'</td>';	$contenu.='<td class="w8 text-center border-t border-l border-r border-b">'.$traductionsManager->getTrad('colis', $id_langue).'</td>';	$contenu.='<td class="w8 text-center border-t border-l border-r border-b">'.$traductionsManager->getTrad('qte', $id_langue).'</td>';	$contenu.='<td class="w12 text-right border-t border-l border-r border-b">'.$traductionsManager->getTrad('poids', $id_langue).' (kg)</td>';	$contenu.= $poidsBruts ? '<td class="w12 text-right border-t border-l border-r border-b">'.$traductionsManager->getTrad('poidsbrut', $bl->getId_langue()).' (kg)</td>' : '';	$contenu.='</tr>';	$contenu.='</table>';	$contenu.='<table class="table table-blfact w100">';	$total_colis 	= 0;	$total_colis_bl = 0;	$id_palette 	= 0;	$num_palette 	= 0;	$id_poids_pal 	= 0;	$total_poids 	= 0.0;	$total_poids_bl = 0.0;	$total_pu_bl 	= 0.0;	$total_total_bl = 0.0;	$total_qte      = 0;	$total_qte_bl   = 0;	$total_palette_poids_palette_bl = 0.0;	// Calcul du poids brut par ligne	 $poidsPalettes = $blsManagers->getPoidsBrutsByPalettes($bl->getId());	// on fais une première boucle sur les lignes du bl pour en sortir un array [id_palette => nb_colis_total]	$nb_colis_palettes = [];	foreach ($bl->getLignes() as $ligne) {		if ($ligne->getId_palette() > 0) {			if (!isset($nb_colis_palettes[$ligne->getId_palette()])) {				$nb_colis_palettes[$ligne->getId_palette()] = 0;			}			$nb_colis_palettes[$ligne->getId_palette()]+=$ligne->getNb_colis();		}	}	$total_poids_brut_palette = 0;	$total_poids_brutt_total = 0;	$total_poids_palette = 0;	$total_poids_brut = 0;	$piece = false;	foreach ($bl->getLignes() as $ligne) {		$piece = false;		if ($ligne->getProduit() instanceof Produit) {			$piece = $ligne->getProduit()->isVendu_piece();		}		$nb_colis_ligne = $piece ? '-' : $ligne->getNb_colis();		// pour chaque ligne on calcule le poids brut en faisant poids_net + ((nb_colis * poids) / nb_colis_total)		$poidsBrut = isset($poidsPalettes[$ligne->getId_palette()]) &&  isset($nb_colis_palettes[$ligne->getId_palette()]) && $nb_colis_palettes[$ligne->getId_palette()] > 0			? $ligne->getPoids() + ( ($ligne->getNb_colis() * $poidsPalettes[$ligne->getId_palette()]) / $nb_colis_palettes[$ligne->getId_palette()])			: $ligne->getPoids();		if ($id_palette == 0) {			$id_palette = $ligne->getId_palette();			$num_palette = $ligne->getNumero_palette();			$id_poids_pal  = $ligne->getId_poids_palette();		}		if ($ligne->getId_palette() != $id_palette) {			$total_palette_poids_palette = $poidsPalettesManager->getTotalPoidsPalette($id_palette);			$total_poids_total = $total_poids + $total_palette_poids_palette;			$total_palette_poids_palette_bl+=$total_palette_poids_palette;			$total_poids_totalTxt = $total_poids_total == $total_poids ? '' : number_format($total_poids_total, 3, '.', ' ');			$total_colis_palette = $piece ? '-' : $total_colis;			$contenu .= '<tr class="soustotal">';			$contenu .= '<td class="w8 border-l border-r pb-10"></td>';			$contenu .= '<td class="w'.$w1.' text-right border-l border-r pb-10">' . $traductionsManager->getTrad('totpalnum', $bl->getId_langue()) . $num_palette . '</td>';			$contenu .= '<td class="w8 text-center border-l border-r border-t-d pb-10">' . $total_colis_palette . '</td>';			$contenu .= '<td class="w8 text-center  border-l border-r border-t-p pb-10">'.$total_qte.'</td>';			$contenu .= '<td class="w12 text-right border-l border-r border-t-d pb-10">' . number_format($total_poids, 3, '.', ' ') . '</td>';			$contenu.= $poidsBruts ? '<td class="w12 text-right border-t border-l border-r border-b">'.$total_poids_totalTxt.'</td>' : '';			$contenu .= '</tr>';				$contenu .= '<tr class="soustotal">';				$contenu .= '<td class="w8 border-l border-r pb-10"></td>';				$contenu .= '<td class="w'.$w1.' text-right border-l border-r pb-10">' . $traductionsManager->getTrad('totpnetpal', $bl->getId_langue()) . $num_palette . '</td>';				$contenu .= '<td class="w8 text-center border-l border-r border-t-d pb-10">' . $total_colis_palette . '</td>';				$contenu .= '<td class="w8 text-center  border-l border-r border-t-p pb-10">'.$total_qte.'</td>';				$contenu .= '<td class="w12 text-right border-l border-r border-t-d pb-10">' . number_format($total_poids, 3, '.', ' ') . '</td>';				$contenu.= $poidsBruts ? '<td class="w12 text-right border-t border-l border-r border-b"></td>' : '';				$contenu .= '</tr>';				$contenu .= '<tr class="soustotal">';				$contenu .= '<td class="w8 border-l border-r pb-10"></td>';				$contenu .= '<td class="w'.$w1.' text-right border-l border-r pb-10">' . $traductionsManager->getTrad('totalpembpal', $bl->getId_langue()) . '</td>';				$contenu .= '<td class="w8 text-center border-l border-r border-t-d pb-10"></td>';				$contenu .= '<td class="w8 text-center  border-l border-r border-t-p pb-10"></td>';				$contenu .= '<td class="w12 text-right border-l border-r border-t-d pb-10">' . number_format($total_palette_poids_palette, 3, '.', ' ') . '</td>';				$contenu.= $poidsBruts ? '<td class="w12 text-right border-t border-l border-r border-b"></td>' : '';				$contenu .= '</tr>';				$contenu .= '<tr class="soustotal">';				$contenu .= '<td class="w8 border-l border-r pb-10"></td>';				$contenu .= '<td class="w'.$w1.' text-right border-l border-r pb-10">' . $traductionsManager->getTrad('totpbrutpal', $bl->getId_langue()) . $num_palette . '</td>';				$contenu .= '<td class="w8 text-center border-l border-r border-t-d pb-10"></td>';				$contenu .= '<td class="w8 text-center  border-l border-r border-t-p pb-10"></td>';				$contenu .= '<td class="w12 text-right border-l border-r border-t-d pb-10">' . number_format($total_poids_total, 3, '.', ' ') . '</td>';				$contenu.= $poidsBruts ? '<td class="w12 text-right border-t border-l border-r border-b"></td>' : '';				$contenu .= '</tr>';			$num_palette = $ligne->getNumero_palette();			$id_palette = $ligne->getId_palette();			//$id_poids_pal   = $ligne->getId_poids_palette();			$total_colis = 0;			$total_poids = 0.0;			$total_qte = 0;		}		$total_colis += (int)$ligne->getNb_colis();		$total_poids += (float)$ligne->getPoids();		$total_colis_bl += (int)$ligne->getNb_colis();		$total_poids_bl += (float)$ligne->getPoids();		$total_pu_bl += (float)$ligne->getPu_ht();		$total_total_bl += (float)$ligne->getTotal();		$total_qte+= (int)$ligne->getQte();		$total_qte_bl+= (int)$ligne->getQte();		$designation = 'Non défini !';		if ($ligne->getDesignation() != '') {			$designation = $ligne->getDesignation();		} else if ($ligne->getProduit() instanceof Produit) {			$noms = $ligne->getProduit()->getNoms();			$designation = isset($noms[$bl->getId_langue()]) ? $noms[$bl->getId_langue()] : 'Traduction manquante !';		} // FIN test désignation libre / nom du produit		// DEBUG symbole non géré par HTML2PDF		$designation =str_replace('œ', 'oe', $designation);		$designation =str_replace('Œ', 'OE', $designation);		$designation =str_replace('&OElig;', 'OE', $designation);		$designation =str_replace('&oelig;', 'oe', $designation);		$designation =str_replace('&#140;', 'OE', $designation);		$designation =str_replace('&#156;', 'oe', $designation);		$date_dlc = $id_langue == 1 ? Outils::dateSqlToFr($ligne->getDlc()) : $ligne->getDlc();		$date_abattage = $id_langue == 1 ? Outils::dateSqlToFr($ligne->getDate_abattage()) : $ligne->getDate_abattage();		$date_traitement = $id_langue == 1 ? Outils::dateSqlToFr($ligne->getDate_traitement()) : $ligne->getDate_traitement();		$date_conditionnement = $id_langue == 1 ? Outils::dateSqlToFr($ligne->getDate_add()) : $ligne->getDate_add();		$qte = $ligne->getQte() > 1 ? $ligne->getQte() : 1;		$contenu .= '<tr>';		$contenu .= '<td class="w8 border-l border-r">' . $ligne->getCode() . '</td>';		$contenu .= '<td class="w'.$w1.' border-l border-r">' . $designation;		$contenu .= '<br>' . $traductionsManager->getTrad('lot', $bl->getId_langue()) . ' : ' . $ligne->getNumlot() . ' Orig : ' . $ligne->getOrigine();		$contenu .= $date_abattage != '' ? '<br>' . $traductionsManager->getTrad('date_abattage', $bl->getId_langue()) . ' : ' . $date_abattage  : '';		$contenu .= $date_dlc != '' ? ' ' . $traductionsManager->getTrad($ligne->getType_dlc(), $bl->getId_langue()) . ' : ' . $date_dlc : '';		if ($ligne->getHors_stock() == 1) {			$contenu .= '<br>' . $traductionsManager->getTrad($ligne->getTrad_traitement(), $bl->getId_langue()) . ' : ' . $date_conditionnement;		} else {			$contenu .= '<br>' . $traductionsManager->getTrad($ligne->getTrad_traitement(), $bl->getId_langue()) . ' : ' . $date_traitement;		}		$contenu .= '</td>';		$contenu .= '<td class="w8 text-center border-l border-r border-b-d">' . $nb_colis_ligne . '</td>';		$contenu .= '<td class="w8 text-center border-l border-r border-b-d">' .  $qte . '</td>';		$contenu .= '<td class="w12 text-right border-l border-r border-b-d">' . number_format($ligne->getPoids(), 3, ".", " ") . '</td>';		$contenu.= $poidsBruts ? '<td class="w12 text-right border-t border-l border-r border-b">'.number_format($poidsBrut,3,'.', ' ').'</td>' : '';		$contenu .= '</tr>';	} // FIN boucle sur les lignes	$total_palette_poids_palette = $poidsPalettesManager->getTotalPoidsPalette($id_palette);	$total_poids_total = $total_poids + $total_palette_poids_palette;	$total_palette_poids_palette_bl+=$total_palette_poids_palette;	$total_colis_palette = $piece ? '-' : $total_colis;	$total_poids_totalTxt = $total_poids_total == $total_poids ? '' : number_format($total_poids_total, 3, '.', ' ');	$contenu.='<tr class="soustotal">';	$contenu.='<td class="w8 border-l border-r"></td>';	$contenu.='<td class="w'.$w1.' text-right border-l border-r">'.$traductionsManager->getTrad('totpalnum', $bl->getId_langue()).$num_palette.'</td>';	$contenu.='<td class="w8 text-center border-l border-r border-t-d">'.$total_colis_palette.'</td>';	$contenu.='<td class="w8 text-center border-t border-l border-r border-t-d">'.$total_qte.'</td>';	$contenu.='<td class="w12 text-right border-l border-r border-t-d">'.number_format($total_poids,3, '.', ' ').'</td>';	$contenu.= $poidsBruts ? '<td class="w12 text-right border-t border-l border-r border-b">'.$total_poids_totalTxt.'</td>' : '';	$contenu.='</tr>';	$contenu.='<tr class="soustotal">';	$contenu.='<td class="w8 border-l border-r"></td>';	$contenu.='<td class="w'.$w1.' text-right border-l border-r">'.$traductionsManager->getTrad('totpnetpal', $bl->getId_langue()).$num_palette.'</td>';	$contenu.='<td class="w8 text-center border-l border-r border-t-d">'.$total_colis_palette.'</td>';	$contenu.='<td class="w8 text-center border-t border-l border-r border-t-d">'.$total_qte.'</td>';	$contenu.='<td class="w12 text-right border-l border-r border-t-d">'.number_format($total_poids,3, '.', ' ').'</td>';	$contenu.= $poidsBruts ? '<td class="w12 text-right border-t border-l border-r border-b"></td>' : '';	$contenu.='</tr>';	$contenu .= '<tr class="soustotal">';	$contenu .= '<td class="w8 border-l border-r pb-10"></td>';	$contenu .= '<td class="w'.$w1.' text-right border-l border-r pb-10">' . $traductionsManager->getTrad('totalpembpal', $bl->getId_langue()) . '</td>';	$contenu .= '<td class="w8 text-center border-l border-r border-t-d pb-10"></td>';	$contenu .= '<td class="w8 text-center  border-l border-r border-t-p pb-10"></td>';	$contenu .= '<td class="w12 text-right border-l border-r border-t-d pb-10">' . number_format($total_palette_poids_palette, 3, '.', ' ') . '</td>';	$contenu.= $poidsBruts ? '<td class="w12 text-right border-t border-l border-r border-b"></td>' : '';	$contenu .= '</tr>';	$contenu .= '<tr class="soustotal">';	$contenu .= '<td class="w8 border-l border-r pb-10"></td>';	$contenu .= '<td class="w'.$w1.' text-right border-l border-r pb-10">' . $traductionsManager->getTrad('totpbrutpal', $bl->getId_langue()) . $num_palette . '</td>';	$contenu .= '<td class="w8 text-center border-l border-r border-t-d pb-10"></td>';	$contenu .= '<td class="w8 text-center  border-l border-r border-t-p pb-10"></td>';	$contenu .= '<td class="w12 text-right border-l border-r border-t-d pb-10">' . number_format($total_poids_total, 3, '.', ' ') . '</td>';	$contenu.= $poidsBruts ? '<td class="w12 text-right border-t border-l border-r border-b"></td>' : '';	$contenu .= '</tr>';	$total_colis_bl = $piece ? '-' : $total_colis_bl;	$contenu.='<tr class="entete">';	$contenu.='<td class="w8 border-l border-r border-b border-t"></td>';	$contenu.='<td class="w'.$w1.' text-right border-l border-r border-b border-t">'.$traductionsManager->getTrad('total_exp', $bl->getId_langue()).'</td>';	$contenu.='<td class="w8 text-center border-l border-r border-b border-t vmiddle">'.$total_colis_bl.'</td>';	$contenu.='<td class="w8 text-center border-l border-t border-r border-b">'.$total_qte_bl.'</td>';	$contenu.='<td class="w12 text-right border-l border-r border-t border-b vmiddle">'.number_format($total_poids_bl,3, '.', ' ').'</td>';	$contenu.= $poidsBruts ? '<td class="w12 text-right border-t border-l border-r border-b"></td>' : '';	$contenu.='</tr>';	$contenu.='<tr class="entete">';	$contenu.='<td class="w8 border-l border-r border-b border-t"></td>';	$contenu.='<td class="w'.$w1.' text-right border-l border-r border-b border-t">'.$traductionsManager->getTrad('totalpnetex', $bl->getId_langue()).'</td>';	$contenu.='<td class="w8 text-center border-l border-r border-b border-t vmiddle">'.$total_colis_bl.'</td>';	$contenu.='<td class="w8 text-center border-l border-t border-r border-b">'.$total_qte_bl.'</td>';	$contenu.='<td class="w12 text-right border-l border-r border-t border-b vmiddle">'.number_format($total_poids_bl,3, '.', ' ').'</td>';	$contenu.= $poidsBruts ? '<td class="w12 text-right border-t border-l border-r border-b"></td>' : '';	$contenu.='</tr>';	$contenu.='<tr class="entete">';	$contenu.='<td class="w8 border-l border-r border-b border-t"></td>';	$contenu.='<td class="w'.$w1.' text-right border-l border-r border-b border-t">'.$traductionsManager->getTrad('totalpembpals', $bl->getId_langue()).'</td>';	$contenu.='<td class="w8 text-center border-l border-r border-b border-t vmiddle"></td>';	$contenu.='<td class="w8 border-l border-t border-r border-b"></td>';	$contenu.='<td class="w12 text-right border-l border-r border-t border-b vmiddle">'.number_format($total_palette_poids_palette_bl,3, '.', ' ').'</td>';	$contenu.= $poidsBruts ? '<td class="w12 text-right border-t border-l border-r border-b"></td>' : '';	$contenu.='</tr>';	$contenu.='<tr class="entete">';	$contenu.='<td class="w8 border-l border-r border-b border-t"></td>';	$contenu.='<td class="w'.$w1.' text-right border-l border-r border-b border-t">'.$traductionsManager->getTrad('totalpbrutex', $bl->getId_langue()).'</td>';	$contenu.='<td class="w8 text-center border-l border-r border-b border-t vmiddle"></td>';	$contenu.='<td class="w8 border-l border-t border-r border-b"></td>';	$contenu.='<td class="w12 text-right border-l border-r border-t border-b vmiddle">'.number_format($total_palette_poids_palette_bl + $total_poids_bl,3, '.', ' ').'</td>';	$contenu.= $poidsBruts ? '<td class="w12 text-right border-t border-l border-r border-b"></td>' : '';	$contenu.='</tr>';	$contenu.='</table>';	return $contenu;} // FIN fonction/* ----------------------------------------------------------------------------FONCTION DEPORTEE - Génère le contenu HTML du header-----------------------------------------------------------------------------*/function genereHeaderPdf(Bl $bl, $html_additionnel = '') {	global $cnx;	$documentsManager = new DocumentManager($cnx);	$tiersManager = new TiersManager($cnx);	$client = $tiersManager->getTiers($bl->getId_tiers_livraison());	if (!$client instanceof Tiers) {		$client = $tiersManager->getTiers($bl->getId_tiers_facturation());	}	if (!$client instanceof Tiers) { $client = new Tiers([]); } // Gestion des erreurs	$id_langue = $bl->getId_langue();	if ($id_langue == 0) { $id_langue = 1; }	return $documentsManager->getHeaderDocumentPdf($client, 'l', 'pl', $id_langue, true, true, $bl->getCode(), $html_additionnel);} // FIN fonction/* ----------------------------------------------------------------------------FONCTION DEPORTEE - Génère les lignes de titre du tableau (header)-----------------------------------------------------------------------------*/function getDebutTableauBl(Bl $bl, PackingList $packingList) {	global $cnx;	$traductionsManager = new TraductionsManager($cnx);	$configManager = new ConfigManager($cnx);	$tiersManager = new TiersManager($cnx);	$client = $tiersManager->getTiers($bl->getId_tiers_livraison());	if (!$client instanceof Tiers) {		$client = $tiersManager->getTiers($bl->getId_tiers_facturation());	}	if (!$client instanceof Tiers) { $client = new Tiers([]); } // Gestion des erreurs	$id_langue = $bl->getId_langue();	if ($id_langue == 0) { $id_langue = 1; }	$designationTrad = $traductionsManager->getTrad('designation', $id_langue);	$tarifTrad = $traductionsManager->getTrad('tarif', $id_langue);	$htTrad = $traductionsManager->getTrad('ht', $id_langue);	$w1 = 'w64'; // La packing list n'est jamais chiffrée	$date_bl = $id_langue == 1 ? Outils::dateSqlToFr($bl->getDate()) : $bl->getDate();	$adresseManager = new AdresseManager($cnx);	$adresse_livraison = $adresseManager->getAdresse($bl->getId_adresse_livraison());	$adresse = $adresse_livraison instanceof Adresse ? $adresse_livraison->getAdresse() : '';	// On affiche la référence du BL et de la facture	$contenu ='<table class="table table-blfact w100">';	$contenu.='<tr>';	$contenu.='<td class="w50">'. $traductionsManager->getTrad('bl', $id_langue) . ' ' . $bl->getNum_bl();	$contenu.= ' '.$traductionsManager->getTrad('du', $id_langue) . ' ' .$date_bl . '<br>';	if ($adresse != '') {		$contenu.= ' '.$traductionsManager->getTrad('livraison_a', $id_langue) . '<p>' .$client->getNom().'<br>'.$adresse . '</p>';	}	$contenu.='</td>';	$contenu.='<td class="w50">';	// Si facture associée	if (!empty($bl->getFactures())) {		foreach ($bl->getFactures() as $f) {			$date_facture = $id_langue == 1 ? Outils::dateSqlToFr($f->getDate()) : $f->getDate();			$adresse_facture = $adresseManager->getAdresse($f->getId_adresse_facturation());			$adresseF = $adresse_facture instanceof Adresse ? $adresse_facture->getAdresse() : '';			$clientF = $tiersManager->getTiers($f->getId_tiers_facturation());			$contenu.= $traductionsManager->getTrad('facture', $id_langue) . ' ' . $f->getNum_facture();			$contenu.= ' '.$traductionsManager->getTrad('du', $id_langue) . ' ' .$date_facture . '<br>';			if ($adresseF != '') {				$contenu.= ' '.$traductionsManager->getTrad('livraison_a', $id_langue) . '<p>' .$clientF->getNom().'<br>'.$adresseF . '</p>';			}		}	}	$date_pl = $id_langue == 1 ? Outils::dateSqlToFr($packingList->getDate()) : $packingList->getDate();	$incotermsConfig = $configManager->getConfig('incoterms');	$incoterms = $incotermsConfig instanceof Config ? '<p>'.$incotermsConfig->getValeur().'</p>' : '';	$contenu.='</td>';	$contenu.='</tr>';	$contenu.='<tr class="entete">';	$contenu.='<td class="w50">'.ucwords($traductionsManager->getTrad('pl', $id_langue) ). ' ' . $packingList->getNum_packing_list();	$contenu.= ' '.$traductionsManager->getTrad('du', $id_langue) . ' ' .$date_pl;	$contenu.='</td>';	$contenu.='<td class="w50 text-right">'.$incoterms;	$contenu.='</td>';	$contenu.='</tr>';	$contenu.='</table>';/*	$contenu.='<table class="table table-blfact w100 mt-15">';	$contenu.='<tr class="entete">';	$contenu.='<td class="w8 border-t border-l border-r border-b">'.$traductionsManager->getTrad('code', $id_langue).'</td>';	$contenu.='<td class="w64 border-t border-l border-r border-b">'.$traductionsManager->getTrad('designation', $id_langue).'</td>';	$contenu.='<td class="w8 text-center border-t border-l border-r border-b">'.$traductionsManager->getTrad('colis', $id_langue).'</td>';	$contenu.='<td class="w8 text-center border-t border-l border-r border-b">'.$traductionsManager->getTrad('qte', $id_langue).'</td>';	$contenu.='<td class="w12 text-right border-t border-l border-r border-b">'.$traductionsManager->getTrad('poids', $id_langue).' (kg)</td>';	$contenu.='</tr>';	$contenu.='</table>';*/	return $contenu;} // FIN fonction