<?php/**------------------------------------------------------------------------PAGE - DEV - Purge des documentsCopyright (C) 2019 Intersedhttp://www.intersed.fr/------------------------------------------------------------------------@author    Cédric Bouillon@copyright Copyright (c) 2019 Intersed@version   1.0@since     2018------------------------------------------------------------------------ */require_once 'scripts/php/config.php';// Vérifie une authentification par login/mdp adminrequire_once 'scripts/php/check_admin.php';// On restreint la page aux Administrateurs Devéloppeursif (!$utilisateur->isDev()) {  header('Location: index.php'); }$documentsManager = new DocumentManager($cnx);$h1     = 'Documents supprimés';$h1fa   = 'fa-fw fa-trash-alt';include('includes/header.php');// Si purgeif (isset($_REQUEST['purge'])) {    // On récup la liste de tous les documents supprimés	$purge_params['supprime'] = 1;	$purge_listeDocs = $documentsManager->getListeDocuments($purge_params);	$ids2purge = [];	// On boucle sur chacun pour supprimer les fichiers    foreach ($purge_listeDocs as $purge_doc) {		$purge_chemin = __CBO_UPLOADS_PATH__.$purge_doc->getLot_id().'/'.$purge_doc->getFilename();		// Si le fichier existe pas (O_o) on passe au suivant...		if (!file_exists($purge_chemin)) { continue; }		// Si erreur lors de la suppression, on passe au suivant...		if (!unlink($purge_chemin)) { continue; }		// Si la purge s'est bien passée, on l'ajoute à la liste des ID à supprimer		$ids2purge[] = $purge_doc->getId();    } // FIN boucle sur documents à purger    // On supprime les ID en BDD    if (!empty($ids2purge)) {		$documentsManager->deleteDocuments($ids2purge);    } // FIN IDs à supprimer en base} // FIN test purge$page = isset($_REQUEST['page']) ? $_REQUEST['page'] : 1;$pagination = new Pagination($page);$pagination->setNb_results_page(10);$pagination->setNb_avant(3);$pagination->setNb_apres(3);$params['start']                = $pagination->getStart();$params['nb_results_p_page']    = $pagination->getNb_results_page();$params['supprime']             = 1;$listeDocs = $documentsManager->getListeDocuments($params);$pagination->setNb_results(!empty($listeDocs) ? $documentsManager->getNb_results() : 0);?><div class="container-fluid">    <div class="row" id="listeDocs">        <div class="col">            <?php            // Pas de docs            if (empty($listeDocs)) { ?>                <div class="alert alert-info">                    <i class="fa fa-info-circle fa-lg mr-1"></i> Aucun document supprimé.                </div>            <?php            // Des docs supprimés ont été trouvés            } else { ?>                <div class="row">                    <div class="col-10">                        <table class="admin w-100">                            <thead>                            <tr>                                <th class="text-center">ID</th>                                <th>Numéro de lot</th>                                <th>Titre</th>                                <th>Type</th>                                <th>Dossier</th>                                <th>Fichier</th>                                <th>Uploadé le</th>                                <th class="t-actions w-mini-admin-cell">Ouvrir</th>                                <th class="t-actions w-mini-admin-cell">Restaurer</th>                                <th class="t-actions w-mini-admin-cell">Purger</th>                            </tr>                            </thead>                            <tbody>                            <?php                            foreach ($listeDocs as $doc) { ?>                                <tr>                                    <td class="w-minimax-admin-cell text-center"><span class="badge badge-pill badge-warning badge-id"><?php echo $doc->getId();?></span></td>                                    <td class="text-20"><?php echo $doc->getNumlot(); ?></td>                                    <td><?php echo $doc->getNom(); ?></td>                                    <td><?php echo $doc->getType_nom(); ?></td>                                    <td><kbd><?php echo $doc->getLot_id() ?>/</kbd></td>                                    <td><kbd><?php echo $doc->getFilename(); ?></kbd></td>                                    <td><?php echo ucfirst(Outils::getDate_verbose($doc->getDate())); ?></td>                                    <td class="t-actions">                                        <a href="<?php                                            echo __CBO_UPLOADS_URL__.$doc->getLot_id().'/'.$doc->getFilename();                                            ?>" class="btn btn-info btn-sm" target="_blank"><i class="fa fa-fw fa-external-link-alt"></i></a>                                    </td>                                    <td class="t-actions">                                        <button type="button" class="btn btn-sm btn-success btnRestaurerDoc" data-doc-id="<?php echo $doc->getId(); ?>"><i class="fa fa-fw fa-undo-alt"></i></button>                                    </td>                                    <td class="t-actions">                                        <button type="button" class="btn btn-sm btn-danger btnPurgeDoc" data-doc-id="<?php echo $doc->getId(); ?>"><i class="fa fa-fw fa-trash-alt"></i></button>                                    </td>                                </tr>                            <?php } ?>                            </tbody>                        </table>                        <?php                        if (isset($pagination)) {                            // Pagination bas de page, verbose...                            $pagination->setVerbose_pagination(1);                            $pagination->setVerbose_position('right');                            $pagination->setNature_resultats('document');                            echo $pagination->getPaginationHtml();                        }                        ?>                    </div>                    <div class="col-2 text-right">                        <a href="<?php echo $_SERVER['PHP_SELF']; ?>?purge" class="btn btn-danger btnPurgerTout"><i class="fa fa-trash-alt mr-1"></i> Purger tout</a>                    </div>                </div>			<?php            } // FIN test documents supprimés ?>        </div>    </div></div><?phpinclude('includes/footer.php');