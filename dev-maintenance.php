<?php/**------------------------------------------------------------------------PAGE - DEV - Gestion du mode maintenanceCopyright (C) 2020 Intersedhttp://www.intersed.fr/------------------------------------------------------------------------@author    Cédric Bouillon@copyright Copyright (c) 2019 Intersed@version   1.0@since     2018------------------------------------------------------------------------ */require_once 'scripts/php/config.php';// Vérifie une authentification par login/mdp adminrequire_once 'scripts/php/check_admin.php';// On restreint la page aux Administrateurs Devéloppeursif (!$utilisateur->isDev()) {  header('Location: index.php'); }$h1     = 'Mode maintenance';$h1fa   = 'fa-fw fa-wrench';// Si on active ou désactive le mode maintenance...if (isset($_REQUEST['switchmodemaintenance'])) {    // On préviens les rafraichissements par F5 via le flag passé en base 64    $secureGetFlag = base64_decode($_REQUEST['switchmodemaintenance']);    // On le compare avec la variable de session stockant le flag lors de la première redirection    if (isset($_SESSION['securegetflag']) && $secureGetFlag == $_SESSION['securegetflag']) {		$modeMaintenance = intval($config_maintenance->getValeur()) == 1 ? 0 : 1;		$config_maintenance->setValeur($modeMaintenance);    	$config_maintenance->setDate_maj(date('Y-m-d H:i:s'));		$configManager->saveConfig($config_maintenance);		unset($_SESSION['securegetflag']);    } // FIN sécure flag} // FIN switch mode maintenance// Si on active ou désactive la Gescomelse if( isset($_REQUEST['switchgescomactive'])) {	// On préviens les rafraichissements par F5 via le flag passé en base 64	$secureGetFlag = base64_decode($_REQUEST['switchgescomactive']);	// On le compare avec la variable de session stockant le flag lors de la première redirection	if (isset($_SESSION['securegetflag']) && $secureGetFlag == $_SESSION['securegetflag']) {		$gescom_activation = $gescom ? 0 : 1;		$config_gescom = $configManager->getConfig('gescom_active');		$config_gescom->setValeur($gescom_activation);    	$config_gescom->setDate_maj(date('Y-m-d H:i:s'));		if ($configManager->saveConfig($config_gescom)) {		    $gescom = $gescom_activation == 1;        }		unset($_SESSION['securegetflag']);	} // FIN sécure flag} // FIN test switch modesinclude('includes/header.php');$valeurinfo     = intval($config_maintenance->getValeur()) == 1 ? 0 : 1;$couleur        = intval($config_maintenance->getValeur()) == 1 ? 'danger'                 : 'secondary';$statut         = intval($config_maintenance->getValeur()) == 1 ? 'activé !'               : 'désactivé.';$verbinfo       = intval($config_maintenance->getValeur()) == 1 ? 'désactivez'             : 'activez';$fa_mode        = intval($config_maintenance->getValeur()) == 1 ? 'exclamation-triangle'   : 'unlock-alt';$couleurBtn     = intval($config_maintenance->getValeur()) == 1 ? 'success'                : 'danger';$texteBtn       = intval($config_maintenance->getValeur()) == 1 ? 'Désactiver'             : 'Activer';$faBtn          = intval($config_maintenance->getValeur()) == 1 ? 'lock-open'              : 'wrench';$valeurinfoGc   = $gescom ? 1 : 0;$couleurGc      = $gescom ? 'secondary'             : 'danger';$statutGc       = $gescom ? 'activée'               : 'désactivée !';$verbinfoGc     = $gescom ? 'activez'               : 'désactivez';$fa_modeGc      = $gescom ? 'unlock-alt'            : 'exclamation-triangle'  ;$texteBtnGc     = $gescom ? 'Désactiver'            : 'Activer';$faBtnGc        = $gescom ? 'exclamation-triangle'  : 'briefcase';$couleurBtnGc   = $gescom ? 'danger'                : 'success';// On génère un flag pour éviter les F5 intempéstifs et on le stocke en session$secureGetFlag = Outils::genereMotDePasse(8);$_SESSION['securegetflag'] = $secureGetFlag;?><div class="container-fluid">    <div class="row">        <div class="col">            <div class="row">                <div class="col-12">                    <div class="alert alert-<?php echo $couleur; ?> text-center">                        <h2><i class="fa fa-<?php echo $fa_mode; ?> fa-2x"></i><br>Mode maintenance <?php echo $statut; ?></h2>						<?php if (intval($config_maintenance->getValeur()) == 1) { ?>                            <p class="small"><i class="fa fa-lg fa-clock mr-1"></i> Depuis le <?php echo Outils::getDate_verbose($config_maintenance->getDate_maj());?></p>						<?php } else { ?>                            <p class="small text-success"><i class="fa fa-check mr-1"></i>Application traçabilité active</p>						<?php }?>                        <p class="small">En cas de problème de connexion, <?php                            echo $verbinfo; ?> manuellement le mode maintenance en BDD en affectant à <code><?php                                echo $valeurinfo; ?></code> la valeur de la clef <code>maintenance</code> dans la table <code>pe_config</code>.</p>                    </div>                </div>                <div class="col-7">                    <div class="alert alert-<?php echo $couleur; ?>">                        <ul class="mb-0">                            <li><i class="fa fa-angle-right pr-1"></i>Redirection de tous les mails envoyés vers l'adresse de référence du Framework : <code><?php echo $conf_email; ?></code></li>                            <li><i class="fa fa-angle-right pr-1"></i>Désactivation de l'API de laision avec l'application mobile</li>                            <li><i class="fa fa-angle-right pr-1"></i>Accès autorisé uniquement au profil <strong>Développeur</strong></li>                            <li><i class="fa fa-angle-right pr-1"></i>Affichage d'une page de maintenance aux autres utilisateurs</li>                        </ul>                    </div>                </div>                <div class="col-5">					<?php if (intval($config_maintenance->getValeur()) == 1) { ?>                        <a href="<?php echo __CBO_ROOT_URL__.'backup/'?>" target="_blank" class="btn btn-lg btn-secondary mb-2 form-control"><i class="fa fa-save mr-2"></i>Créer un backup</a>					<?php } ?>                    <a href="<?php echo $_SERVER['PHP_SELF'];?>?switchmodemaintenance=<?php echo base64_encode($secureGetFlag);?>" class="btn btn-lg btn-<?php echo $couleurBtn; ?> form-control btnSwitchModeMaintenance"><i class="fa fa-<?php echo $faBtn; ?> mr-2"></i><?php echo $texteBtn; ?> le mode maintenance</a>                </div>            </div>        </div>        <div class="col">            <div class="row">                <div class="col-12">                    <div class="alert alert-<?php echo $couleurGc; ?> text-center">                        <h2><i class="fa fa-<?php echo $fa_modeGc; ?> fa-2x"></i><br>Gescom <?php echo $statutGc; ?></h2>						<?php if ($gescom) { ?>                            <p class="small text-success"><i class="fa fa-check mr-1"></i>Application Gescom active</p>						<?php } else { ?>                            <p class="small text-danger"><i class="fa fa-pause mr-1"></i>Application Gescom suspendue</p>						<?php }?>                        <p class="small">En cas de problème de connexion, <?php echo $verbinfoGc; ?> manuellement la Gescom en BDD en affectant à <code><?php echo $valeurinfoGc; ?></code> la valeur de la clef <code>gescom_active</code> dans la table <code>pe_config</code>.</p>                    </div>                </div>                <div class="col-7">                    <div class="alert alert-<?php echo $couleur; ?>">                        <ul class="mb-0">                            <li><i class="fa fa-angle-right pr-1"></i>Accès supprimé du menu</code></li>                            <li><i class="fa fa-angle-right pr-1"></i>Redirection des pages vers l'accueil</li>                            <li><i class="fa fa-angle-right pr-1"></i>Accès autorisé uniquement au profil <strong>Développeur</strong></li>                        </ul>                    </div>                </div>                <div class="col-5">                    <a href="<?php echo $_SERVER['PHP_SELF'];?>?switchgescomactive=<?php echo base64_encode($secureGetFlag);?>" class="btn btn-lg btn-<?php echo $couleurBtnGc; ?> form-control btnSwitchGescomActive"><i class="fa fa-<?php echo $faBtnGc; ?> mr-2"></i><?php echo $texteBtnGc; ?> la GesCom</a>                </div>            </div>        </div>    </div></div><script type="text/javascript">    $('.btnSwitchModeMaintenance').click(function() {       return confirm("ATTENTION !\r\nVous allez " + $(this).text().toLowerCase() + ".\r\nContinuer ?");    });    $('.btnSwitchGescomActive').click(function() {        return confirm("ATTENTION !\r\nVous allez " + $(this).text() + ".\r\nContinuer ?");    });</script><?phpinclude('includes/footer.php');