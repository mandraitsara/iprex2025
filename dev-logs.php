<?php/**------------------------------------------------------------------------PAGE - DEV - LogsCopyright (C) 2019 Intersedhttp://www.intersed.fr/------------------------------------------------------------------------@author    Cédric Bouillon@copyright Copyright (c) 2019 Intersed@version   1.0@since     2018------------------------------------------------------------------------ */require_once 'scripts/php/config.php';// Vérifie une authentification par login/mdp adminrequire_once 'scripts/php/check_admin.php';// On restreint la page aux Administrateurs Devéloppeursif (!$utilisateur->isDev()) {  header('Location: index.php'); }$h1     = 'Journal des logs';$h1fa   = 'fa-fw fa-user-secret';include('includes/header.php');// Récup des logs$userManager = new UserManager($cnx);$logsManager = new LogManager($cnx);// Si purgeif (isset($_REQUEST['purge'])) {	include('scripts/php/purgelogs.php');} // FIN test purge// Filtres$regexDateFr =  '#^(([1-2][0-9]|0[1-9]|[3][0-1])\/([0][1-9]|[1][0-2])\/[2][0-9][0-9]{2})$#';$filtre_user    = isset($_REQUEST['filtre_user'])   ? intval($_REQUEST['filtre_user'])           : 0;$filtre_type    = isset($_REQUEST['filtre_type'])   ? trim(strtolower($_REQUEST['filtre_type'])) : '';$filtre_desc    = isset($_REQUEST['filtre_desc'])   ? trim(strip_tags($_REQUEST['filtre_desc'])) : '';$filtre_ip      = isset($_REQUEST['filtre_ip'])     ? trim(strip_tags($_REQUEST['filtre_ip']))   : '';$filtre_debut   = isset($_REQUEST['filtre_debut'])  && preg_match($regexDateFr, $_REQUEST['filtre_debut'])  ? $_REQUEST['filtre_debut']  : '';$filtre_fin     = isset($_REQUEST['filtre_fin'])    && preg_match($regexDateFr, $_REQUEST['filtre_fin'])    ? $_REQUEST['filtre_fin']    : '';if ($filtre_user   > 0 ) { $params['user']  = $filtre_user;  }if ($filtre_type  != '') { $params['type']  = $filtre_type;  }if ($filtre_desc  != '') { $params['desc']  = $filtre_desc;  }if ($filtre_ip    != '') { $params['ip']    = $filtre_ip;    }if ($filtre_debut != '') { $params['debut'] = $filtre_debut; }if ($filtre_fin   != '') { $params['fin']   = $filtre_fin;   }// Filtres pour pagination et redirections formulaires$filtres = '';$filtres.= $filtre_user > 0 ? '?filtre_user='.$filtre_user : '';$filtres.= isset($_REQUEST['filtre_type'])		? ($filtres != '' ? '&' : '?').'filtre_type=' .$filtre_type : '';$filtres.= isset($_REQUEST['filtre_desc'])		? ($filtres != '' ? '&' : '?').'filtre_desc=' .$filtre_desc : '';$filtres.= isset($_REQUEST['filtre_ip'])		? ($filtres != '' ? '&' : '?').'filtre_ip=' .$filtre_ip : '';$filtres.= isset($_REQUEST['filtre_debut'])		? ($filtres != '' ? '&' : '?').'filtre_debut=' .$filtre_debut : '';$filtres.= isset($_REQUEST['filtre_fin'])		? ($filtres != '' ? '&' : '?').'filtre_fin=' .$filtre_fin : '';?><div class="container-fluid">    <div class="row">        <div class="col">            <form action="<?php echo $_SERVER['PHP_SELF']; ?>" method="post" id="filtres">                <div class="row">                    <input type="hidden" name="mode" value="getListeLogs" />                    <input type="hidden" name="page" value="1" />                    <div class="col mb-2">                        <div class="input-group mb-3">                            <select class="selectpicker show-tick form-control" title="Type" name="filtre_type">                                <option value="" title="Type">Tous</option>                                <option data-divider="true"></option>                                <?php                                foreach (Outils::getAlertesTypes() as $code => $alertesType) { ?>                                    <option value="<?php echo $code; ?>" <?php echo $filtre_type == $code ? 'selected' : ''; ?>><?php echo $alertesType; ?></option>                                <?php } ?>                            </select>                        </div>                    </div>                    <div class="col mb-2">                        <div class="input-group mb-3">                            <select class="selectpicker show-tick form-control" title="Utilisateur" name="filtre_user">                                <option value="" title="Utilisateur">Tous</option>                                <option data-divider="true"></option>                                <?php                                $params = ['show_devs' => true, 'show_supprimes' => true];                                foreach ($userManager->getListeUsers($params) as $userFiltre) { ?>                                    <option value="<?php echo $userFiltre->getId(); ?>" <?php echo $userFiltre->getSupprime() == 1 ? 'data-subtext="Supprimé"' : '';                                    echo $filtre_user ==  $userFiltre->getId() ? 'selected' : ''; ?>><?php echo $userFiltre->getNomComplet(); ?></option>                                <?php } ?>                            </select>                        </div>                    </div>                    <div class="col mb-2">                        <div class="input-group mb-3">                            <div class="input-group-prepend">                                <span class="input-group-text"><i class="fa fa-font gris-9"></i></span>                            </div>                            <input type="text" class="form-control" placeholder="Description" name="filtre_desc" value="<?php echo $filtre_desc; ?>">                        </div>                    </div>                    <div class="col mb-2">                        <div class="input-group mb-3">                            <div class="input-group-prepend">                                <span class="input-group-text"><i class="fa fa-map-marker-alt mr-2 gris-9"></i> IP</span>                            </div>                            <input type="text" class="form-control" placeholder="Toutes" name="filtre_ip" value="<?php echo $filtre_ip; ?>">                        </div>                    </div>                    <div class="col mb-2">                        <div class="input-group mb-3">                            <div class="input-group-prepend">                                <span class="input-group-text">Du&hellip;</span>                            </div>                            <input type="text" class=" datepicker form-control" placeholder="Début" name="filtre_debut" value="<?php echo $filtre_debut; ?>">                            <div class="input-group-append">                                <span class="input-group-text" ><i class="fas fa-calendar-alt"></i></span>                            </div>                        </div>                    </div>                    <div class="col mb-2">                        <div class="input-group mb-3">                            <div class="input-group-prepend">                                <span class="input-group-text" >&hellip;au</span>                            </div>                            <input type="text" class=" datepicker form-control" placeholder="Fin" name="filtre_fin" value="<?php echo $filtre_fin; ?>">                            <div class="input-group-append">                                <span class="input-group-text" ><i class="fas fa-calendar-alt"></i></span>                            </div>                        </div>                    </div>                    <div class="col mb-2">                        <button type="submit" class="btn btn-secondary"><i class="fa fa-search mr-1"></i> Rechercher&hellip;</button>                        <a href="<?php echo $_SERVER['PHP_SELF'];?>" class="btn btn-outline-secondary"><i class="fa fa-backspace"></i></a>                    </div>                    <div class="col mb-2 text-right">                        <i class="fa fa-question-circle mr-1 gris-9 v-middle" data-toggle="tooltip" data-placement="left" title="Enregistre un fichier sur le serveur et vide la table."></i>                        <a href="<?php echo $_SERVER['PHP_SELF'];?>?purge" class="btn btn-danger"><i class="fa fa-trash-alt mr-1"></i> Purger et archiver&hellip;</a>                    </div>                </div>            </form>            <div class="alert alert-primary">                <a href="dev-logs-sql.php" class="btn btn-secondary"><i class="fa fa-database mr-1"></i> Consulter les logs SQL</a>            </div>        </div>    </div>    <div class="row">        <div class="col" id="listeLogs">            <i class="fa fa-spin fa-spinner mr-1"></i>Chargement des logs en cours...        </div>    </div></div><?phpinclude('includes/footer.php');