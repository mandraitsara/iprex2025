<?php/**------------------------------------------------------------------------PAGE - DEV - Log des mailsCopyright (C) 2019 Intersedhttp://www.intersed.fr/------------------------------------------------------------------------@author    Cédric Bouillon@copyright Copyright (c) 2019 Intersed@version   1.0@since     2018------------------------------------------------------------------------ */require_once 'scripts/php/config.php';// Vérifie une authentification par login/mdp adminrequire_once 'scripts/php/check_admin.php';// On restreint la page aux Administrateurs Devéloppeursif (!$utilisateur->isDev()) {  header('Location: index.php'); }$h1     = 'Mails envoyés';$h1fa   = 'fa-fw fa-paper-plane';include('includes/header.php');$logsMailsManager = new LogMailManager($cnx);$page = isset($_REQUEST['page']) ? $_REQUEST['page'] : 1;$pagination = new Pagination($page);$pagination->setNb_results_page(10);$pagination->setNb_avant(3);$pagination->setNb_apres(3);$params['start'] = $pagination->getStart();$params['nb_results_p_page'] = $pagination->getNb_results_page();// Filtres$regexDateFr =  '#^(([1-2][0-9]|0[1-9]|[3][0-1])\/([0][1-9]|[1][0-2])\/[2][0-9][0-9]{2})$#';$filtre_expediteur      = isset($_REQUEST['filtre_expediteur'])     ? trim(strtolower(strip_tags($_REQUEST['filtre_expediteur'] )))     : '';$filtre_destinataire    = isset($_REQUEST['filtre_destinataire'])   ? trim(strtolower(strip_tags($_REQUEST['filtre_destinataire'])))    : '';$filtre_recherche       = isset($_REQUEST['filtre_recherche'])      ? trim(strtolower(strip_tags($_REQUEST['filtre_recherche'])))       : '';$filtre_type            = isset($_REQUEST['filtre_type'])           ? intval($_REQUEST['filtre_type'])   : 0;$filtre_debut           = isset($_REQUEST['filtre_debut'])  && preg_match($regexDateFr, $_REQUEST['filtre_debut'])  ? $_REQUEST['filtre_debut']  : '';$filtre_fin             = isset($_REQUEST['filtre_fin'])    && preg_match($regexDateFr, $_REQUEST['filtre_fin'])    ? $_REQUEST['filtre_fin']    : '';if ($filtre_expediteur      != '' ) { $params['expediteur']     = $filtre_expediteur;   }if ($filtre_destinataire    != '' ) { $params['destinataire']   = $filtre_destinataire; }if ($filtre_recherche       != '' ) { $params['recherche']      = $filtre_recherche;    }if ($filtre_type            != '' ) { $params['type']           = $filtre_type;         }if ($filtre_debut           != '' ) { $params['debut']          = $filtre_debut;        }if ($filtre_fin             != '' ) { $params['fin']            = $filtre_fin;          }// Filtres pour pagination et redirections formulaires$filtres = '';$filtres.= $filtre_expediteur > 0 ? '?filtre_expediteur='.$filtre_expediteur : '';$filtres.= isset($_REQUEST['filtre_destinataire'])	? ($filtres != '' ? '&' : '?').'filtre_destinataire='.$filtre_destinataire  : '';$filtres.= isset($_REQUEST['filtre_recherche'])		? ($filtres != '' ? '&' : '?').'filtre_recherche='  .$filtre_recherche      : '';$filtres.= isset($_REQUEST['filtre_type'])		    ? ($filtres != '' ? '&' : '?').'filtre_type='       .$filtre_type           : '';$filtres.= isset($_REQUEST['filtre_debut'])		    ? ($filtres != '' ? '&' : '?').'filtre_debut='      .$filtre_debut          : '';$filtres.= isset($_REQUEST['filtre_fin'])		    ? ($filtres != '' ? '&' : '?').'filtre_fin='        .$filtre_fin            : '';$filtresPagination = $filtres;$pagination->setUrl($filtresPagination);$listeMails = $logsMailsManager->getLogsMail($params);$pagination->setNb_results(!empty($listeMails) ? $logsMailsManager->getNb_results() : 0);?><div class="container-fluid">    <div class="row">        <div class="col" id="listeLogs">            <form action="<?php echo $_SERVER['PHP_SELF']; ?>" method="post">                <div class="row">                    <input type="hidden" name="page" value="1" />                    <div class="col mb-2">                        <div class="input-group mb-3">                            <select class="selectpicker show-tick form-control" title="Type" name="filtre_type">                                <option value="0" title="Type">Tous</option>                                <option data-divider="true"></option>								<?php								$types = [									1 => 'Support Technique',									2 => 'Alerte atelier'								];								foreach ($types as $code => $type) { ?>                                    <option value="<?php echo $code; ?>" <?php echo $filtre_type == $code ? 'selected' : ''; ?>><?php echo $type; ?></option>								<?php } ?>                            </select>                        </div>                    </div>                    <div class="col mb-2">                        <div class="input-group mb-3">                            <div class="input-group-prepend">                                <span class="input-group-text"><i class="fa fa-user gris-9"></i></span>                            </div>                            <input type="text" name="filtre_expediteur" class="form-control" placeholder="Expéditeur" value="<?php echo $filtre_expediteur; ?>"/>                        </div>                    </div>                    <div class="col mb-2">                        <div class="input-group mb-3">                            <div class="input-group-prepend">                                <span class="input-group-text"><i class="fa fa-search gris-9"></i></span>                            </div>                            <input type="text" name="filtre_destinataire" class="form-control" placeholder="Destinataire" value="<?php echo $filtre_destinataire; ?>"/>                        </div>                    </div>                    <div class="col mb-2">                        <div class="input-group mb-3">                            <div class="input-group-prepend">                                <span class="input-group-text"><i class="fa fa-search gris-9"></i></span>                            </div>                            <input type="text" name="filtre_recherche" class="form-control" placeholder="Sujet / Message" value="<?php echo $filtre_recherche; ?>"/>                        </div>                    </div>                    <div class="col mb-2">                        <div class="input-group mb-3">                            <div class="input-group-prepend">                                <span class="input-group-text">Du&hellip;</span>                            </div>                            <input type="text" class=" datepicker form-control" placeholder="Début" name="filtre_debut" value="<?php echo $filtre_debut; ?>">                            <div class="input-group-append">                                <span class="input-group-text" ><i class="fas fa-calendar-alt"></i></span>                            </div>                        </div>                    </div>                    <div class="col mb-2">                        <div class="input-group mb-3">                            <div class="input-group-prepend">                                <span class="input-group-text" >&hellip;au</span>                            </div>                            <input type="text" class=" datepicker form-control" placeholder="Fin" name="filtre_fin" value="<?php echo $filtre_fin; ?>">                            <div class="input-group-append">                                <span class="input-group-text" ><i class="fas fa-calendar-alt"></i></span>                            </div>                        </div>                    </div>                    <div class="col mb-2">                        <button type="submit" class="btn btn-secondary"><i class="fa fa-search mr-1"></i> Rechercher&hellip;</button>                        <a href="<?php echo $_SERVER['PHP_SELF'];?>" class="btn btn-outline-secondary"><i class="fa fa-backspace"></i></a>                    </div>                </div>            </form>            <?php            // Pas de mail            if (empty($listeMails)) { ?>                <div class="alert alert-secondary">                    Aucun e-mail.                </div>            <?php            // Des mails ont été trouvés            } else {				?>                <table class="admin w-100">                    <thead>                    <tr>                        <th class="text-center">ID</th>                        <th>Date/heure</th>                        <th>Type</th>                        <th>Expéditeur</th>                        <th>Destinataires</th>                        <th>Sujet</th>                        <th>Message</th>                    </tr>                    </thead>                    <tbody>					<?php					foreach ($listeMails as $logmail) { ?>                        <tr>                            <td class="text-center"><span class="badge badge-warning badge-pill text-12"><?php echo $logmail->getId(); ?></span>                            </td>                            <td><?php echo ucfirst(Outils::getDate_verbose($logmail->getDate_envoi(), false)); ?></td>                            <td>                                <span class="badge badge-<?php echo $logmail->getType() == 1 ? 'info' : 'warning'; ?> badge-pill text-14"><?php echo $logmail->getType() == 1 ? 'Contact' : 'Alerte'; ?></span>                            </td>                            <td><?php echo $logmail->getExpediteur(); ?></td>                            <td><?php echo $logmail->getDestinataires(); ?></td>                            <td><?php echo $logmail->getSujet(); ?></td>                            <td class="contenuMailLog"><?php echo str_replace('<br><br>', '', strip_tags($logmail->getMessage(), '<br><p>')); ?></td>                        </tr>					<?php } ?>                    </tbody>                </table>				<?php				if (isset($pagination)) {					// Pagination bas de page, verbose...					$pagination->setVerbose_pagination(1);					$pagination->setVerbose_position('right');					$pagination->setNature_resultats('mail');					echo $pagination->getPaginationHtml();				}			} // FIN test résultats            ?>        </div>    </div></div><?phpinclude('includes/footer.php');