<?php/**------------------------------------------------------------------------PAGE - ADMIN - BlocagesCopyright (C) 2018 Intersedhttp://www.intersed.fr/------------------------------------------------------------------------@author    Cédric Bouillon@copyright Copyright (c) 2018 Intersed@version   1.0@since     2018------------------------------------------------------------------------ */require_once 'scripts/php/config.php';header('Location: ' . __CBO_ROOT_URL__);exit;   // Déprécié v1.2.1 - Redirectionrequire_once 'scripts/php/check_admin.php';$h1     = 'Blocages en cours';$h1fa   = 'fa-fw fa-pause';// HEADERinclude('includes/header.php');$froidManager = new FroidManager($cnx);// Si on tente de débloquer une op :$id_froid = isset($_REQUEST['f']) ? intval(base64_decode($_REQUEST['f'])) : 0;if ($id_froid > 0) {    $froid = $froidManager->getFroid($id_froid);    if ($froid instanceof Froid) {		$froid->setStatut(0);		$froidManager->saveFroid($froid);    } // FIN test objet froid} // FIN test formulaire posté// On récupère la liste des blocages en cours$params = [    'statuts'       => 1,       // Bloqué    'lots_objets'   => true,    'nb_pdts'       => true];$listeBlocages = $froidManager->getFroidsListe($params);?><div class="container-fluid"><?php if (empty($listeBlocages)) { ?>    <div class="alert alert-secondary text-center gris-7">        <i class="fa fa-info-circle text-50 mt-5 mb-2"></i>        <h3 class="mb-3">Aucun blocage en cours.</h3>        <a href="<?php echo $_SERVER['PHP_SELF']; ?>" class="btn btn-info mb-5"><i class="fa fa-sync mr-1"></i> Vérifier à nouveau&hellip;</a>    </div><?php } else { ?>    <table class="admin w-100">        <thead>        <tr>            <th>Congélation</th>            <th>Lots concernés</th>            <th class="text-center">Entrée tunnel</th>            <th class="text-center">Sortie tunnel</th>            <th class="text-center">Durée de la congélation</th>            <th class="text-center">Temp. début</th>            <th class="text-center">Temp. fin</th>            <th class="text-center">Opérateur</th>            <th class="t-actions">Débloquer</th>        </tr>        </thead>        <tbody>        <?php        foreach ($listeBlocages as $froid) { ?>                <tr>                    <td class="text-20">CGL<?php  echo 'CGL'.sprintf("%04d", $froid->getId()); ?></td>                    <td>                        <?php                        $premier = true;                        foreach ($froid->getLots() as $lotCgl) { ?>                            <span class="badge badge-info d-block text-20 <?php echo !$premier ? 'mt-1' : '';?>"><?php echo $lotCgl->getNumlot(); ?></span>                        <?php                            $premier = false;                        } // FIN boucle sur les lots de la congélation                        ?>                    </td>                    <td class="text-center"><?php echo Outils::getDate_verbose($froid->getDate_entree(), false, '<br>'); ?></td>                    <td class="text-center"><?php echo Outils::getDate_verbose($froid->getDate_sortie(), false, '<br>'); ?></td>                    <td class="text-center"><?php						$dateEntree     = new DateTime($froid->getDate_entree());						$dateNow        = new DateTime($froid->getDate_sortie());						$interval       = $dateEntree->diff($dateNow);						$jours  = (intval($interval->format('%d')));						$heures = (intval($interval->format('%h')));						$min    = (intval($interval->format('%i')));						if ($jours > 0) { $heures = $heures + 24; }						echo  $heures . ' h ' . $min . ' min.'; ?>                        </td>                    <td class="text-20 text-center"><?php echo number_format($froid->getTemp_debut(),3,'.', ''); ?>°C</td>                    <td class="text-20 bg-danger text-white text-center vmiddle"><?php echo number_format($froid->getTemp_fin(),3,'.', ''); ?>°C                        <button type="button" class="btn btn-secondary float-right border-light vmiddle btnUpdTempFin" data-toggle="modal" data-target="#modalUpdTempFin" data-id-froid="<?php echo $froid->getId(); ?>"><i class="fa fa-edit"></i></button>                    </td>                    <td class="text-center"><?php                        $userManager = new UserManager($cnx);                        $userBlocage = $userManager->getUser($froid->getId_user_maj());                        echo $userBlocage instanceof User ? $userBlocage->getNomComplet() : 'N/A';                        ?></td>                    <td class="t-actions">                        <a href="<?php echo $_SERVER['PHP_SELF']; ?>?f=<?php echo base64_encode($froid->getId()); ?>" class="btn btn-success"><i class="fa fa-unlock-alt fa-lg"></i></a>                    </td>                </tr>        <?php        } // FIN boucle sur les CGL en blocage        ?>        </tbody>    </table><?php } ?></div><?phpinclude('includes/footer.php');include('includes/modales/modal_updtempfin.php');