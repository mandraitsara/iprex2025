<?php/**------------------------------------------------------------------------PAGE - ADMIN - Actions correctives points de contrôleCopyright (C) 2020 Intersedhttp://www.intersed.fr/------------------------------------------------------------------------@author    Cédric Bouillon@copyright Copyright (c) 2020 Intersed@version   1.0@since     2018------------------------------------------------------------------------ */require_once 'scripts/php/config.php';// Vérifie une authentification par login/mdp adminrequire_once 'scripts/php/check_admin.php';// On restreint la page aux Administrateursif (!$utilisateur->isAdmin()) {  header('Location: index.php'); }$h1     = "Gestion des actions correctives sur les points de contrôle";$h1fa   = 'fa-fw fa-sign-language';include('includes/header.php');$pvisuActionsManager = new PvisuActionsManager($cnx);$name_new   = isset($_REQUEST['nom_new'])   ? trim($_REQUEST['nom_new'])             : false;$edit_id    = isset($_REQUEST['e'])         ? intval(base64_decode($_REQUEST['e']))  : 0;$id_upd     = isset($_REQUEST['id_edit'])   ? intval($_REQUEST['id_edit'])           : 0;$id_kill    = isset($_REQUEST['kp'])        ? intval(base64_decode($_REQUEST['kp'])) : 0;$logManager = new LogManager($cnx);// SI on a posté le formulaire : création d'un nouveauif ($name_new && $name_new != '') {	$actif = isset($_REQUEST['actif']) ? 1 : 0;	$pVisuAction = new PvisuAction([]);	$pVisuAction->setSupprime(0);	$pVisuAction->setActivation($actif);	$pVisuAction->setNom($name_new);	$id_new = $pvisuActionsManager->savePvisuActions($pVisuAction);	if(intval($id_new) > 0) {	    $log = new Log([]);	    $log->setLog_type('info');	    $log->setLog_texte("Création d'un nouveau libellé d'action corrective pVisuAction ID #".(int)$id_new);	    $logManager->saveLog($log);    }} // FIN test formulaire envoyé// SI on modifieif ($id_upd > 0) {	$pVisuAction = $pvisuActionsManager->getPvisuAction($id_upd);    if ($pVisuAction instanceof PvisuAction) {		$nom = isset($_REQUEST['nom']) ? trim($_REQUEST['nom']) : '';		if ($nom == '') {			$pVisuAction->setSupprime(1);			if ($pvisuActionsManager->savePvisuActions($pVisuAction)) {				$log = new Log([]);				$log->setLog_type('warning');				$log->setLog_texte("Suppression d'un libellé d'action corrective pVisuAction ID #".(int)$id_upd ." (nom mis à vide en upd)");				$logManager->saveLog($log);            }		} else {			$pVisuAction->setNom($nom);			if ($pvisuActionsManager->savePvisuActions($pVisuAction)) {				$log = new Log([]);				$log->setLog_type('info');				$log->setLog_texte("Modification d'un libellé d'action corrective pVisuAction ID #".(int)$id_upd);				$logManager->saveLog($log);            }		} // FIN test nom    } // FIN test instanciation} // FIN test upd// SI on supprimeif ($id_kill && (int)$id_kill > 0) {	$point2kill = $pvisuActionsManager->getPvisuAction($id_kill);	if ($point2kill instanceof PvisuAction) {		$point2kill->setSupprime(1);		$point2kill->setActivation(0);		if ($pvisuActionsManager->savePvisuActions($point2kill)) {			$log = new Log([]);			$log->setLog_type('warning');			$log->setLog_texte("Suppression d'un libellé d'action corrective pVisuAction ID #".(int)$id_kill);			$logManager->saveLog($log);        }	} // FIN test document instancié} // FIN test suppresion d'un doc demandé$liste = $pvisuActionsManager->getListePvisuActions(true);?><div class="container-fluid">    <div class="col-12">    <?php if (empty($liste)) { ?>        <div class="alert alert-danger"><i class="fa fa-exclamation-triangle fa-lg mr-1"></i>Aucune action corrective renseignée !</div>    <?php } else { ?>    <table class="admin w-100">        <thead>            <tr>                <th class="w-mini-admin-cell <?php echo $utilisateur->isDev() ? '' : 'd-none'; ?>">ID</th>                <th>Libellé</th>                <th class="w-court-admin-cell text-center t-actions">Activation</th>                <th class="w-court-admin-cell text-center t-actions">Supprimer</th>            </tr>        </thead>        <tbody>            <?php            foreach ($liste as $pvisuAction) { ?>                <tr>                    <td class="<?php echo $utilisateur->isDev() ? '' : 'd-none'; ?>"><code><?php echo $pvisuAction->getId(); ?></code></td>                    <td>                        <?php                        if ($edit_id == $pvisuAction->getId()) { ?>                            <form action="<?php echo basename($_SERVER['PHP_SELF']); ?>" method="post" class="row">                                <input type="hidden" name="id_edit" value="<?php echo $pvisuAction->getId(); ?>"/>                                <div class="col">                                <input type="text" placeholder="Nouveau libellé" value="<?php echo $pvisuAction->getNom(); ?>" class="form-control w-100" name="nom"/>                                </div>                                <div class="col-1">                                <button type="submit" class="btn btn-success"><i class="fa fa-save"></i></button>                                </div>                            </form>						<?php } else { ?> <?php echo $pvisuAction->getNom(); ?>                            <a href="<?php echo basename($_SERVER['PHP_SELF']).'?e='.base64_encode($pvisuAction->getId());?>" class="btn btn-sm gris-9 mr-1"><i class="fa fa-fw fa-edit"></i></a>						<?php }                        ?>                    </td>                    <td class="text-center t-actions">                        <input type="checkbox" class="togglemaster changeActivation" data-toggle="toggle" data-on="Oui" data-off="Non"                               data-onstyle="success" data-offstyle="danger" data-type-id="<?php echo $pvisuAction->getId(); ?>" <?php                                echo $pvisuAction->getActivation() == 1 ? 'checked' : ''; ?>/>                    </td>                    <td class="text-center t-actions">                        <a href="<?php echo basename($_SERVER['PHP_SELF']);?>?kp=<?php echo base64_encode($pvisuAction->getId())?>" class="btn btn-sm btn-danger mr-1 btnSupprimer"><i class="fa fa-fw fa-lg fa-trash"></i></a>                    </td>                </tr>            <?php            } // FIN boucle            ?>        </tbody>    </table>    <?php } // FIN test    ?>        <form action="<?php echo $_SERVER['PHP_SELF']; ?>" method="post" class="alert alert-secondary mt-4 col-12">            <div class="row">                <div class="col-12 gris-7 padding-left-20 mb-1">                    <i class="fa fa-plus-square mr-1 gris-7"></i>Ajouter une action corrective&hellip;                </div>            </div>            <div class="row">                <div class="form-group col-4 mb-0">                    <div class="input-group">                        <div class="input-group-prepend">                            <span class="input-group-text"><i class="fa fa-tag"></i></span>                        </div>                        <input type="text" placeholder="Libellé" class="form-control" name="nom_new" value="">                    </div>                </div>                 <div class="form-group col-2 mb-0">                    <div class="input-group">                        <input type="checkbox" class="togglemaster" data-toggle="toggle" data-on="Activé" data-off="Désactivé" data-onstyle="success" data-offstyle="danger" name="actif" checked="checked" />                    </div>                </div>                <div class="form-group col mb-0 text-right">                    <button type="submit" class="btn btn-info"><i class="fa fa-check mr-1"></i>Ajouter</button>                </div>            </div>        </form>    </div></div><?phpinclude('includes/footer.php');